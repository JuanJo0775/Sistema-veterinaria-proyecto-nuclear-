{% extends "admin/admin_base.html" %}

{% block title %}Gestión de Inventario{% endblock %}
{% block page_title %}Gestión de Inventario{% endblock %}

{% block custom_styles %}
<style>
    /* =============== SISTEMA DE COLORES UNIFICADO =============== */
    :root {
        --primary: #52B788;
        --primary-dark: #2D6A4F;
        --primary-light: #B7E4C7;
        --accent: #38A3A5;
        --accent-secondary: #22577A;
        --background: #D8F3DC;
        --dark: #081C15;
        --white: #ffffff;
        --gray-light: #f8f9fa;
        --gray-medium: #6c757d;
        --success: var(--primary);
        --warning: var(--accent-secondary);
        --danger: #dc3545;
        --info: var(--accent);
    }

    /* =============== CONTENEDOR PRINCIPAL =============== */
    .inventory-container {
        padding: 30px;
        background: var(--white);
        min-height: calc(100vh - 80px);
    }

    /* =============== HEADER MEJORADO =============== */
    .inventory-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 30px;
        padding: 25px;
        background: linear-gradient(135deg, var(--primary-light) 0%, var(--background) 100%);
        border-radius: 16px;
        border: 2px solid var(--primary-light);
        flex-wrap: wrap;
        gap: 20px;
    }

    .inventory-title-section {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .inventory-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: var(--white);
        box-shadow: 0 8px 25px rgba(82, 183, 136, 0.3);
        flex-shrink: 0;
    }

    .inventory-title {
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--primary-dark);
        margin: 0 0 8px 0;
        line-height: 1.2;
    }

    .inventory-subtitle {
        color: var(--accent);
        font-size: 1rem;
        margin: 0;
        font-weight: 500;
    }

    .inventory-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }

    /* =============== BOTONES UNIFICADOS =============== */
    .btn {
        padding: 12px 20px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        font-size: 0.9rem;
        white-space: nowrap;
        min-height: 44px;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        color: var(--white);
        border: 2px solid transparent;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--accent-secondary) 100%);
    }

    .btn-secondary {
        background: var(--primary-light);
        color: var(--primary-dark);
        border: 2px solid var(--primary-light);
    }

    .btn-secondary:hover {
        background: var(--background);
        border-color: var(--primary);
    }

    .btn-outline {
        background: transparent;
        color: var(--primary);
        border: 2px solid var(--primary);
    }

    .btn-outline:hover {
        background: var(--primary);
        color: var(--white);
    }

    .btn-sm {
        padding: 8px 16px;
        font-size: 0.85rem;
        min-height: 36px;
    }

    .btn-xs {
        padding: 6px 12px;
        font-size: 0.8rem;
        min-height: 32px;
    }

    .btn-info {
        background: var(--accent);
        color: var(--white);
    }

    .btn-info:hover {
        background: var(--accent-secondary);
    }

    .btn-danger {
        background: var(--warning);
        color: var(--white);
    }

    .btn-danger:hover {
        background: var(--dark);
    }

    /* =============== ESTADÍSTICAS MEJORADAS =============== */
    .stats-section {
        margin-bottom: 30px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }

    .stat-card {
        background: var(--white);
        border: 2px solid var(--primary-light);
        border-radius: 16px;
        padding: 25px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(82, 183, 136, 0.1);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 5px;
        height: 100%;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    }

    .stat-card:hover {
        border-color: var(--primary);
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(82, 183, 136, 0.2);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 26px;
        color: var(--white);
        flex-shrink: 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .stat-icon.icon-total {
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    }

    .stat-icon.icon-value {
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
    }

    .stat-icon.icon-low {
        background: linear-gradient(135deg, var(--warning) 0%, var(--primary-dark) 100%);
    }

    .stat-icon.icon-expiring {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--dark) 100%);
    }

    .stat-content {
        flex: 1;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 800;
        color: var(--primary-dark);
        margin-bottom: 6px;
        line-height: 1;
    }

    .stat-label {
        color: var(--accent);
        font-weight: 600;
        font-size: 0.95rem;
    }

    /* =============== TABS MEJORADOS =============== */
    .tabs-section {
        margin-bottom: 30px;
    }

    .inventory-tabs {
        display: flex;
        background: var(--background);
        border-radius: 14px;
        padding: 8px;
        gap: 6px;
        overflow-x: auto;
        border: 2px solid var(--primary-light);
    }

    .tab-item {
        padding: 14px 24px;
        background: transparent;
        border: none;
        border-radius: 10px;
        color: var(--primary-dark);
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.95rem;
        min-height: 50px;
    }

    .tab-item.active {
        background: var(--white);
        color: var(--primary);
        box-shadow: 0 6px 20px rgba(82, 183, 136, 0.25);
        transform: translateY(-1px);
    }

    .tab-item:hover:not(.active) {
        background: rgba(82, 183, 136, 0.15);
        transform: translateY(-1px);
    }

    /* =============== FILTROS MEJORADOS =============== */
    .filter-section {
        background: var(--background);
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 30px;
        border: 2px solid var(--primary-light);
    }

    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .filter-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary-dark);
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0;
    }

    .filter-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 25px;
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .filter-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--primary-dark);
    }

    .search-container {
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 14px 50px 14px 16px;
        border: 2px solid var(--primary-light);
        border-radius: 10px;
        font-size: 0.95rem;
        background: var(--white);
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.1);
    }

    .search-icon {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--primary);
        font-size: 18px;
        pointer-events: none;
    }

    .form-select {
        padding: 14px 16px;
        border: 2px solid var(--primary-light);
        border-radius: 10px;
        font-size: 0.95rem;
        background: var(--white);
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .form-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.1);
    }

    /* =============== VISTA TOGGLE =============== */
    .view-toggle-container {
        display: flex;
        gap: 0;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid var(--primary-light);
    }

    .view-toggle {
        padding: 10px 18px;
        background: var(--white);
        border: none;
        color: var(--primary);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        border-right: 1px solid var(--primary-light);
    }

    .view-toggle:last-child {
        border-right: none;
    }

    .view-toggle.active {
        background: var(--primary);
        color: var(--white);
    }

    .view-toggle:hover:not(.active) {
        background: var(--background);
    }

    /* =============== TABLA MEJORADA =============== */
    .medications-view-container {
        background: var(--white);
        border: 2px solid var(--primary-light);
        border-radius: 16px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 4px 15px rgba(82, 183, 136, 0.1);
    }

    .table-header {
        background: var(--background);
        padding: 25px;
        border-bottom: 2px solid var(--primary-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .table-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary-dark);
        margin: 0;
    }

    .table-container {
        overflow-x: auto;
        position: relative;
    }

    .medications-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1200px;
    }

    .medications-table thead {
        background: var(--primary-light);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .medications-table th {
        padding: 18px 15px;
        text-align: left;
        font-weight: 700;
        font-size: 0.9rem;
        color: var(--primary-dark);
        border: none;
        white-space: nowrap;
    }

    .medications-table td {
        padding: 18px 15px;
        border-bottom: 1px solid var(--background);
        vertical-align: middle;
        font-size: 0.9rem;
    }

    .medications-table tbody tr:hover {
        background: var(--background);
        cursor: pointer;
    }

    /* =============== ELEMENTOS DE MEDICAMENTO =============== */
    .medication-item {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .medication-image {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-weight: 700;
        font-size: 1rem;
        flex-shrink: 0;
        box-shadow: 0 3px 10px rgba(82, 183, 136, 0.3);
    }

    .medication-info {
        flex: 1;
        min-width: 0;
    }

    .medication-name {
        font-weight: 700;
        color: var(--primary-dark);
        margin-bottom: 4px;
        font-size: 0.95rem;
        line-height: 1.3;
    }

    .medication-details {
        color: var(--accent);
        font-size: 0.85rem;
        opacity: 0.9;
    }

    /* =============== BADGES DE ESTADO =============== */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-align: center;
        display: inline-block;
        white-space: nowrap;
    }

    .status-in-stock {
        background: var(--primary-light);
        color: var(--primary-dark);
    }

    .status-low-stock {
        background: var(--warning);
        color: var(--white);
    }

    .status-out-of-stock {
        background: var(--dark);
        color: var(--white);
    }

    /* =============== INDICADOR DE STOCK =============== */
    .stock-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .stock-number {
        font-weight: 700;
        color: var(--primary-dark);
        min-width: 45px;
        font-size: 0.95rem;
    }

    .stock-bar {
        width: 70px;
        height: 8px;
        background: var(--background);
        border-radius: 4px;
        overflow: hidden;
        flex-shrink: 0;
    }

    .stock-fill {
        height: 100%;
        transition: all 0.3s ease;
        border-radius: 4px;
    }

    .stock-high {
        background: var(--primary);
    }

    .stock-medium {
        background: var(--accent);
    }

    .stock-low {
        background: var(--warning);
    }

    .stock-empty {
        background: var(--dark);
    }

    /* =============== BOTONES DE ACCIÓN =============== */
    .action-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .action-btn {
        width: 36px;
        height: 36px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .action-btn.btn-edit {
        background: var(--primary-light);
        color: var(--primary-dark);
    }

    .action-btn.btn-edit:hover {
        background: var(--primary);
        color: var(--white);
    }

    .action-btn.btn-stock {
        background: var(--accent);
        color: var(--white);
    }

    .action-btn.btn-stock:hover {
        background: var(--accent-secondary);
    }

    .action-btn.btn-delete {
        background: var(--warning);
        color: var(--white);
    }

    .action-btn.btn-delete:hover {
        background: var(--dark);
    }

    /* =============== VISTA DE TARJETAS =============== */
    .medications-cards-container {
        display: none;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 25px;
        padding: 25px;
    }

    .medication-card {
        background: var(--white);
        border: 2px solid var(--primary-light);
        border-radius: 16px;
        box-shadow: 0 6px 20px rgba(82, 183, 136, 0.1);
        overflow: hidden;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .medication-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 35px rgba(82, 183, 136, 0.2);
        border-color: var(--primary);
    }

    .medication-card-header {
        padding: 25px;
        background: linear-gradient(135deg, var(--background) 0%, var(--primary-light) 100%);
        display: flex;
        align-items: center;
        gap: 18px;
    }

    .medication-card .medication-image {
        width: 55px;
        height: 55px;
        border-radius: 14px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: var(--white);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1.3rem;
        flex-shrink: 0;
        box-shadow: 0 4px 15px rgba(82, 183, 136, 0.3);
    }

    .medication-card-info {
        flex: 1;
        min-width: 0;
    }

    .medication-card-name {
        font-size: 1.15rem;
        font-weight: 800;
        color: var(--primary-dark);
        margin: 0 0 6px 0;
        line-height: 1.3;
        word-break: break-word;
    }

    .medication-card-category {
        font-size: 0.9rem;
        color: var(--accent);
        margin: 0;
        font-weight: 600;
    }

    .medication-card-body {
        padding: 25px;
    }

    .medication-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .stat-label {
        font-size: 0.8rem;
        color: var(--gray-medium);
        font-weight: 600;
    }

    .stat-value {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--primary-dark);
    }

    .medication-card-footer {
        padding: 20px 25px;
        background: var(--background);
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    /* =============== MODALES MEJORADOS =============== */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(8, 28, 21, 0.8);
        backdrop-filter: blur(6px);
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    .modal-content {
        background: var(--white);
        border-radius: 16px;
        max-width: 700px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideUp 0.3s ease;
        margin: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        border: 2px solid var(--primary-light);
    }

    .modal-header {
        padding: 30px;
        border-bottom: 2px solid var(--background);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: var(--white);
        z-index: 1;
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-dark);
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        color: var(--primary);
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.3s ease;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-close:hover {
        background: var(--background);
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 30px;
    }

    .modal-footer {
        padding: 25px 30px;
        border-top: 2px solid var(--background);
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        position: sticky;
        bottom: 0;
        background: var(--white);
    }

    /* =============== FORMULARIOS MEJORADOS =============== */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .form-label {
        font-weight: 700;
        color: var(--primary-dark);
        font-size: 0.95rem;
    }

    .form-label.required::after {
        content: '*';
        color: var(--danger);
        margin-left: 6px;
    }

    .form-control {
        padding: 14px 16px;
        border: 2px solid var(--primary-light);
        border-radius: 10px;
        font-size: 0.95rem;
        background: var(--white);
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.1);
    }

    .form-textarea {
        padding: 14px 16px;
        border: 2px solid var(--primary-light);
        border-radius: 10px;
        font-size: 0.95rem;
        resize: vertical;
        min-height: 120px;
        font-family: inherit;
        background: var(--white);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .form-textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.1);
    }

    /* =============== ESTADOS DE CARGA =============== */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        border-radius: 16px;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--background);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .loading-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 18px;
    }

    .loading-text {
        color: var(--primary-dark);
        font-weight: 600;
        font-size: 1rem;
    }

    /* =============== ESTADO VACÍO =============== */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--primary);
    }

    .empty-icon {
        font-size: 4.5rem;
        margin-bottom: 25px;
        opacity: 0.7;
    }

    .empty-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-dark);
        margin-bottom: 12px;
    }

    .empty-subtitle {
        color: var(--accent);
        margin-bottom: 30px;
        font-size: 1rem;
    }

    /* =============== CONTENIDO DE TABS =============== */
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    /* =============== ELEMENTOS ESPECÍFICOS ADICIONALES =============== */
    .currency-display {
        font-weight: 700;
        color: var(--primary-dark);
    }

    .expiry-warning {
        color: var(--warning);
        font-size: 0.8rem;
        font-weight: 600;
        margin-top: 4px;
    }

    .expiry-critical {
        color: var(--danger);
        font-weight: 700;
    }

    .movement-entry {
        background: var(--white);
        border: 2px solid var(--primary-light);
        border-radius: 12px;
        padding: 18px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
    }

    .movement-entry:hover {
        border-color: var(--primary);
        box-shadow: 0 4px 15px rgba(82, 183, 136, 0.1);
    }

    .movement-info {
        flex: 1;
    }

    .movement-title {
        font-weight: 700;
        color: var(--primary-dark);
        margin-bottom: 6px;
        font-size: 0.95rem;
    }

    .movement-details {
        font-size: 0.85rem;
        color: var(--accent);
        line-height: 1.4;
    }

    .movement-quantity {
        font-weight: 800;
        font-size: 1.2rem;
        margin-left: 20px;
        padding: 8px 16px;
        border-radius: 8px;
        min-width: 80px;
        text-align: center;
    }

    .movement-in {
        color: var(--primary);
        background: var(--primary-light);
    }

    .movement-out {
        color: var(--warning);
        background: rgba(34, 87, 122, 0.1);
    }

    .movement-adjustment {
        color: var(--accent);
        background: rgba(56, 163, 165, 0.1);
    }

    /* =============== ALERTAS ESPECÍFICAS =============== */
    .alert-section {
        margin-bottom: 25px;
    }

    .alert-card {
        background: var(--white);
        border: 2px solid var(--primary-light);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(82, 183, 136, 0.1);
    }

    .alert-header {
        background: var(--background);
        padding: 20px;
        border-bottom: 2px solid var(--primary-light);
    }

    .alert-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary-dark);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .alert-item {
        padding: 18px 20px;
        border-bottom: 1px solid var(--background);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
    }

    .alert-item:last-child {
        border-bottom: none;
    }

    .alert-item:hover {
        background: var(--background);
    }

    .alert-info {
        flex: 1;
    }

    .alert-medication {
        font-weight: 700;
        color: var(--primary-dark);
        margin-bottom: 4px;
    }

    .alert-description {
        font-size: 0.85rem;
        color: var(--accent);
    }

    .alert-actions {
        display: flex;
        gap: 8px;
    }

    /* =============== REPORTES =============== */
    .report-preview {
        background: var(--white);
        border: 2px solid var(--primary-light);
        border-radius: 12px;
        padding: 25px;
        margin-top: 20px;
        box-shadow: 0 4px 15px rgba(82, 183, 136, 0.1);
    }

    .report-header {
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--background);
    }

    .report-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-dark);
        margin: 0 0 8px 0;
    }

    .report-subtitle {
        color: var(--accent);
        font-size: 0.9rem;
    }

    .report-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .report-stat {
        background: var(--background);
        padding: 18px;
        border-radius: 10px;
        text-align: center;
    }

    .report-stat-number {
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--primary-dark);
        margin-bottom: 6px;
    }

    .report-stat-label {
        color: var(--accent);
        font-size: 0.9rem;
        font-weight: 600;
    }

    .report-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .report-table th {
        background: var(--background);
        padding: 12px 15px;
        text-align: left;
        font-weight: 700;
        color: var(--primary-dark);
        border: 1px solid var(--primary-light);
    }

    .report-table td {
        padding: 12px 15px;
        border: 1px solid var(--background);
        color: var(--primary-dark);
    }

    .report-table tbody tr:hover {
        background: var(--background);
    }

    /* =============== RESPONSIVE MEJORADO =============== */
    @media (max-width: 1200px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .filter-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .medications-cards-container {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .inventory-container {
            padding: 20px;
        }

        .inventory-header {
            flex-direction: column;
            align-items: stretch;
            text-align: center;
            padding: 20px;
        }

        .inventory-title {
            font-size: 1.8rem;
        }

        .inventory-actions {
            justify-content: center;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .filter-section {
            padding: 20px;
        }

        .filter-header {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-actions {
            justify-content: center;
        }

        .table-header {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }

        .modal-content {
            margin: 10px;
            max-height: calc(100vh - 20px);
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .medications-cards-container {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .modal-header,
        .modal-body,
        .modal-footer {
            padding: 20px;
        }
    }

    /* =============== ANIMACIONES =============== */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            transform: translateY(40px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes slideOutRight {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }

    /* =============== FOCUS STYLES =============== */
    .btn:focus,
    .form-control:focus,
    .view-toggle:focus,
    .tab-item:focus {
        outline: 3px solid rgba(82, 183, 136, 0.4);
        outline-offset: 2px;
    }

    /* =============== PRINT STYLES =============== */
    @media print {
        .inventory-header,
        .filter-section,
        .tabs-section,
        .action-buttons {
            display: none !important;
        }

        .medications-view-container {
            box-shadow: none;
            border: 1px solid #000;
        }

        .medications-table {
            font-size: 0.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="inventory-container">
    <!-- Header Section -->
    <div class="inventory-header">
        <div class="inventory-title-section">
            <div class="inventory-icon">📦</div>
            <div>
                <h1 class="inventory-title">Gestión de Inventario</h1>
                <p class="inventory-subtitle">Administra medicamentos y stock de la clínica veterinaria</p>
            </div>
        </div>
        <div class="inventory-actions">
            <button class="btn btn-outline btn-sm" onclick="exportToCSV()">
                📄 Exportar CSV
            </button>
            <button class="btn btn-outline btn-sm" onclick="generateReport()">
                📊 Generar Reporte
            </button>
            <button class="btn btn-primary" onclick="openAddMedicationModal()">
                ➕ Nuevo Medicamento
            </button>
        </div>
    </div>

    <!-- Stats Section -->
    <div class="stats-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon icon-total">📦</div>
                <div class="stat-content">
                    <div class="stat-number" id="totalMedications">-</div>
                    <div class="stat-label">Total Medicamentos</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon-value">💰</div>
                <div class="stat-content">
                    <div class="stat-number" id="totalValue">-</div>
                    <div class="stat-label">Valor Inventario</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon-low">⚠️</div>
                <div class="stat-content">
                    <div class="stat-number" id="lowStockCount">-</div>
                    <div class="stat-label">Stock Bajo</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon-expiring">⏰</div>
                <div class="stat-content">
                    <div class="stat-number" id="expiringCount">-</div>
                    <div class="stat-label">Por Vencer</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Section -->
    <div class="tabs-section">
        <div class="inventory-tabs">
            <button class="tab-item active" data-tab="medications" onclick="switchTab('medications')">
                <span>💊</span>
                Medicamentos
            </button>
            <button class="tab-item" data-tab="movements" onclick="switchTab('movements')">
                <span>📋</span>
                Movimientos
            </button>
            <button class="tab-item" data-tab="alerts" onclick="switchTab('alerts')">
                <span>🚨</span>
                Alertas
            </button>
            <button class="tab-item" data-tab="reports" onclick="switchTab('reports')">
                <span>📊</span>
                Reportes
            </button>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="filter-header">
            <h3 class="filter-title">🔍 Filtros y Controles</h3>
            <div class="filter-actions">
                <div class="view-toggle-container">
                    <button class="view-toggle active" id="listViewBtn" onclick="switchView('table')">
                        📋 Lista
                    </button>
                    <button class="view-toggle" id="cardViewBtn" onclick="switchView('cards')">
                        📊 Cards
                    </button>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="clearFilters()">
                    🧹 Limpiar Filtros
                </button>
            </div>
        </div>

        <div class="filter-grid">
            <div class="filter-group">
                <label class="filter-label">Buscar Medicamento</label>
                <div class="search-container">
                    <input type="text" class="search-input" id="searchMedications"
                           placeholder="Nombre, categoría, laboratorio...">
                    <span class="search-icon">🔍</span>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">Categoría</label>
                <select class="form-select" id="filterCategory">
                    <option value="">Todas las categorías</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Estado</label>
                <select class="form-select" id="filterStock">
                    <option value="">Todos los estados</option>
                    <option value="in_stock">En Stock</option>
                    <option value="low_stock">Stock Bajo</option>
                    <option value="out_of_stock">Sin Stock</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Medications Tab Content -->
    <div class="tab-content active" id="medications-tab">
        <div class="medications-view-container">
            <div class="table-header">
                <h3 class="table-title" id="tableTitle">📋 Lista de Medicamentos</h3>
            </div>

            <!-- Loading Overlay -->
            <div class="loading-overlay" id="medicationsLoading" style="display: none;">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Cargando medicamentos...</div>
                </div>
            </div>

            <!-- Table View -->
            <div class="table-container" id="tableView">
                <table class="medications-table" id="medicationsTable">
                    <thead>
                        <tr>
                            <th>Medicamento</th>
                            <th>Categoría</th>
                            <th>Stock</th>
                            <th>Estado</th>
                            <th>Precio</th>
                            <th>Total</th>
                            <th>Vencimiento</th>
                            <th>Laboratorio</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="medicationsTableBody">
                        <tr>
                            <td colspan="9">
                                <div class="empty-state">
                                    <div class="empty-icon">📦</div>
                                    <div class="empty-title">Cargando medicamentos...</div>
                                    <div class="empty-subtitle">Por favor espera un momento</div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Cards View -->
            <div class="medications-cards-container" id="cardsView">
                <!-- Cards will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Movements Tab -->
    <div class="tab-content" id="movements-tab">
        <div class="medications-view-container">
            <div class="table-header">
                <h3 class="table-title">📋 Movimientos de Stock</h3>
                <button class="btn btn-primary btn-sm" onclick="loadMovements()">
                    🔍 Cargar Movimientos
                </button>
            </div>

            <div style="padding: 25px;">
                <div class="filter-grid" style="margin-bottom: 25px;">
                    <div class="filter-group">
                        <label class="filter-label">Medicamento</label>
                        <select class="form-select" id="filterMedicationMovements">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Tipo</label>
                        <select class="form-select" id="filterMovementType">
                            <option value="">Todos</option>
                            <option value="in">Entrada</option>
                            <option value="out">Salida</option>
                            <option value="adjustment">Ajuste</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Período</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="date" class="form-select" id="filterDateFrom">
                            <input type="date" class="form-select" id="filterDateTo">
                        </div>
                    </div>
                </div>

                <div id="movementsContainer">
                    <div class="empty-state">
                        <div class="empty-icon">📋</div>
                        <div class="empty-title">Selecciona filtros y presiona "Cargar Movimientos"</div>
                        <div class="empty-subtitle">Para ver el historial de movimientos de stock</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Tab -->
    <div class="tab-content" id="alerts-tab">
        <div class="medications-view-container">
            <div class="table-header">
                <h3 class="table-title">🚨 Alertas de Inventario</h3>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary btn-sm" onclick="refreshAlerts()">
                        🔄 Actualizar
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="sendAlertNotifications()">
                        📧 Notificar
                    </button>
                </div>
            </div>

            <div style="padding: 25px;" id="alertsContainer">
                <div class="empty-state">
                    <div class="empty-icon">🚨</div>
                    <div class="empty-title">Cargando alertas...</div>
                    <div class="empty-subtitle">Verificando estado del inventario</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-content" id="reports-tab">
        <div class="medications-view-container">
            <div class="table-header">
                <h3 class="table-title">📊 Generador de Reportes</h3>
            </div>

            <div style="padding: 25px;">
                <div class="filter-grid" style="margin-bottom: 25px;">
                    <div class="filter-group">
                        <label class="filter-label">Tipo de Reporte</label>
                        <select class="form-select" id="reportType">
                            <option value="general">Reporte General</option>
                            <option value="movements">Movimientos por Período</option>
                            <option value="expiration">Medicamentos por Vencer</option>
                            <option value="low_stock">Stock Bajo</option>
                            <option value="financial">Valorización de Inventario</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Período</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <input type="date" class="form-select" id="reportDateFrom">
                            <input type="date" class="form-select" id="reportDateTo">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Formato</label>
                        <select class="form-select" id="reportFormat">
                            <option value="pdf">PDF</option>
                            <option value="csv">CSV</option>
                            <option value="excel">Excel</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 25px;">
                    <button class="btn btn-primary" onclick="generateSelectedReport()">
                        📊 Generar Reporte
                    </button>
                </div>

                <div id="reportPreview">
                    <!-- Report preview will be shown here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Medication Modal -->
<div class="modal" id="medicationModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="medicationModalTitle">Agregar Medicamento</h3>
            <button class="modal-close" onclick="closeMedicationModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="medicationForm">
                <input type="hidden" id="medicationId">

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label required">Nombre del Medicamento</label>
                        <input type="text" class="form-control" id="medicationName" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Categoría</label>
                        <select class="form-control" id="medicationCategory">
                            <option value="">Seleccionar categoría</option>
                            <option value="Antibiótico">Antibiótico</option>
                            <option value="Analgésico">Analgésico</option>
                            <option value="Antiinflamatorio">Antiinflamatorio</option>
                            <option value="Antiparasitario">Antiparasitario</option>
                            <option value="Vitaminas">Vitaminas</option>
                            <option value="Vacunas">Vacunas</option>
                            <option value="Sedante">Sedante</option>
                            <option value="Antiséptico">Antiséptico</option>
                            <option value="Suplemento">Suplemento</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Presentación</label>
                        <select class="form-control" id="medicationPresentation">
                            <option value="">Seleccionar presentación</option>
                            <option value="Comprimidos">Comprimidos</option>
                            <option value="Cápsulas">Cápsulas</option>
                            <option value="Jarabe">Jarabe</option>
                            <option value="Inyectable">Inyectable</option>
                            <option value="Pomada">Pomada</option>
                            <option value="Gotas">Gotas</option>
                            <option value="Spray">Spray</option>
                            <option value="Polvo">Polvo</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Concentración</label>
                        <input type="text" class="form-control" id="medicationConcentration"
                               placeholder="ej: 500mg, 250mg/5ml">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Laboratorio</label>
                        <input type="text" class="form-control" id="medicationLaboratory">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Proveedor</label>
                        <input type="text" class="form-control" id="medicationSupplier">
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Precio Unitario</label>
                        <input type="number" class="form-control" id="medicationPrice"
                               step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Stock Inicial</label>
                        <input type="number" class="form-control" id="medicationStock"
                               min="0" value="0">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Stock Mínimo</label>
                        <input type="number" class="form-control" id="medicationMinStock"
                               min="0" value="10">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Fecha de Vencimiento</label>
                        <input type="date" class="form-control" id="medicationExpiry">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Número de Lote</label>
                        <input type="text" class="form-control" id="medicationBatch">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Descripción</label>
                    <textarea class="form-textarea" id="medicationDescription"
                              placeholder="Descripción del medicamento, indicaciones, contraindicaciones..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Condiciones de Almacenamiento</label>
                    <textarea class="form-textarea" id="medicationStorage"
                              placeholder="ej: Conservar en lugar fresco y seco, temperatura ambiente..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeMedicationModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveMedication()">
                <span id="saveButtonText">Guardar</span>
            </button>
        </div>
    </div>
</div>

<!-- Stock Update Modal -->
<div class="modal" id="stockModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Actualizar Stock</h3>
            <button class="modal-close" onclick="closeStockModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="background: var(--background); padding: 18px; border-radius: 12px; margin-bottom: 25px;">
                <div style="font-weight: 700; color: var(--primary-dark); margin-bottom: 6px;" id="stockMedicationName">Medicamento</div>
                <div style="color: var(--accent); font-size: 0.95rem;">Stock actual: <span id="currentStock">0</span> unidades</div>
            </div>

            <form id="stockForm">
                <input type="hidden" id="stockMedicationId">

                <div class="form-group">
                    <label class="form-label required">Tipo de Movimiento</label>
                    <select class="form-control" id="movementType" onchange="updateMovementFields()" required>
                        <option value="">Seleccionar tipo</option>
                        <option value="in">Entrada (Agregar Stock)</option>
                        <option value="out">Salida (Reducir Stock)</option>
                        <option value="adjustment">Ajuste de Inventario</option>
                    </select>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label required">Cantidad</label>
                        <input type="number" class="form-control" id="movementQuantity" min="1" required onchange="calculateResultingStock()">
                    </div>

                    <div class="form-group" id="unitCostGroup" style="display: none;">
                        <label class="form-label">Costo Unitario</label>
                        <input type="number" class="form-control" id="movementUnitCost" step="0.01" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label required">Motivo/Razón</label>
                    <select class="form-control" id="movementReason" required>
                        <option value="">Seleccionar motivo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Referencia</label>
                    <input type="text" class="form-control" id="movementReference"
                           placeholder="Número de factura, prescripción, etc.">
                </div>

                <div style="background: var(--primary-light); padding: 15px; border-radius: 10px; color: var(--primary-dark); display: none;" id="stockWarning">
                    Stock resultante: <strong id="resultingStock">0</strong> unidades
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeStockModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveStockMovement()">
                💾 Actualizar Stock
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// =============== VARIABLES GLOBALES ===============
let medications = [];
let currentMedicationId = null;
let isEditMode = false;
let currentView = 'table'; // 'table' o 'cards'

// =============== INICIALIZACIÓN ===============
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Inicializando Gestión de Inventario...');

    setupEventListeners();
    loadInitialData();
});

function setupEventListeners() {
    console.log('🔧 Configurando event listeners...');

    // Búsqueda
    const searchInput = document.getElementById('searchMedications');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(filterMedications, 300));
    }

    // Filtros
    ['filterCategory', 'filterStock'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', filterMedications);
        }
    });

    // Cerrar modales al hacer clic fuera
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            closeAllModals();
        }
    });

    // Atajos de teclado
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeAllModals();
        }
        if (event.ctrlKey && event.key === 'n') {
            event.preventDefault();
            openAddMedicationModal();
        }
    });
}

async function loadInitialData() {
    try {
        console.log('🔄 Cargando datos iniciales...');

        await Promise.all([
            loadMedications(),
            loadCategories()
        ]);

        console.log('✅ Datos iniciales cargados');
    } catch (error) {
        console.error('❌ Error cargando datos:', error);
        showMessage('Error cargando datos del inventario', 'error');
    }
}

// =============== CARGA DE DATOS ===============
async function loadMedications() {
    try {
        console.log('📦 Cargando medicamentos...');
        showLoading(true);

        const response = await fetch('/api/admin/inventory/medications');
        const data = await response.json();

        if (data.success) {
            medications = data.medications || [];
            console.log(`✅ ${medications.length} medicamentos cargados`);

            if (data.message && data.message.includes('ejemplo')) {
                showMessage('⚠️ Mostrando datos de ejemplo - Servicio no disponible', 'warning');
            }

            renderMedications();
            updateStats();
        } else {
            throw new Error(data.message || 'Error cargando medicamentos');
        }
    } catch (error) {
        console.error('❌ Error:', error);
        showMessage('Error cargando medicamentos: ' + error.message, 'error');
        renderEmptyState();
    } finally {
        showLoading(false);
    }
}

async function loadCategories() {
    try {
        const response = await fetch('/api/admin/inventory/categories');
        const data = await response.json();

        if (data.success) {
            populateCategoryFilter(data.categories || []);
        }
    } catch (error) {
        console.error('❌ Error cargando categorías:', error);
        populateCategoryFilter([
            'Antibiótico', 'Analgésico', 'Antiinflamatorio',
            'Antiparasitario', 'Vitaminas', 'Vacunas'
        ]);
    }
}

function populateCategoryFilter(categories) {
    const filterSelect = document.getElementById('filterCategory');
    if (!filterSelect) return;

    filterSelect.innerHTML = '<option value="">Todas las categorías</option>';

    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        filterSelect.appendChild(option);
    });
}

// =============== RENDERIZADO ===============
function renderMedications() {
    console.log(`📋 Renderizando medicamentos en vista: ${currentView}`);

    if (currentView === 'cards') {
        renderMedicationsCards();
    } else {
        renderMedicationsTable();
    }

    updateTableTitle();
}

function renderMedicationsTable() {
    console.log('📋 Renderizando vista de tabla...');

    const tbody = document.getElementById('medicationsTableBody');
    const tableView = document.getElementById('tableView');
    const cardsView = document.getElementById('cardsView');

    // Mostrar tabla y ocultar tarjetas
    if (tableView) tableView.style.display = 'block';
    if (cardsView) cardsView.style.display = 'none';

    if (!tbody) return;

    if (!medications || medications.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9">
                    <div class="empty-state">
                        <div class="empty-icon">📦</div>
                        <div class="empty-title">No hay medicamentos registrados</div>
                        <div class="empty-subtitle">Comienza agregando tu primer medicamento</div>
                        <button class="btn btn-primary" onclick="openAddMedicationModal()">
                            ➕ Agregar Primer Medicamento
                        </button>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = medications.map(med => `
        <tr onclick="showMedicationDetails('${med.id}')" style="cursor: pointer;">
            <td>
                <div class="medication-item">
                    <div class="medication-image">
                        ${med.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="medication-info">
                        <div class="medication-name">${med.name}</div>
                        <div class="medication-details">
                            ${med.presentation || ''} ${med.concentration || ''}
                        </div>
                    </div>
                </div>
            </td>
            <td>
                <span class="status-badge" style="background: var(--background); color: var(--primary-dark);">
                    ${med.category || 'Sin categoría'}
                </span>
            </td>
            <td>
                <div class="stock-indicator">
                    <span class="stock-number">${med.stock_quantity || 0}</span>
                    <div class="stock-bar">
                        <div class="stock-fill ${getStockLevel(med)}"
                             style="width: ${getStockPercentage(med)}%"></div>
                    </div>
                </div>
            </td>
            <td>
                <span class="status-badge ${getStockStatusClass(med)}">
                    ${getStockStatusText(med)}
                </span>
            </td>
            <td class="currency-display">${formatCurrency(med.unit_price || 0)}</td>
            <td class="currency-display">${formatCurrency((med.unit_price || 0) * (med.stock_quantity || 0))}</td>
            <td>
                ${med.expiration_date ? formatDate(med.expiration_date) : 'N/A'}
                ${getExpiryWarning(med)}
            </td>
            <td>${med.laboratory || 'N/A'}</td>
            <td onclick="event.stopPropagation();">
                <div class="action-buttons">
                    <button class="action-btn btn-stock" onclick="updateStock('${med.id}')" title="Stock">
                        📦
                    </button>
                    <button class="action-btn btn-edit" onclick="editMedication('${med.id}')" title="Editar">
                        ✏️
                    </button>
                    <button class="action-btn btn-delete" onclick="deleteMedication('${med.id}')" title="Eliminar">
                        🗑️
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function renderMedicationsCards() {
    console.log('🎴 Renderizando vista de tarjetas...');

    const cardsView = document.getElementById('cardsView');
    const tableView = document.getElementById('tableView');

    // Mostrar tarjetas y ocultar tabla
    if (tableView) tableView.style.display = 'none';
    if (cardsView) cardsView.style.display = 'grid';

    if (!cardsView) return;

    if (!medications || medications.length === 0) {
        cardsView.innerHTML = `
            <div style="grid-column: 1 / -1;">
                <div class="empty-state">
                    <div class="empty-icon">📦</div>
                    <div class="empty-title">No hay medicamentos registrados</div>
                    <div class="empty-subtitle">Comienza agregando tu primer medicamento</div>
                    <button class="btn btn-primary" onclick="openAddMedicationModal()">
                        ➕ Agregar Primer Medicamento
                    </button>
                </div>
            </div>
        `;
        return;
    }

    cardsView.innerHTML = medications.map(med => `
        <div class="medication-card" onclick="showMedicationDetails('${med.id}')">
            <div class="medication-card-header">
                <div class="medication-image">
                    ${med.name.charAt(0).toUpperCase()}
                </div>
                <div class="medication-card-info">
                    <h3 class="medication-card-name">${med.name}</h3>
                    <p class="medication-card-category">${med.category || 'Sin categoría'}</p>
                </div>
                <div style="flex-shrink: 0;">
                    <span class="status-badge ${getStockStatusClass(med)}">
                        ${getStockStatusText(med)}
                    </span>
                </div>
            </div>

            <div class="medication-card-body">
                <div class="medication-stats">
                    <div class="stat-item">
                        <span class="stat-label">Stock:</span>
                        <span class="stat-value">${med.stock_quantity || 0} unidades</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Precio:</span>
                        <span class="stat-value">${formatCurrency(med.unit_price || 0)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total:</span>
                        <span class="stat-value">${formatCurrency((med.unit_price || 0) * (med.stock_quantity || 0))}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Vence:</span>
                        <span class="stat-value">${med.expiration_date ? formatDate(med.expiration_date) : 'N/A'}</span>
                    </div>
                </div>

                <div class="stock-indicator" style="margin-bottom: 15px;">
                    <div class="stock-bar" style="width: 100%; height: 8px; margin-bottom: 5px;">
                        <div class="stock-fill ${getStockLevel(med)}"
                             style="width: ${getStockPercentage(med)}%"></div>
                    </div>
                    <small style="color: var(--gray-medium);">${med.minimum_stock_alert || 10} mín.</small>
                </div>

                ${getExpiryWarning(med)}
            </div>

            <div class="medication-card-footer" onclick="event.stopPropagation();">
                <button class="btn btn-info btn-sm" onclick="updateStock('${med.id}')" title="Actualizar Stock">
                    📦 Stock
                </button>
                <button class="btn btn-primary btn-sm" onclick="editMedication('${med.id}')" title="Editar">
                    ✏️ Editar
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteMedication('${med.id}')" title="Eliminar">
                    🗑️
                </button>
            </div>
        </div>
    `).join('');
}

function renderEmptyState() {
    const tbody = document.getElementById('medicationsTableBody');
    if (!tbody) return;

    tbody.innerHTML = `
        <tr>
            <td colspan="9">
                <div class="empty-state">
                    <div class="empty-icon">📦</div>
                    <div class="empty-title">No hay medicamentos registrados</div>
                    <div class="empty-subtitle">Comienza agregando tu primer medicamento</div>
                    <button class="btn btn-primary" onclick="openAddMedicationModal()">
                        ➕ Agregar Medicamento
                    </button>
                </div>
            </td>
        </tr>
    `;

    updateTableTitle();
}

function updateTableTitle() {
    const title = document.getElementById('tableTitle');
    if (title) {
        title.textContent = `📋 Lista de Medicamentos (${medications.length})`;
    }
}

function updateStats() {
    const stats = {
        total_medications: medications.length,
        total_inventory_value: medications.reduce((sum, med) =>
            sum + (med.unit_price || 0) * (med.stock_quantity || 0), 0),
        low_stock_count: medications.filter(med =>
            getStockStatusText(med) === 'Stock Bajo').length,
        expiring_soon_count: medications.filter(med => {
            if (!med.expiration_date) return false;
            const daysToExpiry = Math.ceil(
                (new Date(med.expiration_date) - new Date()) / (1000 * 60 * 60 * 24)
            );
            return daysToExpiry <= 30 && daysToExpiry > 0;
        }).length
    };

    updateStatsDisplay(stats);
}

function updateStatsDisplay(stats) {
    const elements = {
        'totalMedications': stats.total_medications || 0,
        'totalValue': formatCurrency(stats.total_inventory_value || 0),
        'lowStockCount': stats.low_stock_count || 0,
        'expiringCount': stats.expiring_soon_count || 0
    };

    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        }
    });
}

// =============== FUNCIONES AUXILIARES ===============
function getStockLevel(medication) {
    const stock = medication.stock_quantity || 0;
    const minStock = medication.minimum_stock_alert || 10;

    if (stock === 0) return 'stock-empty';
    if (stock <= minStock) return 'stock-low';
    if (stock <= minStock * 2) return 'stock-medium';
    return 'stock-high';
}

function getStockPercentage(medication) {
    const stock = medication.stock_quantity || 0;
    const minStock = medication.minimum_stock_alert || 10;
    const maxStock = minStock * 3;

    return Math.min(100, (stock / maxStock) * 100);
}

function getStockStatusClass(medication) {
    const stock = medication.stock_quantity || 0;
    const minStock = medication.minimum_stock_alert || 10;

    if (stock === 0) return 'status-out-of-stock';
    if (stock <= minStock) return 'status-low-stock';
    return 'status-in-stock';
}

function getStockStatusText(medication) {
    const stock = medication.stock_quantity || 0;
    const minStock = medication.minimum_stock_alert || 10;

    if (stock === 0) return 'Sin Stock';
    if (stock <= minStock) return 'Stock Bajo';
    return 'En Stock';
}

function getExpiryWarning(medication) {
    if (!medication.expiration_date) return '';

    const today = new Date();
    const expiryDate = new Date(medication.expiration_date);
    const daysToExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

    if (daysToExpiry < 0) {
        return '<div class="expiry-warning expiry-critical">⚠️ VENCIDO</div>';
    } else if (daysToExpiry <= 30) {
        return `<div class="expiry-warning">⏰ ${daysToExpiry}d</div>`;
    }

    return '';
}

// =============== GESTIÓN DE VISTAS ===============
function switchView(viewType) {
    console.log(`🔄 Cambiando vista a: ${viewType}`);

    currentView = viewType;

    // Actualizar botones activos
    document.querySelectorAll('.view-toggle').forEach(btn => {
        btn.classList.remove('active');
    });

    if (viewType === 'cards') {
        document.getElementById('cardViewBtn').classList.add('active');
    } else {
        document.getElementById('listViewBtn').classList.add('active');
    }

    // Renderizar según la vista
    renderMedications();
}

// =============== GESTIÓN DE TABS ===============
function switchTab(tabName) {
    console.log('🔄 Cambiando a tab:', tabName);

    // Actualizar tabs activos
    document.querySelectorAll('.tab-item').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

    // Mostrar contenido correspondiente
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${tabName}-tab`).classList.add('active');

    // Cargar datos específicos del tab
    switch (tabName) {
        case 'medications':
            // Ya están cargados
            break;
        case 'movements':
            loadMovementsTab();
            break;
        case 'alerts':
            loadAlertsTab();
            break;
        case 'reports':
            loadReportsTab();
            break;
    }
}

// =============== MODALES ===============
function openAddMedicationModal() {
    isEditMode = false;
    currentMedicationId = null;
    document.getElementById('medicationModalTitle').textContent = 'Agregar Medicamento';
    document.getElementById('saveButtonText').textContent = 'Guardar';
    document.getElementById('medicationForm').reset();
    document.getElementById('medicationModal').classList.add('show');
}

function editMedication(medicationId) {
    const medication = medications.find(m => m.id === medicationId);
    if (!medication) {
        showMessage('Medicamento no encontrado', 'error');
        return;
    }

    isEditMode = true;
    currentMedicationId = medicationId;
    document.getElementById('medicationModalTitle').textContent = 'Editar Medicamento';
    document.getElementById('saveButtonText').textContent = 'Actualizar';

    // Llenar formulario
    const fields = {
        'medicationName': 'name',
        'medicationCategory': 'category',
        'medicationPresentation': 'presentation',
        'medicationConcentration': 'concentration',
        'medicationLaboratory': 'laboratory',
        'medicationSupplier': 'supplier',
        'medicationPrice': 'unit_price',
        'medicationStock': 'stock_quantity',
        'medicationMinStock': 'minimum_stock_alert',
        'medicationExpiry': 'expiration_date',
        'medicationBatch': 'batch_number',
        'medicationDescription': 'description',
        'medicationStorage': 'storage_conditions'
    };

    Object.entries(fields).forEach(([fieldId, medicationField]) => {
        const element = document.getElementById(fieldId);
        if (element) {
            element.value = medication[medicationField] || '';
        }
    });

    document.getElementById('medicationModal').classList.add('show');
}

function closeMedicationModal() {
    document.getElementById('medicationModal').classList.remove('show');
    document.getElementById('medicationForm').reset();
    isEditMode = false;
    currentMedicationId = null;
}

async function saveMedication() {
    try {
        const form = document.getElementById('medicationForm');

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const medicationData = {
            name: document.getElementById('medicationName').value,
            category: document.getElementById('medicationCategory').value,
            presentation: document.getElementById('medicationPresentation').value,
            concentration: document.getElementById('medicationConcentration').value,
            laboratory: document.getElementById('medicationLaboratory').value,
            supplier: document.getElementById('medicationSupplier').value,
            unit_price: parseFloat(document.getElementById('medicationPrice').value),
            stock_quantity: parseInt(document.getElementById('medicationStock').value) || 0,
            minimum_stock_alert: parseInt(document.getElementById('medicationMinStock').value) || 10,
            expiration_date: document.getElementById('medicationExpiry').value,
            batch_number: document.getElementById('medicationBatch').value,
            description: document.getElementById('medicationDescription').value,
            storage_conditions: document.getElementById('medicationStorage').value
        };

        const url = isEditMode && currentMedicationId
            ? `/api/admin/inventory/medications/${currentMedicationId}`
            : '/api/admin/inventory/medications';

        const method = isEditMode ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(medicationData)
        });

        const data = await response.json();

        if (data.success) {
            showMessage(
                isEditMode ? 'Medicamento actualizado exitosamente' : 'Medicamento creado exitosamente',
                'success'
            );
            closeMedicationModal();
            await loadMedications();
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('❌ Error guardando medicamento:', error);
        showMessage('Error guardando medicamento: ' + error.message, 'error');
    }
}

// =============== GESTIÓN DE STOCK ===============
function updateStock(medicationId) {
    const medication = medications.find(m => m.id === medicationId);
    if (!medication) {
        showMessage('Medicamento no encontrado', 'error');
        return;
    }

    currentMedicationId = medicationId;
    document.getElementById('stockMedicationId').value = medicationId;
    document.getElementById('stockMedicationName').textContent = medication.name;
    document.getElementById('currentStock').textContent = medication.stock_quantity || 0;

    document.getElementById('stockForm').reset();
    document.getElementById('stockMedicationId').value = medicationId;
    document.getElementById('unitCostGroup').style.display = 'none';
    document.getElementById('stockWarning').style.display = 'none';

    updateMovementReasons();
    document.getElementById('stockModal').classList.add('show');
}

function updateMovementFields() {
    const movementType = document.getElementById('movementType').value;
    const unitCostGroup = document.getElementById('unitCostGroup');

    unitCostGroup.style.display = movementType === 'in' ? 'block' : 'none';

    updateMovementReasons();
    calculateResultingStock();
}

function updateMovementReasons() {
    const movementType = document.getElementById('movementType').value;
    const reasonSelect = document.getElementById('movementReason');

    reasonSelect.innerHTML = '<option value="">Seleccionar motivo</option>';

    const reasons = {
        'in': ['Compra', 'Donación', 'Devolución', 'Ajuste positivo'],
        'out': ['Prescripción médica', 'Vencimiento', 'Daño/deterioro', 'Uso interno'],
        'adjustment': ['Corrección de inventario', 'Auditoria', 'Error de registro']
    };

    if (reasons[movementType]) {
        reasons[movementType].forEach(reason => {
            const option = document.createElement('option');
            option.value = reason;
            option.textContent = reason;
            reasonSelect.appendChild(option);
        });
    }
}

function calculateResultingStock() {
    const currentStock = parseInt(document.getElementById('currentStock').textContent) || 0;
    const movementType = document.getElementById('movementType').value;
    const quantity = parseInt(document.getElementById('movementQuantity').value) || 0;

    if (!movementType || !quantity) {
        document.getElementById('stockWarning').style.display = 'none';
        return;
    }

    let resultingStock = currentStock;

    if (movementType === 'in') {
        resultingStock += quantity;
    } else if (movementType === 'out') {
        resultingStock -= quantity;
    } else if (movementType === 'adjustment') {
        resultingStock = quantity;
    }

    document.getElementById('resultingStock').textContent = resultingStock;
    document.getElementById('stockWarning').style.display = 'block';
}

function closeStockModal() {
    document.getElementById('stockModal').classList.remove('show');
    document.getElementById('stockForm').reset();
    currentMedicationId = null;
}

async function saveStockMovement() {
    try {
        const form = document.getElementById('stockForm');

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const movementType = document.getElementById('movementType').value;
        const quantity = parseInt(document.getElementById('movementQuantity').value);
        const reason = document.getElementById('movementReason').value;
        const reference = document.getElementById('movementReference').value;
        const unitCost = parseFloat(document.getElementById('movementUnitCost').value) || null;
        const currentStock = parseInt(document.getElementById('currentStock').textContent) || 0;

        // Limpiar reference_id
        let cleanReference = null;
        if (reference && reference.trim() !== '') {
            cleanReference = reference.trim();
        }

        let requestData = {
            medication_id: currentMedicationId,
            movement_type: movementType,
            quantity: quantity,
            reason: reason,
            reference_id: cleanReference
        };

        // Solo agregar unit_cost si tiene valor
        if (unitCost && unitCost > 0) {
            requestData.unit_cost = unitCost;
        }

        // Para ajustes, calcular quantity_change
        if (movementType === 'adjustment') {
            requestData.quantity_change = quantity - currentStock;
        }

        console.log('📦 Datos de movimiento enviados:', requestData);

        const response = await fetch('/api/admin/inventory/stock/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });

        const data = await response.json();

        if (data.success) {
            showMessage('Stock actualizado exitosamente', 'success');
            closeStockModal();
            await loadMedications();
        } else {
            throw new Error(data.message);
        }

    } catch (error) {
        console.error('❌ Error actualizando stock:', error);
        showMessage('Error actualizando stock: ' + error.message, 'error');
    }
}

// =============== OTRAS FUNCIONES ===============
async function deleteMedication(medicationId) {
    const medication = medications.find(m => m.id === medicationId);
    if (!medication) {
        showMessage('Medicamento no encontrado', 'error');
        return;
    }

    if (!confirm(`¿Está seguro que desea eliminar el medicamento "${medication.name}"?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/admin/inventory/medications/${medicationId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            showMessage('Medicamento eliminado exitosamente', 'success');
            await loadMedications();
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('❌ Error eliminando medicamento:', error);
        showMessage('Error eliminando medicamento: ' + error.message, 'error');
    }
}

function filterMedications() {
    const searchTerm = document.getElementById('searchMedications').value.toLowerCase();
    const categoryFilter = document.getElementById('filterCategory').value;
    const stockFilter = document.getElementById('filterStock').value;

    let filteredMedications = medications.filter(medication => {
        const matchesSearch = !searchTerm ||
            medication.name.toLowerCase().includes(searchTerm) ||
            (medication.laboratory && medication.laboratory.toLowerCase().includes(searchTerm)) ||
            (medication.category && medication.category.toLowerCase().includes(searchTerm));

        const matchesCategory = !categoryFilter || medication.category === categoryFilter;

        let matchesStock = true;
        if (stockFilter) {
            const stockStatus = getStockStatusText(medication).toLowerCase().replace(' ', '_');
            matchesStock = stockStatus === stockFilter;
        }

        return matchesSearch && matchesCategory && matchesStock;
    });

    const originalMedications = medications;
    medications = filteredMedications;
    renderMedications();
    medications = originalMedications;
}

function clearFilters() {
    document.getElementById('searchMedications').value = '';
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterStock').value = '';
    renderMedications();
}

function showMedicationDetails(medicationId) {
    console.log('📋 Mostrando detalles del medicamento:', medicationId);
    // Esta función se puede expandir para mostrar un modal con detalles completos
}

async function exportToCSV() {
    try {
        console.log('📄 Exportando a CSV...');

        const link = document.createElement('a');
        link.href = '/api/admin/inventory/export/csv';
        link.target = '_blank';
        link.click();

        showMessage('Descarga de CSV iniciada', 'success');
    } catch (error) {
        console.error('❌ Error exportando CSV:', error);
        showMessage('Error exportando CSV', 'error');
    }
}

async function generateReport() {
    showMessage('Generando reporte...', 'info');
    // Implementar generación de reportes
}

function closeAllModals() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('show');
    });
}

function showLoading(show) {
    const element = document.getElementById('medicationsLoading');
    if (element) {
        element.style.display = show ? 'flex' : 'none';
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// =============== FUNCIONES DE UTILIDAD ===============
function formatCurrency(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) {
        return '$0';
    }

    try {
        return new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0
        }).format(amount);
    } catch (error) {
        return `${amount.toLocaleString() || 0}`;
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Fecha inválida';

        return date.toLocaleDateString('es-CO', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    } catch {
        return 'Fecha inválida';
    }
}

function formatDateTime(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Fecha inválida';
        return date.toLocaleString('es-CO');
    } catch {
        return 'Fecha inválida';
    }
}

// =============== SISTEMA DE MENSAJES ===============
function showMessage(message, type = 'info') {
    console.log(`📢 ${type.toUpperCase()}: ${message}`);

    // Remover mensajes existentes
    const existingMessages = document.querySelectorAll('.dynamic-message');
    existingMessages.forEach(msg => msg.remove());

    // Crear elemento de mensaje
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} dynamic-message`;
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 3000;
        min-width: 300px;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        animation: slideInRight 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px 20px;
        border-radius: 10px;
        font-weight: 600;
        border: 2px solid;
    `;

    // Estilos según el tipo usando las variables del sistema
    const styles = {
        'success': { bg: 'var(--primary-light)', color: 'var(--primary-dark)', border: 'var(--primary)', icon: '✅' },
        'error': { bg: '#ffebee', color: '#c62828', border: '#c62828', icon: '❌' },
        'warning': { bg: '#fff3e0', color: 'var(--warning)', border: 'var(--warning)', icon: '⚠️' },
        'info': { bg: 'var(--background)', color: 'var(--primary-dark)', border: 'var(--primary)', icon: 'ℹ️' }
    };

    const style = styles[type] || styles.info;
    alertDiv.style.background = style.bg;
    alertDiv.style.color = style.color;
    alertDiv.style.borderColor = style.border;

    alertDiv.innerHTML = `
        <span style="font-size: 1.2rem;">${style.icon}</span>
        <span style="flex: 1;">${message}</span>
        <button onclick="this.parentElement.remove()" style="
            background: none;
            border: none;
            color: inherit;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.7;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
    `;

    document.body.appendChild(alertDiv);

    // Auto remover después de 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => alertDiv.remove(), 300);
        }
    }, 5000);
}

// =============== FUNCIONES DE TABS ADICIONALES ===============
async function loadMovementsTab() {
    console.log('📋 Cargando tab de movimientos...');

    // Poblar select de medicamentos
    const medicationSelect = document.getElementById('filterMedicationMovements');
    if (medicationSelect && medications.length > 0) {
        medicationSelect.innerHTML = '<option value="">Todos</option>';
        medications.forEach(med => {
            const option = document.createElement('option');
            option.value = med.id;
            option.textContent = med.name;
            medicationSelect.appendChild(option);
        });
    }

    // Establecer fechas por defecto
    const today = new Date().toISOString().split('T')[0];
    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

    const dateFromEl = document.getElementById('filterDateFrom');
    const dateToEl = document.getElementById('filterDateTo');

    if (dateFromEl && !dateFromEl.value) dateFromEl.value = weekAgo;
    if (dateToEl && !dateToEl.value) dateToEl.value = today;
}

async function loadMovements() {
    try {
        console.log('📋 Cargando movimientos...');

        const medicationId = document.getElementById('filterMedicationMovements')?.value;
        const movementType = document.getElementById('filterMovementType')?.value;
        const dateFrom = document.getElementById('filterDateFrom')?.value;
        const dateTo = document.getElementById('filterDateTo')?.value;

        let url = '/api/admin/inventory/movements?';
        const params = new URLSearchParams();

        if (medicationId) params.append('medication_id', medicationId);
        if (movementType) params.append('movement_type', movementType);
        if (dateFrom) params.append('start_date', dateFrom);
        if (dateTo) params.append('end_date', dateTo);

        url += params.toString();

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
            const movements = data.movements || [];
            renderMovements(movements);
            console.log(`✅ ${movements.length} movimientos cargados`);
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('❌ Error cargando movimientos:', error);
        showMessage('Error cargando movimientos', 'error');
        renderMovements([]);
    }
}

function renderMovements(movementsData = []) {
    const container = document.getElementById('movementsContainer');
    if (!container) return;

    if (movementsData.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">📋</div>
                <div class="empty-title">No hay movimientos que coincidan con los filtros</div>
                <div class="empty-subtitle">Intenta ajustar los criterios de búsqueda</div>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <div style="margin-bottom: 25px;">
            <h4 style="color: var(--primary-dark); margin: 0; font-size: 1.1rem; font-weight: 700;">
                📋 Movimientos de Stock (${movementsData.length})
            </h4>
        </div>
        <div style="max-height: 600px; overflow-y: auto;">
            ${movementsData.map(movement => {
                const medication = medications.find(m => m.id === movement.medication_id);
                return `
                    <div class="movement-entry">
                        <div class="movement-info">
                            <div class="movement-title">
                                ${getMovementTypeText(movement.movement_type)}
                                ${medication ? ` - ${medication.name}` : ''}
                            </div>
                            <div class="movement-details">
                                ${movement.reason} • Cantidad: ${movement.quantity} unidades<br>
                                ${formatDateTime(movement.created_at)}
                                ${movement.reference_id ? ` • Ref: ${movement.reference_id}` : ''}
                            </div>
                        </div>
                        <div class="movement-quantity movement-${movement.movement_type}">
                            ${movement.movement_type === 'out' ? '-' : '+'}${movement.quantity}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function getMovementTypeText(type) {
    const types = {
        'in': '📥 Entrada',
        'out': '📤 Salida',
        'adjustment': '⚖️ Ajuste'
    };
    return types[type] || type;
}

async function loadAlertsTab() {
    try {
        console.log('🚨 Cargando alertas...');

        const [lowStockResponse, expiringResponse] = await Promise.all([
            fetch('/api/admin/inventory/alerts/low-stock'),
            fetch('/api/admin/inventory/alerts/expiring?days=30')
        ]);

        const lowStockData = await lowStockResponse.json();
        const expiringData = await expiringResponse.json();

        renderAlerts(
            lowStockData.success ? lowStockData.low_stock_medications : [],
            expiringData.success ? expiringData.expiring_medications : []
        );
    } catch (error) {
        console.error('❌ Error cargando alertas:', error);
        renderAlerts([], []);
    }
}

function renderAlerts(lowStockMeds, expiringMeds) {
    const container = document.getElementById('alertsContainer');
    if (!container) return;

    const totalAlerts = lowStockMeds.length + expiringMeds.length;

    if (totalAlerts === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">✅</div>
                <div class="empty-title">Sin alertas activas</div>
                <div class="empty-subtitle">Todos los medicamentos están en buenas condiciones</div>
            </div>
        `;
        return;
    }

    let alertsHTML = `
        <div class="report-stats-grid" style="margin-bottom: 30px;">
            <div class="report-stat">
                <div class="report-stat-number" style="color: var(--warning);">${lowStockMeds.length}</div>
                <div class="report-stat-label">⚠️ Stock Bajo</div>
            </div>
            <div class="report-stat">
                <div class="report-stat-number" style="color: var(--warning);">${expiringMeds.length}</div>
                <div class="report-stat-label">⏰ Por Vencer</div>
            </div>
        </div>
    `;

    if (lowStockMeds.length > 0) {
        alertsHTML += `
            <div class="alert-section">
                <div class="alert-card">
                    <div class="alert-header">
                        <h4 class="alert-title">⚠️ Medicamentos con Stock Bajo</h4>
                    </div>
                    ${lowStockMeds.map(med => `
                        <div class="alert-item">
                            <div class="alert-info">
                                <div class="alert-medication">${med.name}</div>
                                <div class="alert-description">
                                    Stock actual: ${med.stock_quantity} • Mínimo: ${med.minimum_stock_alert}
                                </div>
                            </div>
                            <div class="alert-actions">
                                <button class="btn btn-primary btn-xs" onclick="updateStock('${med.id}')">
                                    📦 Reabastecer
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    if (expiringMeds.length > 0) {
        alertsHTML += `
            <div class="alert-section">
                <div class="alert-card">
                    <div class="alert-header">
                        <h4 class="alert-title">⏰ Medicamentos por Vencer</h4>
                    </div>
                    ${expiringMeds.map(med => `
                        <div class="alert-item">
                            <div class="alert-info">
                                <div class="alert-medication">${med.name}</div>
                                <div class="alert-description">
                                    Vence: ${formatDate(med.expiration_date)} • ${med.days_to_expiration || 0} días restantes
                                </div>
                            </div>
                            <div class="alert-actions">
                                <button class="btn btn-secondary btn-xs" onclick="editMedication('${med.id}')">
                                    ✏️ Editar
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    container.innerHTML = alertsHTML;
}

async function refreshAlerts() {
    await loadAlertsTab();
    showMessage('Alertas actualizadas', 'success');
}

async function sendAlertNotifications() {
    try {
        const response = await fetch('/api/admin/inventory/alerts/check-expiration', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ days_threshold: 30 })
        });

        const data = await response.json();

        if (data.success) {
            showMessage('Notificaciones enviadas exitosamente', 'success');
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('❌ Error enviando notificaciones:', error);
        showMessage('Error enviando notificaciones', 'error');
    }
}

function loadReportsTab() {
    console.log('📊 Cargando tab de reportes');

    // Establecer fechas por defecto
    const today = new Date().toISOString().split('T')[0];
    const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

    const dateFromEl = document.getElementById('reportDateFrom');
    const dateToEl = document.getElementById('reportDateTo');

    if (dateFromEl && !dateFromEl.value) dateFromEl.value = monthAgo;
    if (dateToEl && !dateToEl.value) dateToEl.value = today;
}

async function generateSelectedReport() {
    try {
        const reportType = document.getElementById('reportType')?.value || 'general';
        const dateFrom = document.getElementById('reportDateFrom')?.value;
        const dateTo = document.getElementById('reportDateTo')?.value;
        const format = document.getElementById('reportFormat')?.value || 'pdf';

        console.log('📊 Generando reporte:', { reportType, dateFrom, dateTo, format });

        let endpoint = '';
        let params = new URLSearchParams();

        if (dateFrom) params.append('start_date', dateFrom);
        if (dateTo) params.append('end_date', dateTo);

        switch (reportType) {
            case 'movements':
                endpoint = '/api/admin/inventory/movements';
                break;
            case 'low_stock':
                endpoint = '/api/admin/inventory/alerts/low-stock';
                break;
            case 'expiration':
                endpoint = '/api/admin/inventory/alerts/expiring';
                params.append('days', '30');
                break;
            case 'financial':
                endpoint = '/api/admin/inventory/summary';
                break;
            default:
                endpoint = '/api/admin/inventory/summary';
        }

        const url = `${endpoint}${params.toString() ? '?' + params.toString() : ''}`;

        if (format === 'csv') {
            exportToCSV();
        } else {
            const response = await fetch(url);
            const data = await response.json();

            if (data.success) {
                showReportPreview(data, reportType);
                showMessage('Reporte generado exitosamente', 'success');
            } else {
                throw new Error(data.message);
            }
        }
    } catch (error) {
        console.error('❌ Error generando reporte:', error);
        showMessage('Error generando reporte: ' + error.message, 'error');
    }
}

function showReportPreview(data, reportType) {
    const container = document.getElementById('reportPreview');
    if (!container) return;

    let content = '';

    switch (reportType) {
        case 'movements':
            content = generateMovementsReport(data);
            break;
        case 'low_stock':
            content = generateLowStockReport(data);
            break;
        case 'expiration':
            content = generateExpirationReport(data);
            break;
        case 'financial':
            content = generateFinancialReport(data);
            break;
        default:
            content = generateGeneralReport(data);
    }

    container.innerHTML = content;
}

function generateGeneralReport(data) {
    return `
        <div class="report-preview">
            <div class="report-header">
                <h4 class="report-title">📊 Reporte General de Inventario</h4>
                <div class="report-subtitle">Generado el ${formatDateTime(new Date().toISOString())}</div>
            </div>
            <div class="report-stats-grid">
                <div class="report-stat">
                    <div class="report-stat-number">${data.summary?.total_medications || 0}</div>
                    <div class="report-stat-label">Total Medicamentos</div>
                </div>
                <div class="report-stat">
                    <div class="report-stat-number">${formatCurrency(data.summary?.total_inventory_value || 0)}</div>
                    <div class="report-stat-label">Valor Total</div>
                </div>
            </div>
        </div>
    `;
}

function generateMovementsReport(data) {
    const movements = data.movements || [];

    return `
        <div class="report-preview">
            <div class="report-header">
                <h4 class="report-title">📋 Reporte de Movimientos</h4>
                <div class="report-subtitle">Total de movimientos: ${movements.length}</div>
            </div>
            ${movements.length > 0 ? `
                <div style="max-height: 400px; overflow-y: auto;">
                    ${movements.map(movement => `
                        <div class="movement-entry" style="margin-bottom: 10px;">
                            <div class="movement-info">
                                <div class="movement-title">${getMovementTypeText(movement.movement_type)} - ${movement.quantity} unidades</div>
                                <div class="movement-details">${movement.reason} • ${formatDateTime(movement.created_at)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '<div class="empty-state"><div class="empty-title">No hay movimientos en el período seleccionado</div></div>'}
        </div>
    `;
}

function generateLowStockReport(data) {
    const lowStockMeds = data.low_stock_medications || [];

    return `
        <div class="report-preview">
            <div class="report-header">
                <h4 class="report-title">⚠️ Reporte de Stock Bajo</h4>
                <div class="report-subtitle">Medicamentos con stock bajo: ${lowStockMeds.length}</div>
            </div>
            ${lowStockMeds.length > 0 ? `
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Medicamento</th>
                            <th>Stock Actual</th>
                            <th>Stock Mínimo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${lowStockMeds.map(med => `
                            <tr>
                                <td><strong>${med.name}</strong></td>
                                <td style="color: var(--warning); font-weight: 700;">${med.stock_quantity || 0}</td>
                                <td>${med.minimum_stock_alert || 10}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<div class="empty-state"><div class="empty-title">No hay medicamentos con stock bajo</div></div>'}
        </div>
    `;
}

function generateExpirationReport(data) {
    const expiringMeds = data.expiring_medications || [];

    return `
        <div class="report-preview">
            <div class="report-header">
                <h4 class="report-title">⏰ Reporte de Medicamentos por Vencer</h4>
                <div class="report-subtitle">Medicamentos próximos a vencer: ${expiringMeds.length}</div>
            </div>
            ${expiringMeds.length > 0 ? `
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Medicamento</th>
                            <th>Vencimiento</th>
                            <th>Días Restantes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${expiringMeds.map(med => `
                            <tr>
                                <td><strong>${med.name}</strong></td>
                                <td>${formatDate(med.expiration_date)}</td>
                                <td style="color: ${(med.days_to_expiration || 0) <= 7 ? 'var(--danger)' : 'var(--warning)'}; font-weight: 700;">
                                    ${med.days_to_expiration || 0} días
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<div class="empty-state"><div class="empty-title">No hay medicamentos próximos a vencer</div></div>'}
        </div>
    `;
}

function generateFinancialReport(data) {
    const summary = data.summary || {};

    return `
        <div class="report-preview">
            <div class="report-header">
                <h4 class="report-title">💰 Reporte Financiero de Inventario</h4>
                <div class="report-subtitle">Análisis del valor del inventario</div>
            </div>
            <div class="report-stats-grid">
                <div class="report-stat">
                    <div class="report-stat-number">${summary.total_medications || 0}</div>
                    <div class="report-stat-label">Total Medicamentos</div>
                </div>
                <div class="report-stat">
                    <div class="report-stat-number">${formatCurrency(summary.total_inventory_value || 0)}</div>
                    <div class="report-stat-label">Valor Total</div>
                </div>
            </div>
            <div style="background: var(--background); padding: 20px; border-radius: 12px; margin-top: 20px;">
                <h5 style="color: var(--primary-dark); margin-bottom: 15px;">💡 Análisis Financiero</h5>
                <ul style="color: var(--primary-dark); margin: 0; padding-left: 25px; line-height: 1.6;">
                    <li>Capital invertido: <strong>${formatCurrency(summary.total_inventory_value || 0)}</strong></li>
                    <li>Productos con riesgo: <strong>${summary.expiring_soon_count || 0}</strong></li>
                    <li>Requieren reabastecimiento: <strong>${summary.low_stock_count || 0}</strong></li>
                </ul>
            </div>
        </div>
    `;
}

console.log('✅ Sistema de Inventario MEJORADO cargado - Paleta de colores unificada');
</script>
{% endblock %}