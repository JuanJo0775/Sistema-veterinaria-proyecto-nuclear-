{% extends "admin/admin_base.html" %}

{% block title %}Gestión de Inventario{% endblock %}
{% block page_title %}Gestión de Inventario{% endblock %}

{% block custom_styles %}
<style>
    /* =============== INVENTORY SPECIFIC STYLES =============== */
    .inventory-container {
        padding: 25px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(8, 28, 21, 0.08);
        margin: 20px;
    }

    .inventory-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #B7E4C7;
    }

    .inventory-title {
        font-size: 2rem;
        font-weight: 700;
        color: #2D6A4F;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .inventory-actions {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    /* =============== BUTTONS =============== */
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        font-size: 0.9rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #52B788 0%, #2D6A4F 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(82, 183, 136, 0.3);
    }

    .btn-secondary {
        background: #B7E4C7;
        color: #2D6A4F;
        border: 2px solid #52B788;
    }

    .btn-secondary:hover {
        background: #52B788;
        color: white;
    }

    .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }

    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
    }

    .btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        color: #081C15;
    }

    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
    }

    .btn-info {
        background: linear-gradient(135deg, #38A3A5 0%, #22577A 100%);
        color: white;
    }

    .btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(56, 163, 165, 0.3);
    }

    .btn-sm {
        padding: 8px 16px;
        font-size: 0.8rem;
    }

    .btn-xs {
        padding: 4px 8px;
        font-size: 0.75rem;
    }

    /* =============== TABS =============== */
    .inventory-tabs {
        display: flex;
        background: #D8F3DC;
        border-radius: 12px;
        padding: 5px;
        margin-bottom: 25px;
        overflow-x: auto;
    }

    .tab-item {
        padding: 12px 20px;
        background: transparent;
        border: none;
        border-radius: 8px;
        color: #2D6A4F;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .tab-item.active {
        background: white;
        color: #52B788;
        box-shadow: 0 4px 15px rgba(82, 183, 136, 0.2);
    }

    .tab-item:hover:not(.active) {
        background: rgba(82, 183, 136, 0.1);
    }

    /* =============== CONTENT SECTIONS =============== */
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* =============== SEARCH AND FILTERS =============== */
    .inventory-filters {
        background: #D8F3DC;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 25px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #2D6A4F;
    }

    .form-control {
        padding: 10px 15px;
        border: 2px solid #B7E4C7;
        border-radius: 8px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        background: white;
    }

    .form-control:focus {
        outline: none;
        border-color: #52B788;
        box-shadow: 0 0 0 3px rgba(82, 183, 136, 0.1);
    }

    .search-box {
        position: relative;
        flex: 1;
        min-width: 250px;
    }

    .search-input {
        width: 100%;
        padding: 12px 45px 12px 15px;
        border: 2px solid #B7E4C7;
        border-radius: 25px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: #52B788;
        box-shadow: 0 0 0 3px rgba(82, 183, 136, 0.1);
    }

    .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #52B788;
        font-size: 1.1rem;
    }

    /* =============== CARDS AND STATS =============== */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, #D8F3DC 0%, #B7E4C7 100%);
        padding: 25px;
        border-radius: 15px;
        border-left: 5px solid #52B788;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20px;
        width: 100px;
        height: 100px;
        background: rgba(82, 183, 136, 0.1);
        border-radius: 50%;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2D6A4F;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #52B788;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .stat-icon {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 2rem;
        color: rgba(82, 183, 136, 0.3);
    }

    /* =============== TABLE STYLES =============== */
    .inventory-table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(8, 28, 21, 0.08);
    }

    .inventory-table {
        width: 100%;
        border-collapse: collapse;
    }

    .inventory-table thead {
        background: linear-gradient(135deg, #52B788 0%, #2D6A4F 100%);
        color: white;
    }

    .inventory-table th {
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
        border: none;
    }

    .inventory-table td {
        padding: 12px;
        border-bottom: 1px solid #D8F3DC;
        vertical-align: middle;
    }

    .inventory-table tbody tr:hover {
        background: #D8F3DC;
        cursor: pointer;
    }

    /* =============== STATUS BADGES =============== */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-align: center;
        display: inline-block;
        min-width: 80px;
    }

    .status-in-stock {
        background: #B7E4C7;
        color: #2D6A4F;
    }

    .status-low-stock {
        background: #ffeaa7;
        color: #d63031;
    }

    .status-out-of-stock {
        background: #fab1a0;
        color: #d63031;
    }

    .expiry-warning {
        background: #fdcb6e;
        color: #e17055;
    }

    .expiry-danger {
        background: #fd79a8;
        color: #e84393;
    }

    /* =============== MODAL STYLES =============== */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(8, 28, 21, 0.7);
        backdrop-filter: blur(5px);
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: modalFadeIn 0.3s ease;
    }

    @keyframes modalFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background: white;
        border-radius: 15px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
        padding: 25px;
        border-bottom: 2px solid #D8F3DC;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2D6A4F;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #52B788;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: #D8F3DC;
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 25px;
    }

    .modal-footer {
        padding: 20px 25px;
        border-top: 2px solid #D8F3DC;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
    }

    /* =============== FORM STYLES =============== */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-label {
        font-weight: 600;
        color: #2D6A4F;
        font-size: 0.9rem;
    }

    .form-label.required::after {
        content: '*';
        color: #dc3545;
        margin-left: 4px;
    }

    .form-select {
        padding: 10px 15px;
        border: 2px solid #B7E4C7;
        border-radius: 8px;
        font-size: 0.9rem;
        background: white;
        cursor: pointer;
    }

    .form-textarea {
        padding: 10px 15px;
        border: 2px solid #B7E4C7;
        border-radius: 8px;
        font-size: 0.9rem;
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
    }

    /* =============== ALERTS =============== */
    .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 500;
    }

    .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    /* =============== LOADING STATE =============== */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #D8F3DC;
        border-top: 4px solid #52B788;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    /* =============== RESPONSIVE =============== */
    @media (max-width: 768px) {
        .inventory-container {
            margin: 10px;
            padding: 15px;
        }

        .inventory-header {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }

        .inventory-actions {
            flex-wrap: wrap;
            justify-content: center;
        }

        .inventory-filters {
            flex-direction: column;
            align-items: stretch;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .inventory-table-container {
            overflow-x: auto;
        }

        .inventory-table {
            min-width: 800px;
        }
    }

    /* =============== SPECIFIC COMPONENTS =============== */
    .stock-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stock-bar {
        width: 60px;
        height: 6px;
        background: #D8F3DC;
        border-radius: 3px;
        overflow: hidden;
    }

    .stock-fill {
        height: 100%;
        transition: all 0.3s ease;
    }

    .stock-high { background: #52B788; }
    .stock-medium { background: #ffc107; }
    .stock-low { background: #dc3545; }

    .medication-image {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        object-fit: cover;
        background: #D8F3DC;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #52B788;
        font-weight: 600;
    }

    .action-buttons {
        display: flex;
        gap: 5px;
        align-items: center;
    }

    .quick-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    /* =============== MOVEMENT HISTORY =============== */
    .movement-item {
        padding: 15px;
        border: 1px solid #D8F3DC;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .movement-info {
        flex: 1;
    }

    .movement-type {
        font-weight: 600;
        margin-bottom: 5px;
    }

    .movement-in { color: #52B788; }
    .movement-out { color: #dc3545; }
    .movement-adjustment { color: #38A3A5; }

    .movement-details {
        font-size: 0.9rem;
        color: #666;
    }

    .movement-amount {
        font-size: 1.2rem;
        font-weight: 700;
    }

    /* =============== EXPORT BUTTONS =============== */
    .export-buttons {
        display: flex;
        gap: 10px;
        margin-left: auto;
    }

    .export-btn {
        padding: 8px 16px;
        border: 2px solid #52B788;
        background: transparent;
        color: #52B788;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .export-btn:hover {
        background: #52B788;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="inventory-container">
    <!-- Header -->
    <div class="inventory-header">
        <h1 class="inventory-title">
            <span>📦</span>
            Gestión de Inventario
        </h1>
        <div class="inventory-actions">
            <button class="btn btn-primary" onclick="openAddMedicationModal()">
                <span>➕</span>
                Agregar Medicamento
            </button>
            <button class="btn btn-secondary" onclick="generateReport()">
                <span>📊</span>
                Reporte
            </button>
            <button class="btn btn-warning" onclick="testConnection()" style="background: #ff6b6b; color: white;">
                <span>🔧</span>
                Probar Conexión
            </button>
            <div class="export-buttons">
                <button class="export-btn" onclick="exportToCSV()">
                    <span>📄</span> CSV
                </button>
                <button class="export-btn" onclick="exportToPDF()">
                    <span>📋</span> PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="stat-icon">📦</div>
            <div class="stat-number" id="totalMedications">0</div>
            <div class="stat-label">Total Medicamentos</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">💰</div>
            <div class="stat-number" id="totalValue">$0</div>
            <div class="stat-label">Valor Total</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">⚠️</div>
            <div class="stat-number" id="lowStockCount">0</div>
            <div class="stat-label">Stock Bajo</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">⏰</div>
            <div class="stat-number" id="expiringCount">0</div>
            <div class="stat-label">Por Vencer</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="inventory-tabs">
        <button class="tab-item active" data-tab="medications">
            <span>💊</span>
            Medicamentos
        </button>
        <button class="tab-item" data-tab="movements">
            <span>📋</span>
            Movimientos
        </button>
        <button class="tab-item" data-tab="alerts">
            <span>🚨</span>
            Alertas
        </button>
        <button class="tab-item" data-tab="reports">
            <span>📊</span>
            Reportes
        </button>
    </div>

    <!-- Tab Content: Medications -->
    <div class="tab-content active" id="medications-tab">
        <!-- Filters -->
        <div class="inventory-filters">
            <div class="search-box">
                <input type="text" class="search-input" id="searchMedications"
                       placeholder="Buscar medicamentos...">
                <span class="search-icon">🔍</span>
            </div>

            <div class="filter-group">
                <label class="filter-label">Categoría</label>
                <select class="form-control" id="filterCategory">
                    <option value="">Todas las categorías</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Estado Stock</label>
                <select class="form-control" id="filterStock">
                    <option value="">Todos</option>
                    <option value="in_stock">En Stock</option>
                    <option value="low_stock">Stock Bajo</option>
                    <option value="out_of_stock">Sin Stock</option>
                </select>
            </div>

            <button class="btn btn-secondary btn-sm" onclick="clearFilters()">
                <span>🔄</span>
                Limpiar
            </button>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="btn btn-info btn-sm" onclick="bulkUpdateStock()">
                <span>📦</span>
                Actualización Masiva
            </button>
            <button class="btn btn-warning btn-sm" onclick="checkExpirations()">
                <span>⏰</span>
                Verificar Vencimientos
            </button>
            <button class="btn btn-secondary btn-sm" onclick="lowStockReport()">
                <span>⚠️</span>
                Stock Bajo
            </button>
        </div>

        <!-- Medications Table -->
        <div class="inventory-table-container" style="position: relative;">
            <div class="loading-overlay" id="medicationsLoading" style="display: none;">
                <div class="loading-spinner"></div>
            </div>

            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Imagen</th>
                        <th>Nombre</th>
                        <th>Categoría</th>
                        <th>Stock</th>
                        <th>Estado</th>
                        <th>Precio Unit.</th>
                        <th>Valor Total</th>
                        <th>Vencimiento</th>
                        <th>Laboratorio</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="medicationsTableBody">
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #666;">
                            <div>📦</div>
                            <div>Cargando medicamentos...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tab Content: Movements -->
    <div class="tab-content" id="movements-tab">
        <div class="inventory-filters">
            <div class="filter-group">
                <label class="filter-label">Medicamento</label>
                <select class="form-control" id="filterMedicationMovements">
                    <option value="">Todos los medicamentos</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Tipo Movimiento</label>
                <select class="form-control" id="filterMovementType">
                    <option value="">Todos los tipos</option>
                    <option value="in">Entrada</option>
                    <option value="out">Salida</option>
                    <option value="adjustment">Ajuste</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Fecha Desde</label>
                <input type="date" class="form-control" id="filterDateFrom">
            </div>

            <div class="filter-group">
                <label class="filter-label">Fecha Hasta</label>
                <input type="date" class="form-control" id="filterDateTo">
            </div>

            <button class="btn btn-primary btn-sm" onclick="loadMovements()">
                <span>🔍</span>
                Buscar
            </button>
        </div>

        <div id="movementsContainer">
            <div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 3rem;">📋</div>
                <div>Selecciona filtros para ver movimientos</div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Alerts -->
    <div class="tab-content" id="alerts-tab">
        <div class="quick-actions">
            <button class="btn btn-warning btn-sm" onclick="refreshAlerts()">
                <span>🔄</span>
                Actualizar Alertas
            </button>
            <button class="btn btn-info btn-sm" onclick="sendAlertNotifications()">
                <span>📧</span>
                Enviar Notificaciones
            </button>
        </div>

        <div id="alertsContainer">
            <!-- Alerts will be loaded here -->
        </div>
    </div>

    <!-- Tab Content: Reports -->
    <div class="tab-content" id="reports-tab">
        <div class="form-grid">
            <div class="form-group">
                <label class="filter-label">Tipo de Reporte</label>
                <select class="form-control" id="reportType">
                    <option value="general">Reporte General</option>
                    <option value="movements">Movimientos por Período</option>
                    <option value="expiration">Medicamentos por Vencer</option>
                    <option value="low_stock">Stock Bajo</option>
                    <option value="financial">Valorización de Inventario</option>
                </select>
            </div>

            <div class="form-group">
                <label class="filter-label">Fecha Desde</label>
                <input type="date" class="form-control" id="reportDateFrom">
            </div>

            <div class="form-group">
                <label class="filter-label">Fecha Hasta</label>
                <input type="date" class="form-control" id="reportDateTo">
            </div>

            <div class="form-group">
                <label class="filter-label">Formato</label>
                <select class="form-control" id="reportFormat">
                    <option value="pdf">PDF</option>
                    <option value="csv">CSV</option>
                    <option value="excel">Excel</option>
                </select>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="generateSelectedReport()">
                <span>📊</span>
                Generar Reporte
            </button>
        </div>

        <div id="reportPreview" style="margin-top: 30px;">
            <!-- Report preview will be shown here -->
        </div>
    </div>
</div>

<!-- Add/Edit Medication Modal -->
<div class="modal" id="medicationModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="medicationModalTitle">Agregar Medicamento</h3>
            <button class="modal-close" onclick="closeMedicationModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="medicationForm">
                <input type="hidden" id="medicationId">

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label required">Nombre del Medicamento</label>
                        <input type="text" class="form-control" id="medicationName" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Categoría</label>
                        <select class="form-control" id="medicationCategory">
                            <option value="">Seleccionar categoría</option>
                            <option value="Antibiótico">Antibiótico</option>
                            <option value="Analgésico">Analgésico</option>
                            <option value="Antiinflamatorio">Antiinflamatorio</option>
                            <option value="Antiparasitario">Antiparasitario</option>
                            <option value="Vitaminas">Vitaminas</option>
                            <option value="Vacunas">Vacunas</option>
                            <option value="Sedante">Sedante</option>
                            <option value="Antiséptico">Antiséptico</option>
                            <option value="Suplemento">Suplemento</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Presentación</label>
                        <select class="form-control" id="medicationPresentation">
                            <option value="">Seleccionar presentación</option>
                            <option value="Comprimidos">Comprimidos</option>
                            <option value="Cápsulas">Cápsulas</option>
                            <option value="Jarabe">Jarabe</option>
                            <option value="Inyectable">Inyectable</option>
                            <option value="Pomada">Pomada</option>
                            <option value="Gotas">Gotas</option>
                            <option value="Spray">Spray</option>
                            <option value="Polvo">Polvo</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Concentración</label>
                        <input type="text" class="form-control" id="medicationConcentration"
                               placeholder="ej: 500mg, 10ml, 250mg/5ml">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Laboratorio</label>
                        <input type="text" class="form-control" id="medicationLaboratory">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Proveedor</label>
                        <input type="text" class="form-control" id="medicationSupplier">
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Precio Unitario</label>
                        <input type="number" class="form-control" id="medicationPrice"
                               step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Stock Inicial</label>
                        <input type="number" class="form-control" id="medicationStock"
                               min="0" value="0">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Stock Mínimo (Alerta)</label>
                        <input type="number" class="form-control" id="medicationMinStock"
                               min="0" value="10">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Fecha de Vencimiento</label>
                        <input type="date" class="form-control" id="medicationExpiry">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Número de Lote</label>
                        <input type="text" class="form-control" id="medicationBatch">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Descripción</label>
                    <textarea class="form-textarea" id="medicationDescription"
                              placeholder="Descripción del medicamento, indicaciones, contraindicaciones..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Condiciones de Almacenamiento</label>
                    <textarea class="form-textarea" id="medicationStorage"
                              placeholder="ej: Conservar en lugar fresco y seco, temperatura ambiente..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeMedicationModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveMedication()">
                <span id="saveButtonText">Guardar</span>
            </button>
        </div>
    </div>
</div>

<!-- Stock Update Modal -->
<div class="modal" id="stockModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="stockModalTitle">Actualizar Stock</h3>
            <button class="modal-close" onclick="closeStockModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="alert alert-info">
                <span>ℹ️</span>
                <div>
                    <strong id="stockMedicationName"></strong><br>
                    Stock actual: <span id="currentStock">0</span> unidades
                </div>
            </div>

            <form id="stockForm">
                <input type="hidden" id="stockMedicationId">

                <div class="form-group">
                    <label class="form-label required">Tipo de Movimiento</label>
                    <select class="form-control" id="movementType" onchange="updateMovementFields()" required>
                        <option value="">Seleccionar tipo</option>
                        <option value="in">Entrada (Agregar Stock)</option>
                        <option value="out">Salida (Reducir Stock)</option>
                        <option value="adjustment">Ajuste de Inventario</option>
                    </select>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label required">Cantidad</label>
                        <input type="number" class="form-control" id="movementQuantity"
                               min="1" required>
                    </div>

                    <div class="form-group" id="unitCostGroup" style="display: none;">
                        <label class="form-label">Costo Unitario</label>
                        <input type="number" class="form-control" id="movementUnitCost"
                               step="0.01" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label required">Motivo/Razón</label>
                    <select class="form-control" id="movementReason" required>
                        <option value="">Seleccionar motivo</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Referencia</label>
                    <input type="text" class="form-control" id="movementReference"
                           placeholder="Número de factura, prescripción, etc.">
                </div>

                <div class="form-group">
                    <label class="form-label">Observaciones</label>
                    <textarea class="form-textarea" id="movementNotes"
                              placeholder="Observaciones adicionales..."></textarea>
                </div>

                <div class="alert alert-warning" id="stockWarning" style="display: none;">
                    <span>⚠️</span>
                    <span>El stock resultante será: <strong id="resultingStock">0</strong> unidades</span>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeStockModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveStockMovement()">
                <span>💾</span>
                Actualizar Stock
            </button>
        </div>
    </div>
</div>

<!-- Medication Details Modal -->
<div class="modal" id="medicationDetailsModal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title">Detalles del Medicamento</h3>
            <button class="modal-close" onclick="closeMedicationDetailsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="medicationDetailsContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeMedicationDetailsModal()">Cerrar</button>
            <button class="btn btn-primary" onclick="editMedicationFromDetails()">
                <span>✏️</span>
                Editar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// =============== GLOBAL VARIABLES ===============
let medications = [];
let movements = [];
let currentMedicationId = null;
let isEditMode = false;

// =============== API CONFIGURATION ===============
const API_CONFIG = {
    AUTH_SERVICE_URL: 'http://localhost:5001',
    APPOINTMENT_SERVICE_URL: 'http://localhost:5002',
    NOTIFICATION_SERVICE_URL: 'http://localhost:5003',
    MEDICAL_SERVICE_URL: 'http://localhost:5004',
    INVENTORY_SERVICE_URL: 'http://localhost:5005'
};

// =============== API REQUEST FUNCTION ===============
async function makeAPIRequest(url, options = {}) {
    try {
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            }
        };

        const response = await fetch(url, { ...defaultOptions, ...options });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return await response.json();
    } catch (error) {
        console.error('❌ Error en API request:', error);
        throw error;
    }
}

// =============== UTILITY FUNCTIONS (MOVED TO TOP) ===============
function showMessage(message, type = 'info') {
    // Verificar si existe función global sin causar recursión
    if (typeof window.showMessage === 'function' && window.showMessage !== showMessage) {
        return window.showMessage(message, type);
    }

    // Crear nuestro propio sistema de mensajes
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.innerHTML = `
        <span>${getAlertIcon(type)}</span>
        <span>${message}</span>
    `;
    alertDiv.style.cssText = `
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        font-weight: 500;
        animation: slideInRight 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    `;

    // Aplicar estilos según tipo
    switch(type) {
        case 'success':
            alertDiv.style.background = '#B7E4C7';
            alertDiv.style.color = '#2D6A4F';
            alertDiv.style.borderLeft = '4px solid #52B788';
            break;
        case 'error':
            alertDiv.style.background = '#ffebee';
            alertDiv.style.color = '#c62828';
            alertDiv.style.borderLeft = '4px solid #c62828';
            break;
        case 'warning':
            alertDiv.style.background = '#fff3e0';
            alertDiv.style.color = '#f57c00';
            alertDiv.style.borderLeft = '4px solid #ff9800';
            break;
        default:
            alertDiv.style.background = '#e3f2fd';
            alertDiv.style.color = '#1976d2';
            alertDiv.style.borderLeft = '4px solid #2196f3';
    }

    // Buscar o crear contenedor de mensajes
    let messagesContainer = document.querySelector('.flashed-messages');
    if (!messagesContainer) {
        messagesContainer = document.createElement('div');
        messagesContainer.className = 'flashed-messages';
        messagesContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        `;
        document.body.appendChild(messagesContainer);
    }

    messagesContainer.appendChild(alertDiv);

    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function getAlertIcon(type) {
    const icons = {
        'success': '✅',
        'error': '❌',
        'warning': '⚠️',
        'info': 'ℹ️'
    };
    return icons[type] || 'ℹ️';
}

function formatCurrency(amount) {
    // Verificar si existe función global sin causar recursión
    if (typeof window.formatCurrency === 'function' && window.formatCurrency !== formatCurrency) {
        return window.formatCurrency(amount);
    }

    // Crear nuestra propia función
    if (amount === null || amount === undefined || isNaN(amount)) {
        return '$0';
    }

    try {
        return new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0
        }).format(amount);
    } catch (error) {
        return `${amount.toLocaleString() || 0}`;
    }
}

function formatDate(dateString) {
    // Verificar si existe función global sin causar recursión
    if (typeof window.formatDate === 'function' && window.formatDate !== formatDate) {
        return window.formatDate(dateString);
    }

    // Crear nuestra propia función
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Fecha inválida';

        return date.toLocaleDateString('es-CO', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    } catch {
        return 'Fecha inválida';
    }
}

function formatDateTime(dateString) {
    // Verificar si existe función global sin causar recursión
    if (typeof window.formatDateTime === 'function' && window.formatDateTime !== formatDateTime) {
        return window.formatDateTime(dateString);
    }

    // Crear nuestra propia función
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Fecha inválida';

        return date.toLocaleString('es-CO');
    } catch {
        return 'Fecha inválida';
    }
}

function showLoading(elementId, show) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = show ? 'flex' : 'none';
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function closeAllModals() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('show');
    });
}

function updateStats() {
    const stats = {
        total_medications: medications.length,
        total_inventory_value: medications.reduce((sum, med) => sum + (med.unit_price || 0) * (med.stock_quantity || 0), 0),
        low_stock_count: medications.filter(med => getStockStatusText(med) === 'Stock Bajo').length,
        expiring_soon_count: medications.filter(med => {
            if (!med.expiration_date) return false;
            const daysToExpiry = Math.ceil((new Date(med.expiration_date) - new Date()) / (1000 * 60 * 60 * 24));
            return daysToExpiry <= 30 && daysToExpiry > 0;
        }).length
    };

    updateStatsDisplay(stats);
}

// =============== INITIALIZATION ===============
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM LOADED: Inicializando Sistema de Inventario...');
    console.log('🔍 Verificando elementos del DOM...');

    // Verificar que los elementos existen
    const searchInput = document.getElementById('searchMedications');
    const tableBody = document.getElementById('medicationsTableBody');
    const statsGrid = document.getElementById('statsGrid');

    console.log('🔍 searchInput existe:', !!searchInput);
    console.log('🔍 tableBody existe:', !!tableBody);
    console.log('🔍 statsGrid existe:', !!statsGrid);

    if (!searchInput || !tableBody || !statsGrid) {
        console.error('❌ Elementos del DOM faltantes!');
        return;
    }

    console.log('📋 Configurando event listeners...');
    setupEventListeners();

    console.log('📊 Cargando datos iniciales...');
    loadInitialData();

    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

    const dateFromEl = document.getElementById('filterDateFrom');
    const dateToEl = document.getElementById('filterDateTo');
    const reportDateFromEl = document.getElementById('reportDateFrom');
    const reportDateToEl = document.getElementById('reportDateTo');

    if (dateFromEl) dateFromEl.value = weekAgo;
    if (dateToEl) dateToEl.value = today;
    if (reportDateFromEl) reportDateFromEl.value = weekAgo;
    if (reportDateToEl) reportDateToEl.value = today;

    console.log('✅ Inicialización del Sistema de Inventario completada');
});

function setupEventListeners() {
    // Tab switching
    document.querySelectorAll('.tab-item').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    // Search functionality
    document.getElementById('searchMedications').addEventListener('input', debounce(filterMedications, 300));

    // Filter changes
    document.getElementById('filterCategory').addEventListener('change', filterMedications);
    document.getElementById('filterStock').addEventListener('change', filterMedications);

    // Stock calculation
    document.getElementById('movementQuantity').addEventListener('input', calculateResultingStock);

    // Close modals on outside click
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            closeAllModals();
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeAllModals();
        }
        if (event.ctrlKey && event.key === 'n') {
            event.preventDefault();
            openAddMedicationModal();
        }
    });
}

async function loadInitialData() {
    try {
        console.log('🚀 INICIO: loadInitialData() ejecutándose...');
        showLoading('medicationsLoading', true);

        // Load medications and stats in parallel
        console.log('📞 Llamando a loadMedications()...');
        await Promise.all([
            loadMedications(),
            loadInventoryStats(),
            loadCategories()
        ]);

        console.log('✅ Datos iniciales cargados completamente');

    } catch (error) {
        console.error('❌ Error en loadInitialData:', error);
        showMessage('Error cargando datos del inventario', 'error');
    } finally {
        console.log('🔄 Ocultando loading...');
        showLoading('medicationsLoading', false);
    }
}

// =============== DATA LOADING ===============
async function loadMedications() {
    try {
        console.log('🔄 INICIO: Cargando medicamentos desde backend...');
        console.log('🔍 URL que se va a llamar: /api/admin/inventory/medications');

        const response = await fetch('/api/admin/inventory/medications', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        console.log('📡 Respuesta recibida:', response.status);
        console.log('📡 Response object:', response);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('📦 Datos parseados:', data);

        if (data.success) {
            medications = data.medications || [];
            console.log(`✅ ${medications.length} medicamentos cargados desde backend`);
            console.log('📋 Primer medicamento:', medications[0]);

            if (data.message) {
                console.log(`ℹ️ Mensaje del servidor: ${data.message}`);
                showMessage(data.message, 'info');
            }

            renderMedicationsTable();
            updateStats();
        } else {
            console.error('❌ Respuesta no exitosa:', data.message);
            throw new Error(data.message || 'Error desconocido del servidor');
        }

    } catch (error) {
        console.error('❌ Error completo en loadMedications:', error);
        console.error('❌ Stack trace:', error.stack);
        showMessage('Error cargando medicamentos: ' + error.message, 'error');

        // Mostrar estado vacío en lugar de datos de ejemplo
        medications = [];
        renderMedicationsTable();
    }
}

async function loadInventoryStats() {
    try {
        console.log('📡 Cargando estadísticas desde backend...');

        const response = await fetch('/api/admin/inventory/summary', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success && data.summary) {
            updateStatsDisplay(data.summary);
            console.log('✅ Estadísticas cargadas desde backend');
        } else {
            // Calcular estadísticas localmente si el servicio falla
            updateStats();
        }

    } catch (error) {
        console.error('❌ Error cargando estadísticas:', error);
        // Calcular estadísticas localmente
        updateStats();
    }
}

async function loadCategories() {
    try {
        console.log('📡 Cargando categorías desde backend...');

        const response = await fetch('/api/admin/inventory/categories', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            populateCategoryFilter(data.categories || []);
            console.log('✅ Categorías cargadas desde backend');
        } else {
            throw new Error(data.message);
        }

    } catch (error) {
        console.error('❌ Error cargando categorías:', error);
        // Usar categorías por defecto
        const defaultCategories = ['Antibiótico', 'Analgésico', 'Antiinflamatorio', 'Antiparasitario', 'Vitaminas', 'Vacunas'];
        populateCategoryFilter(defaultCategories);
    }
}

// =============== SAVE MEDICATION (UPDATED) ===============
async function saveMedication() {
    try {
        const form = document.getElementById('medicationForm');

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const medicationData = {
            name: document.getElementById('medicationName').value,
            category: document.getElementById('medicationCategory').value,
            presentation: document.getElementById('medicationPresentation').value,
            concentration: document.getElementById('medicationConcentration').value,
            laboratory: document.getElementById('medicationLaboratory').value,
            supplier: document.getElementById('medicationSupplier').value,
            unit_price: parseFloat(document.getElementById('medicationPrice').value),
            stock_quantity: parseInt(document.getElementById('medicationStock').value) || 0,
            minimum_stock_alert: parseInt(document.getElementById('medicationMinStock').value) || 10,
            expiration_date: document.getElementById('medicationExpiry').value,
            batch_number: document.getElementById('medicationBatch').value,
            description: document.getElementById('medicationDescription').value,
            storage_conditions: document.getElementById('medicationStorage').value
        };

        console.log('💾 Guardando medicamento:', medicationData);

        let response;

        if (isEditMode && currentMedicationId) {
            // Update medication
            response = await fetch(`/api/admin/inventory/medications/${currentMedicationId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(medicationData)
            });
        } else {
            // Create new medication
            response = await fetch('/api/admin/inventory/medications', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(medicationData)
            });
        }

        const data = await response.json();

        if (data.success) {
            showMessage(
                isEditMode ? 'Medicamento actualizado exitosamente' : 'Medicamento creado exitosamente',
                'success'
            );
            closeMedicationModal();
            await loadMedications();
        } else {
            throw new Error(data.message);
        }

    } catch (error) {
        console.error('❌ Error guardando medicamento:', error);
        showMessage('Error guardando medicamento: ' + error.message, 'error');
    }
}

// =============== STOCK MANAGEMENT (UPDATED) ===============
async function saveStockMovement() {
    try {
        const form = document.getElementById('stockForm');

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const movementType = document.getElementById('movementType').value;
        const quantity = parseInt(document.getElementById('movementQuantity').value);
        const reason = document.getElementById('movementReason').value;
        const reference = document.getElementById('movementReference').value;
        const unitCost = parseFloat(document.getElementById('movementUnitCost').value) || null;
        const currentStock = parseInt(document.getElementById('currentStock').textContent) || 0;

        let requestData = {
            medication_id: currentMedicationId,
            movement_type: movementType,
            quantity: quantity,
            reason: reason,
            reference_id: reference
        };

        if (unitCost) {
            requestData.unit_cost = unitCost;
        }

        // Para ajustes, calcular el cambio de cantidad
        if (movementType === 'adjustment') {
            requestData.quantity_change = quantity - currentStock;
        }

        console.log('📦 Actualizando stock:', requestData);

        const response = await fetch('/api/admin/inventory/stock/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });

        const data = await response.json();

        if (data.success) {
            showMessage('Stock actualizado exitosamente', 'success');
            closeStockModal();
            await loadMedications();
        } else {
            throw new Error(data.message);
        }

    } catch (error) {
        console.error('❌ Error actualizando stock:', error);
        showMessage('Error actualizando stock: ' + error.message, 'error');
    }
}

// =============== DELETE MEDICATION (UPDATED) ===============
async function deleteMedication(medicationId) {
    const medication = medications.find(m => m.id === medicationId);
    if (!medication) {
        showMessage('Medicamento no encontrado', 'error');
        return;
    }

    if (!confirm(`¿Está seguro que desea eliminar el medicamento "${medication.name}"?\n\nEsta acción no se puede deshacer.`)) {
        return;
    }

    try {
        console.log('🗑️ Eliminando medicamento:', medicationId);

        const response = await fetch(`/api/admin/inventory/medications/${medicationId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            showMessage('Medicamento eliminado exitosamente', 'success');
            await loadMedications();
        } else {
            throw new Error(data.message);
        }

    } catch (error) {
        console.error('❌ Error eliminando medicamento:', error);
        showMessage('Error eliminando medicamento: ' + error.message, 'error');
    }
}

// =============== MOVEMENTS TAB (UPDATED) ===============
async function loadMovements() {
    try {
        const medicationId = document.getElementById('filterMedicationMovements').value;
        const movementType = document.getElementById('filterMovementType').value;
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;

        console.log('📋 Cargando movimientos...');

        let url = '/api/admin/inventory/movements?';
        const params = new URLSearchParams();

        if (medicationId) params.append('medication_id', medicationId);
        if (movementType) params.append('movement_type', movementType);
        if (dateFrom) params.append('start_date', dateFrom);
        if (dateTo) params.append('end_date', dateTo);

        url += params.toString();

        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            movements = data.movements || [];
            renderMovements();
            console.log(`✅ ${movements.length} movimientos cargados`);
        } else {
            throw new Error(data.message);
        }

    } catch (error) {
        console.error('❌ Error cargando movimientos:', error);
        showMessage('Error cargando movimientos', 'error');
        renderMovements([]); // Show empty state
    }
}

// =============== ALERTS TAB (UPDATED) ===============
async function loadAlertsTab() {
    try {
        showLoading('alertsContainer', true);
        console.log('🚨 Cargando alertas...');

        // Load low stock alerts
        const lowStockResponse = await fetch('/api/admin/inventory/alerts/low-stock', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        // Load expiring medications
        const expiringResponse = await fetch('/api/admin/inventory/alerts/expiring?days=30', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const lowStockData = await lowStockResponse.json();
        const expiringData = await expiringResponse.json();

        renderAlerts(
            lowStockData.success ? lowStockData.low_stock_medications : [],
            expiringData.success ? expiringData.expiring_medications : []
        );

        console.log('✅ Alertas cargadas');

    } catch (error) {
        console.error('❌ Error cargando alertas:', error);
        renderAlerts([], []);
    } finally {
        showLoading('alertsContainer', false);
    }
}

async function sendAlertNotifications() {
    try {
        console.log('📧 Enviando notificaciones de alertas...');

        const response = await fetch('/api/admin/inventory/alerts/check-expiration', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ days_threshold: 30 })
        });

        const data = await response.json();

        if (data.success) {
            showMessage('Notificaciones enviadas exitosamente', 'success');
        } else {
            throw new Error(data.message);
        }

    } catch (error) {
        console.error('❌ Error enviando notificaciones:', error);
        showMessage('Error enviando notificaciones', 'error');
    }
}

// =============== SEARCH FUNCTIONALITY (UPDATED) ===============
async function searchMedications(searchTerm) {
    try {
        if (!searchTerm.trim()) {
            await loadMedications();
            return;
        }

        console.log('🔍 Buscando medicamentos:', searchTerm);

        const response = await fetch(`/api/admin/inventory/search?q=${encodeURIComponent(searchTerm)}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            // Temporarily update medications array for rendering
            const originalMedications = medications;
            medications = data.medications || [];
            renderMedicationsTable();
            medications = originalMedications;

            console.log(`✅ ${data.medications?.length || 0} medicamentos encontrados`);
        } else {
            throw new Error(data.message);
        }

    } catch (error) {
        console.error('❌ Error buscando medicamentos:', error);
        showMessage('Error en la búsqueda', 'error');
    }
}

// Update search event listener
function setupEventListeners() {
    // Tab switching
    document.querySelectorAll('.tab-item').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    // Search functionality - UPDATED
    document.getElementById('searchMedications').addEventListener('input', debounce(function(e) {
        const searchTerm = e.target.value;
        if (searchTerm.length >= 2 || searchTerm.length === 0) {
            searchMedications(searchTerm);
        }
    }, 300));

    // Filter changes
    document.getElementById('filterCategory').addEventListener('change', filterMedications);
    document.getElementById('filterStock').addEventListener('change', filterMedications);

    // Stock calculation
    document.getElementById('movementQuantity').addEventListener('input', calculateResultingStock);

    // Close modals on outside click
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            closeAllModals();
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeAllModals();
        }
        if (event.ctrlKey && event.key === 'n') {
            event.preventDefault();
            openAddMedicationModal();
        }
    });
}

// =============== EXPORT FUNCTIONS (UPDATED) ===============
async function exportToCSV() {
    try {
        console.log('📄 Exportando a CSV...');

        // Create a form to trigger download
        const form = document.createElement('form');
        form.method = 'GET';
        form.action = '/api/admin/inventory/export/csv';
        form.target = '_blank';
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);

        showMessage('Descarga de CSV iniciada', 'success');

    } catch (error) {
        console.error('❌ Error exportando CSV:', error);
        showMessage('Error exportando CSV', 'error');
    }
}

// =============== REPORTS (UPDATED) ===============
async function generateSelectedReport() {
    try {
        const reportType = document.getElementById('reportType').value;
        const dateFrom = document.getElementById('reportDateFrom').value;
        const dateTo = document.getElementById('reportDateTo').value;
        const format = document.getElementById('reportFormat').value;

        console.log('📊 Generando reporte:', { reportType, dateFrom, dateTo, format });

        let endpoint = '';
        let params = new URLSearchParams();

        if (dateFrom) params.append('start_date', dateFrom);
        if (dateTo) params.append('end_date', dateTo);

        switch (reportType) {
            case 'movements':
                endpoint = '/api/admin/inventory/movements';
                break;
            case 'low_stock':
                endpoint = '/api/admin/inventory/alerts/low-stock';
                break;
            case 'expiration':
                endpoint = '/api/admin/inventory/alerts/expiring';
                params.append('days', '30');
                break;
            case 'financial':
                endpoint = '/api/admin/inventory/summary';
                break;
            default:
                endpoint = '/api/admin/inventory/summary';
        }

        const url = `${endpoint}${params.toString() ? '?' + params.toString() : ''}`;

        if (format === 'csv') {
            // For CSV, redirect to export endpoint
            exportToCSV();
        } else {
            // For other formats, show preview
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                showReportPreview(data, reportType);
                showMessage('Reporte generado exitosamente', 'success');
            } else {
                throw new Error(data.message);
            }
        }

    } catch (error) {
        console.error('❌ Error generando reporte:', error);
        showMessage('Error generando reporte: ' + error.message, 'error');
    }
}

// =============== REMOVE EXAMPLE DATA FUNCTION ===============
// Remove the getExampleMedications function since we're using real data

// =============== TEST CONNECTION FUNCTION ===============
async function testConnection() {
    try {
        console.log('🔧 TESTING: Probando conexión con backend...');
        showMessage('Probando conexión...', 'info');

        const response = await fetch('/api/admin/inventory/medications', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        console.log('🔧 TEST: Respuesta recibida:', response.status);

        const data = await response.json();
        console.log('🔧 TEST: Datos:', data);

        if (data.success) {
            showMessage(`✅ Conexión exitosa! ${data.medications?.length || 0} medicamentos encontrados`, 'success');
            console.log('🔧 TEST: Conexión exitosa');
        } else {
            showMessage(`❌ Error: ${data.message}`, 'error');
            console.log('🔧 TEST: Error en respuesta:', data.message);
        }

    } catch (error) {
        console.error('🔧 TEST: Error completo:', error);
        showMessage(`❌ Error de conexión: ${error.message}`, 'error');
    }
}

console.log('✅ Sistema de Inventario cargado correctamente - Conectado al Backend');

function populateCategoryFilter(categories) {
    const filterSelect = document.getElementById('filterCategory');
    const medicationSelect = document.getElementById('medicationCategory');

    // Clear existing options except first
    filterSelect.innerHTML = '<option value="">Todas las categorías</option>';

    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        filterSelect.appendChild(option);
    });
}

// =============== RENDERING ===============
function renderMedicationsTable() {
    const tbody = document.getElementById('medicationsTableBody');

    if (medications.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem;">📦</div>
                    <div>No hay medicamentos registrados</div>
                    <button class="btn btn-primary" style="margin-top: 15px;" onclick="openAddMedicationModal()">
                        <span>➕</span> Agregar Primer Medicamento
                    </button>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = medications.map(med => `
        <tr onclick="showMedicationDetails('${med.id}')" style="cursor: pointer;">
            <td>
                <div class="medication-image">
                    ${med.name.charAt(0).toUpperCase()}
                </div>
            </td>
            <td>
                <strong>${med.name}</strong>
                <div style="font-size: 0.8rem; color: #666;">
                    ${med.presentation || ''} ${med.concentration || ''}
                </div>
            </td>
            <td>
                <span class="status-badge" style="background: #D8F3DC; color: #2D6A4F;">
                    ${med.category || 'Sin categoría'}
                </span>
            </td>
            <td>
                <div class="stock-indicator">
                    <strong>${med.stock_quantity || 0}</strong>
                    <div class="stock-bar">
                        <div class="stock-fill ${getStockLevel(med)}"
                             style="width: ${getStockPercentage(med)}%"></div>
                    </div>
                </div>
            </td>
            <td>
                <span class="status-badge ${getStockStatusClass(med)}">
                    ${getStockStatusText(med)}
                </span>
            </td>
            <td>${formatCurrency(med.unit_price || 0)}</td>
            <td>${formatCurrency((med.unit_price || 0) * (med.stock_quantity || 0))}</td>
            <td>
                ${med.expiration_date ? formatDate(med.expiration_date) : 'N/A'}
                ${getExpiryWarning(med)}
            </td>
            <td>${med.laboratory || 'N/A'}</td>
            <td onclick="event.stopPropagation();">
                <div class="action-buttons">
                    <button class="btn btn-info btn-xs" onclick="updateStock('${med.id}')" title="Actualizar Stock">
                        📦
                    </button>
                    <button class="btn btn-primary btn-xs" onclick="editMedication('${med.id}')" title="Editar">
                        ✏️
                    </button>
                    <button class="btn btn-danger btn-xs" onclick="deleteMedication('${med.id}')" title="Eliminar">
                        🗑️
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function updateStatsDisplay(stats) {
    document.getElementById('totalMedications').textContent = stats.total_medications || 0;
    document.getElementById('totalValue').textContent = formatCurrency(stats.total_inventory_value || 0);
    document.getElementById('lowStockCount').textContent = stats.low_stock_count || 0;
    document.getElementById('expiringCount').textContent = stats.expiring_soon_count || 0;
}

// =============== UTILITY FUNCTIONS ===============
function getStockLevel(medication) {
    const stock = medication.stock_quantity || 0;
    const minStock = medication.minimum_stock_alert || 10;

    if (stock === 0) return 'stock-low';
    if (stock <= minStock) return 'stock-medium';
    return 'stock-high';
}

function getStockPercentage(medication) {
    const stock = medication.stock_quantity || 0;
    const minStock = medication.minimum_stock_alert || 10;
    const maxStock = minStock * 3; // Assume 3x min stock is 100%

    return Math.min(100, (stock / maxStock) * 100);
}

function getStockStatusClass(medication) {
    const stock = medication.stock_quantity || 0;
    const minStock = medication.minimum_stock_alert || 10;

    if (stock === 0) return 'status-out-of-stock';
    if (stock <= minStock) return 'status-low-stock';
    return 'status-in-stock';
}

function getStockStatusText(medication) {
    const stock = medication.stock_quantity || 0;
    const minStock = medication.minimum_stock_alert || 10;

    if (stock === 0) return 'Sin Stock';
    if (stock <= minStock) return 'Stock Bajo';
    return 'En Stock';
}

function getExpiryWarning(medication) {
    if (!medication.expiration_date) return '';

    const today = new Date();
    const expiryDate = new Date(medication.expiration_date);
    const daysToExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

    if (daysToExpiry < 0) {
        return '<div style="color: #dc3545; font-size: 0.8rem;">⚠️ VENCIDO</div>';
    } else if (daysToExpiry <= 30) {
        return `<div style="color: #ffc107; font-size: 0.8rem;">⏰ ${daysToExpiry} días</div>`;
    }

    return '';
}

// =============== MODAL FUNCTIONS ===============
function openAddMedicationModal() {
    isEditMode = false;
    currentMedicationId = null;
    document.getElementById('medicationModalTitle').textContent = 'Agregar Medicamento';
    document.getElementById('saveButtonText').textContent = 'Guardar';
    document.getElementById('medicationForm').reset();
    document.getElementById('medicationModal').classList.add('show');
}

function editMedication(medicationId) {
    const medication = medications.find(m => m.id === medicationId);
    if (!medication) {
        showMessage('Medicamento no encontrado', 'error');
        return;
    }

    isEditMode = true;
    currentMedicationId = medicationId;
    document.getElementById('medicationModalTitle').textContent = 'Editar Medicamento';
    document.getElementById('saveButtonText').textContent = 'Actualizar';

    // Populate form
    document.getElementById('medicationId').value = medication.id;
    document.getElementById('medicationName').value = medication.name || '';
    document.getElementById('medicationCategory').value = medication.category || '';
    document.getElementById('medicationPresentation').value = medication.presentation || '';
    document.getElementById('medicationConcentration').value = medication.concentration || '';
    document.getElementById('medicationLaboratory').value = medication.laboratory || '';
    document.getElementById('medicationSupplier').value = medication.supplier || '';
    document.getElementById('medicationPrice').value = medication.unit_price || '';
    document.getElementById('medicationStock').value = medication.stock_quantity || '';
    document.getElementById('medicationMinStock').value = medication.minimum_stock_alert || '';
    document.getElementById('medicationExpiry').value = medication.expiration_date || '';
    document.getElementById('medicationBatch').value = medication.batch_number || '';
    document.getElementById('medicationDescription').value = medication.description || '';
    document.getElementById('medicationStorage').value = medication.storage_conditions || '';

    document.getElementById('medicationModal').classList.add('show');
}

function closeMedicationModal() {
    document.getElementById('medicationModal').classList.remove('show');
    document.getElementById('medicationForm').reset();
    isEditMode = false;
    currentMedicationId = null;
}

async function saveMedication() {
    try {
        const form = document.getElementById('medicationForm');

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const medicationData = {
            name: document.getElementById('medicationName').value,
            category: document.getElementById('medicationCategory').value,
            presentation: document.getElementById('medicationPresentation').value,
            concentration: document.getElementById('medicationConcentration').value,
            laboratory: document.getElementById('medicationLaboratory').value,
            supplier: document.getElementById('medicationSupplier').value,
            unit_price: parseFloat(document.getElementById('medicationPrice').value),
            stock_quantity: parseInt(document.getElementById('medicationStock').value) || 0,
            minimum_stock_alert: parseInt(document.getElementById('medicationMinStock').value) || 10,
            expiration_date: document.getElementById('medicationExpiry').value,
            batch_number: document.getElementById('medicationBatch').value,
            description: document.getElementById('medicationDescription').value,
            storage_conditions: document.getElementById('medicationStorage').value
        };

        let response;

        if (isEditMode && currentMedicationId) {
            // Update medication
            response = await makeAPIRequest(
                `${API_CONFIG.INVENTORY_SERVICE_URL}/inventory/medications/${currentMedicationId}`,
                {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(medicationData)
                }
            );
        } else {
            // Create new medication
            response = await makeAPIRequest(
                `${API_CONFIG.INVENTORY_SERVICE_URL}/inventory/medications`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(medicationData)
                }
            );
        }

        if (response.success) {
            showMessage(
                isEditMode ? 'Medicamento actualizado exitosamente' : 'Medicamento creado exitosamente',
                'success'
            );
            closeMedicationModal();
            await loadMedications();
        } else {
            throw new Error(response.message);
        }

    } catch (error) {
        console.error('❌ Error guardando medicamento:', error);
        showMessage('Error guardando medicamento: ' + error.message, 'error');
    }
}

// =============== STOCK MANAGEMENT ===============
function updateStock(medicationId) {
    const medication = medications.find(m => m.id === medicationId);
    if (!medication) {
        showMessage('Medicamento no encontrado', 'error');
        return;
    }

    currentMedicationId = medicationId;
    document.getElementById('stockMedicationId').value = medicationId;
    document.getElementById('stockMedicationName').textContent = medication.name;
    document.getElementById('currentStock').textContent = medication.stock_quantity || 0;

    // Reset form
    document.getElementById('stockForm').reset();
    document.getElementById('stockMedicationId').value = medicationId;
    document.getElementById('unitCostGroup').style.display = 'none';
    document.getElementById('stockWarning').style.display = 'none';

    // Populate movement reasons
    updateMovementReasons();

    document.getElementById('stockModal').classList.add('show');
}

function updateMovementFields() {
    const movementType = document.getElementById('movementType').value;
    const unitCostGroup = document.getElementById('unitCostGroup');

    // Show unit cost field for incoming stock
    unitCostGroup.style.display = movementType === 'in' ? 'block' : 'none';

    updateMovementReasons();
    calculateResultingStock();
}

function updateMovementReasons() {
    const movementType = document.getElementById('movementType').value;
    const reasonSelect = document.getElementById('movementReason');

    reasonSelect.innerHTML = '<option value="">Seleccionar motivo</option>';

    const reasons = {
        'in': [
            'Compra',
            'Donación',
            'Devolución',
            'Ajuste positivo',
            'Transferencia entrante'
        ],
        'out': [
            'Prescripción médica',
            'Vencimiento',
            'Daño/deterioro',
            'Ajuste negativo',
            'Transferencia saliente',
            'Uso interno'
        ],
        'adjustment': [
            'Corrección de inventario',
            'Auditoria',
            'Error de registro',
            'Ajuste por diferencia física'
        ]
    };

    if (reasons[movementType]) {
        reasons[movementType].forEach(reason => {
            const option = document.createElement('option');
            option.value = reason;
            option.textContent = reason;
            reasonSelect.appendChild(option);
        });
    }
}

function calculateResultingStock() {
    const currentStock = parseInt(document.getElementById('currentStock').textContent) || 0;
    const movementType = document.getElementById('movementType').value;
    const quantity = parseInt(document.getElementById('movementQuantity').value) || 0;

    if (!movementType || !quantity) {
        document.getElementById('stockWarning').style.display = 'none';
        return;
    }

    let resultingStock = currentStock;

    if (movementType === 'in') {
        resultingStock += quantity;
    } else if (movementType === 'out') {
        resultingStock -= quantity;
    } else if (movementType === 'adjustment') {
        // For adjustments, the quantity could be the new total or the difference
        // For simplicity, we'll treat it as setting to that quantity
        resultingStock = quantity;
    }

    document.getElementById('resultingStock').textContent = resultingStock;
    document.getElementById('stockWarning').style.display = 'block';

    // Change color based on result
    const warningDiv = document.getElementById('stockWarning');
    if (resultingStock < 0) {
        warningDiv.className = 'alert alert-danger';
    } else if (resultingStock === 0) {
        warningDiv.className = 'alert alert-warning';
    } else {
        warningDiv.className = 'alert alert-info';
    }
}

function closeStockModal() {
    document.getElementById('stockModal').classList.remove('show');
    document.getElementById('stockForm').reset();
    currentMedicationId = null;
}

async function saveStockMovement() {
    try {
        const form = document.getElementById('stockForm');

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const movementType = document.getElementById('movementType').value;
        const quantity = parseInt(document.getElementById('movementQuantity').value);
        const reason = document.getElementById('movementReason').value;
        const reference = document.getElementById('movementReference').value;
        const unitCost = parseFloat(document.getElementById('movementUnitCost').value) || null;

        let endpoint;
        let requestData = {
            medication_id: currentMedicationId,
            quantity: quantity,
            reason: reason,
            reference_id: reference,
            user_id: '{{ user.id }}' // From template
        };

        if (unitCost) {
            requestData.unit_cost = unitCost;
        }

        // Choose endpoint based on movement type
        if (movementType === 'in') {
            endpoint = '/inventory/add-stock';
        } else if (movementType === 'out') {
            endpoint = '/inventory/reduce-stock';
        } else {
            endpoint = '/inventory/update-stock';
            requestData.quantity_change = quantity - parseInt(document.getElementById('currentStock').textContent);
        }

        const response = await makeAPIRequest(
            `${API_CONFIG.INVENTORY_SERVICE_URL}${endpoint}`,
            {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            }
        );

        if (response.success) {
            showMessage('Stock actualizado exitosamente', 'success');
            closeStockModal();
            await loadMedications();
        } else {
            throw new Error(response.message);
        }

    } catch (error) {
        console.error('❌ Error actualizando stock:', error);
        showMessage('Error actualizando stock: ' + error.message, 'error');
    }
}

// =============== MEDICATION DETAILS ===============
async function showMedicationDetails(medicationId) {
    try {
        const medication = medications.find(m => m.id === medicationId);
        if (!medication) {
            showMessage('Medicamento no encontrado', 'error');
            return;
        }

        currentMedicationId = medicationId;

        // Load recent movements
        let recentMovements = [];
        try {
            const movementsResponse = await makeAPIRequest(
                `${API_CONFIG.INVENTORY_SERVICE_URL}/inventory/movements?medication_id=${medicationId}&limit=10`
            );
            if (movementsResponse.success) {
                recentMovements = movementsResponse.movements || [];
            }
        } catch (error) {
            console.error('Error loading movements:', error);
        }

        const detailsContent = `
            <div class="form-grid" style="margin-bottom: 30px;">
                <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <div style="padding: 10px; background: #D8F3DC; border-radius: 8px; font-weight: 600;">
                        ${medication.name}
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Categoría</label>
                    <div style="padding: 10px; background: #D8F3DC; border-radius: 8px;">
                        ${medication.category || 'No especificada'}
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Stock Actual</label>
                    <div style="padding: 10px; background: #D8F3DC; border-radius: 8px; font-weight: 600; color: #2D6A4F;">
                        ${medication.stock_quantity || 0} unidades
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Estado</label>
                    <div style="padding: 10px;">
                        <span class="status-badge ${getStockStatusClass(medication)}">
                            ${getStockStatusText(medication)}
                        </span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Precio Unitario</label>
                    <div style="padding: 10px; background: #D8F3DC; border-radius: 8px; font-weight: 600;">
                        ${formatCurrency(medication.unit_price || 0)}
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Valor Total</label>
                    <div style="padding: 10px; background: #D8F3DC; border-radius: 8px; font-weight: 600; color: #52B788;">
                        ${formatCurrency((medication.unit_price || 0) * (medication.stock_quantity || 0))}
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Presentación</label>
                    <div style="padding: 10px; background: #D8F3DC; border-radius: 8px;">
                        ${medication.presentation || 'No especificada'}
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Concentración</label>
                    <div style="padding: 10px; background: #D8F3DC; border-radius: 8px;">
                        ${medication.concentration || 'No especificada'}
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Laboratorio</label>
                    <div style="padding: 10px; background: #D8F3DC; border-radius: 8px;">
                        ${medication.laboratory || 'No especificado'}
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Proveedor</label>
                    <div style="padding: 10px; background: #D8F3DC; border-radius: 8px;">
                        ${medication.supplier || 'No especificado'}
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Fecha de Vencimiento</label>
                    <div style="padding: 10px; background: #D8F3DC; border-radius: 8px;">
                        ${medication.expiration_date ? formatDate(medication.expiration_date) : 'No especificada'}
                        ${getExpiryWarning(medication)}
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Número de Lote</label>
                    <div style="padding: 10px; background: #D8F3DC; border-radius: 8px;">
                        ${medication.batch_number || 'No especificado'}
                    </div>
                </div>
            </div>

            ${medication.description ? `
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">Descripción</label>
                    <div style="padding: 15px; background: #D8F3DC; border-radius: 8px; white-space: pre-wrap;">
                        ${medication.description}
                    </div>
                </div>
            ` : ''}

            ${medication.storage_conditions ? `
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">Condiciones de Almacenamiento</label>
                    <div style="padding: 15px; background: #D8F3DC; border-radius: 8px; white-space: pre-wrap;">
                        ${medication.storage_conditions}
                    </div>
                </div>
            ` : ''}

            <div style="margin-top: 30px;">
                <h4 style="color: #2D6A4F; margin-bottom: 15px;">📋 Movimientos Recientes</h4>
                ${recentMovements.length > 0 ? `
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${recentMovements.map(movement => `
                            <div class="movement-item">
                                <div class="movement-info">
                                    <div class="movement-type movement-${movement.movement_type}">
                                        ${getMovementTypeText(movement.movement_type)} - ${movement.quantity} unidades
                                    </div>
                                    <div class="movement-details">
                                        ${movement.reason} • ${formatDateTime(movement.created_at)}
                                    </div>
                                </div>
                                <div class="movement-amount movement-${movement.movement_type}">
                                    ${movement.movement_type === 'out' ? '-' : '+'}${movement.quantity}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div style="text-align: center; padding: 30px; color: #666;">
                        <div style="font-size: 2rem;">📋</div>
                        <div>No hay movimientos registrados</div>
                    </div>
                `}
            </div>
        `;

        document.getElementById('medicationDetailsContent').innerHTML = detailsContent;
        document.getElementById('medicationDetailsModal').classList.add('show');

    } catch (error) {
        console.error('❌ Error mostrando detalles:', error);
        showMessage('Error cargando detalles del medicamento', 'error');
    }
}

function closeMedicationDetailsModal() {
    document.getElementById('medicationDetailsModal').classList.remove('show');
    currentMedicationId = null;
}

function editMedicationFromDetails() {
    closeMedicationDetailsModal();
    editMedication(currentMedicationId);
}

function getMovementTypeText(type) {
    const types = {
        'in': '📥 Entrada',
        'out': '📤 Salida',
        'adjustment': '⚖️ Ajuste'
    };
    return types[type] || type;
}

// =============== DELETE MEDICATION ===============
async function deleteMedication(medicationId) {
    const medication = medications.find(m => m.id === medicationId);
    if (!medication) {
        showMessage('Medicamento no encontrado', 'error');
        return;
    }

    if (!confirm(`¿Está seguro que desea eliminar el medicamento "${medication.name}"?\n\nEsta acción no se puede deshacer.`)) {
        return;
    }

    try {
        const response = await makeAPIRequest(
            `${API_CONFIG.INVENTORY_SERVICE_URL}/inventory/medications/${medicationId}/deactivate`,
            { method: 'PUT' }
        );

        if (response.success) {
            showMessage('Medicamento eliminado exitosamente', 'success');
            await loadMedications();
        } else {
            throw new Error(response.message);
        }

    } catch (error) {
        console.error('❌ Error eliminando medicamento:', error);
        showMessage('Error eliminando medicamento: ' + error.message, 'error');
    }
}

// =============== FILTERING AND SEARCH ===============
function filterMedications() {
    const searchTerm = document.getElementById('searchMedications').value.toLowerCase();
    const categoryFilter = document.getElementById('filterCategory').value;
    const stockFilter = document.getElementById('filterStock').value;

    let filteredMedications = medications.filter(medication => {
        // Search filter
        const matchesSearch = !searchTerm ||
            medication.name.toLowerCase().includes(searchTerm) ||
            (medication.laboratory && medication.laboratory.toLowerCase().includes(searchTerm)) ||
            (medication.category && medication.category.toLowerCase().includes(searchTerm));

        // Category filter
        const matchesCategory = !categoryFilter || medication.category === categoryFilter;

        // Stock filter
        let matchesStock = true;
        if (stockFilter) {
            const stockStatus = getStockStatusText(medication).toLowerCase().replace(' ', '_');
            matchesStock = stockStatus === stockFilter;
        }

        return matchesSearch && matchesCategory && matchesStock;
    });

    // Temporarily update medications array for rendering
    const originalMedications = medications;
    medications = filteredMedications;
    renderMedicationsTable();
    medications = originalMedications;
}

function clearFilters() {
    document.getElementById('searchMedications').value = '';
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterStock').value = '';
    renderMedicationsTable();
}

// =============== TAB SWITCHING ===============
function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-item').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${tabName}-tab`).classList.add('active');

    // Load tab-specific data
    switch (tabName) {
        case 'movements':
            loadMovementsTab();
            break;
        case 'alerts':
            loadAlertsTab();
            break;
        case 'reports':
            loadReportsTab();
            break;
    }
}

// =============== MOVEMENTS TAB ===============
async function loadMovementsTab() {
    // Populate medication filter
    const medicationSelect = document.getElementById('filterMedicationMovements');
    medicationSelect.innerHTML = '<option value="">Todos los medicamentos</option>';

    medications.forEach(med => {
        const option = document.createElement('option');
        option.value = med.id;
        option.textContent = med.name;
        medicationSelect.appendChild(option);
    });
}

async function loadMovements() {
    try {
        const medicationId = document.getElementById('filterMedicationMovements').value;
        const movementType = document.getElementById('filterMovementType').value;
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;

        let url = `${API_CONFIG.INVENTORY_SERVICE_URL}/inventory/movements?`;
        const params = new URLSearchParams();

        if (medicationId) params.append('medication_id', medicationId);
        if (movementType) params.append('movement_type', movementType);
        if (dateFrom) params.append('start_date', dateFrom);
        if (dateTo) params.append('end_date', dateTo);

        url += params.toString();

        const response = await makeAPIRequest(url);

        if (response.success) {
            movements = response.movements || [];
            renderMovements();
        } else {
            throw new Error(response.message);
        }

    } catch (error) {
        console.error('❌ Error cargando movimientos:', error);
        showMessage('Error cargando movimientos', 'error');
        renderMovements([]); // Show empty state
    }
}

function renderMovements(movementsData = movements) {
    const container = document.getElementById('movementsContainer');

    if (movementsData.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 3rem;">📋</div>
                <div>No hay movimientos que coincidan con los filtros</div>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <div style="margin-bottom: 20px;">
            <h4 style="color: #2D6A4F;">📋 Movimientos de Stock (${movementsData.length})</h4>
        </div>
        <div style="max-height: 600px; overflow-y: auto;">
            ${movementsData.map(movement => {
                const medication = medications.find(m => m.id === movement.medication_id);
                return `
                    <div class="movement-item">
                        <div class="movement-info">
                            <div class="movement-type movement-${movement.movement_type}">
                                <strong>${getMovementTypeText(movement.movement_type)}</strong>
                                ${medication ? ` - ${medication.name}` : ''}
                            </div>
                            <div class="movement-details">
                                ${movement.reason} • Cantidad: ${movement.quantity} unidades<br>
                                ${formatDateTime(movement.created_at)}
                                ${movement.reference_id ? ` • Ref: ${movement.reference_id}` : ''}
                            </div>
                        </div>
                        <div class="movement-amount movement-${movement.movement_type}">
                            ${movement.movement_type === 'out' ? '-' : '+'}${movement.quantity}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

// =============== ALERTS TAB ===============
async function loadAlertsTab() {
    try {
        showLoading('alertsContainer', true);

        // Load low stock alerts
        const lowStockResponse = await makeAPIRequest(
            `${API_CONFIG.INVENTORY_SERVICE_URL}/inventory/alerts/low-stock`
        );

        // Load expiring medications
        const expiringResponse = await makeAPIRequest(
            `${API_CONFIG.INVENTORY_SERVICE_URL}/inventory/alerts/expiring?days=30`
        );

        renderAlerts(
            lowStockResponse.success ? lowStockResponse.low_stock_medications : [],
            expiringResponse.success ? expiringResponse.expiring_medications : []
        );

    } catch (error) {
        console.error('❌ Error cargando alertas:', error);
        renderAlerts([], []);
    }
}

function renderAlerts(lowStockMeds, expiringMeds) {
    const container = document.getElementById('alertsContainer');

    const hasAlerts = lowStockMeds.length > 0 || expiringMeds.length > 0;

    if (!hasAlerts) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 3rem;">✅</div>
                <div style="color: #52B788; font-weight: 600; margin-top: 10px;">
                    No hay alertas en este momento
                </div>
                <div>Todo el inventario está en buenas condiciones</div>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        ${lowStockMeds.length > 0 ? `
            <div style="margin-bottom: 30px;">
                <div class="alert alert-warning">
                    <span>⚠️</span>
                    <div>
                        <strong>Stock Bajo</strong><br>
                        ${lowStockMeds.length} medicamento(s) con stock por debajo del límite mínimo
                    </div>
                </div>

                <div class="inventory-table-container">
                    <table class="inventory-table">
                        <thead>
                            <tr>
                                <th>Medicamento</th>
                                <th>Stock Actual</th>
                                <th>Stock Mínimo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${lowStockMeds.map(med => `
                                <tr>
                                    <td>
                                        <strong>${med.name}</strong><br>
                                        <small style="color: #666;">${med.category || 'Sin categoría'}</small>
                                    </td>
                                    <td>
                                        <span style="color: #dc3545; font-weight: 600;">
                                            ${med.stock_quantity || 0}
                                        </span>
                                    </td>
                                    <td>${med.minimum_stock_alert || 10}</td>
                                    <td>
                                        <span class="status-badge ${getStockStatusClass(med)}">
                                            ${getStockStatusText(med)}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="updateStock('${med.id}')">
                                            <span>📦</span> Reabastecer
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        ` : ''}

        ${expiringMeds.length > 0 ? `
            <div style="margin-bottom: 30px;">
                <div class="alert alert-danger">
                    <span>⏰</span>
                    <div>
                        <strong>Próximos a Vencer</strong><br>
                        ${expiringMeds.length} medicamento(s) vencen en los próximos 30 días
                    </div>
                </div>

                <div class="inventory-table-container">
                    <table class="inventory-table">
                        <thead>
                            <tr>
                                <th>Medicamento</th>
                                <th>Stock</th>
                                <th>Fecha Vencimiento</th>
                                <th>Días Restantes</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${expiringMeds.map(med => {
                                const daysToExpiry = med.days_to_expiration || 0;
                                return `
                                    <tr>
                                        <td>
                                            <strong>${med.name}</strong><br>
                                            <small style="color: #666;">${med.category || 'Sin categoría'}</small>
                                        </td>
                                        <td>${med.stock_quantity || 0}</td>
                                        <td>${formatDate(med.expiration_date)}</td>
                                        <td>
                                            <span style="color: ${daysToExpiry <= 7 ? '#dc3545' : '#ffc107'}; font-weight: 600;">
                                                ${daysToExpiry} días
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-warning btn-sm" onclick="updateStock('${med.id}')">
                                                <span>📤</span> Dar Salida
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        ` : ''}
    `;
}

async function refreshAlerts() {
    await loadAlertsTab();
    showMessage('Alertas actualizadas', 'success');
}

async function sendAlertNotifications() {
    try {
        const response = await makeAPIRequest(
            `${API_CONFIG.INVENTORY_SERVICE_URL}/inventory/alerts/check-expiration`,
            {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ days_threshold: 30 })
            }
        );

        if (response.success) {
            showMessage('Notificaciones enviadas exitosamente', 'success');
        } else {
            throw new Error(response.message);
        }

    } catch (error) {
        console.error('❌ Error enviando notificaciones:', error);
        showMessage('Error enviando notificaciones', 'error');
    }
}

// =============== REPORTS TAB ===============
function loadReportsTab() {
    // Initialize reports tab if needed
    console.log('📊 Cargando tab de reportes');
}

async function generateSelectedReport() {
    try {
        const reportType = document.getElementById('reportType').value;
        const dateFrom = document.getElementById('reportDateFrom').value;
        const dateTo = document.getElementById('reportDateTo').value;
        const format = document.getElementById('reportFormat').value;

        let endpoint = '';
        let params = new URLSearchParams();

        if (dateFrom) params.append('start_date', dateFrom);
        if (dateTo) params.append('end_date', dateTo);

        switch (reportType) {
            case 'movements':
                endpoint = '/inventory/reports/movements';
                break;
            case 'low_stock':
                endpoint = '/inventory/alerts/low-stock';
                break;
            case 'expiration':
                endpoint = '/inventory/alerts/expiring';
                params.append('days', '30');
                break;
            case 'financial':
                endpoint = '/inventory/summary';
                break;
            default:
                endpoint = '/inventory/summary';
        }

        const url = `${API_CONFIG.INVENTORY_SERVICE_URL}${endpoint}${params.toString() ? '?' + params.toString() : ''}`;

        if (format === 'csv') {
            // For CSV, redirect to export endpoint
            window.open(`${API_CONFIG.INVENTORY_SERVICE_URL}/inventory/export/csv`, '_blank');
            showMessage('Descarga de CSV iniciada', 'success');
        } else {
            // For other formats, show preview
            const response = await makeAPIRequest(url);

            if (response.success) {
                showReportPreview(response, reportType);
                showMessage('Reporte generado exitosamente', 'success');
            } else {
                throw new Error(response.message);
            }
        }

    } catch (error) {
        console.error('❌ Error generando reporte:', error);
        showMessage('Error generando reporte: ' + error.message, 'error');
    }
}

function showReportPreview(data, reportType) {
    const container = document.getElementById('reportPreview');

    let content = '';

    switch (reportType) {
        case 'movements':
            content = generateMovementsReport(data);
            break;
        case 'low_stock':
            content = generateLowStockReport(data);
            break;
        case 'expiration':
            content = generateExpirationReport(data);
            break;
        case 'financial':
            content = generateFinancialReport(data);
            break;
        default:
            content = generateGeneralReport(data);
    }

    container.innerHTML = content;
}

function generateGeneralReport(data) {
    return `
        <div class="inventory-table-container">
            <h4 style="color: #2D6A4F; margin-bottom: 20px;">📊 Reporte General de Inventario</h4>

            <div class="stats-grid" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-number">${data.summary?.total_medications || 0}</div>
                    <div class="stat-label">Total Medicamentos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${formatCurrency(data.summary?.total_inventory_value || 0)}</div>
                    <div class="stat-label">Valor Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.summary?.low_stock_count || 0}</div>
                    <div class="stat-label">Stock Bajo</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.summary?.expiring_soon_count || 0}</div>
                    <div class="stat-label">Por Vencer</div>
                </div>
            </div>

            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-primary" onclick="window.print()">
                    <span>🖨️</span> Imprimir
                </button>
            </div>
        </div>
    `;
}

// =============== SIMPLIFIED UTILITY FUNCTIONS ===============
async function bulkUpdateStock() {
    showMessage('Función de actualización masiva en desarrollo', 'info');
}

async function checkExpirations() {
    try {
        const response = await fetch('/api/admin/inventory/alerts/check-expiration', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ days_threshold: 30 })
        });

        const data = await response.json();

        if (data.success) {
            showMessage(`Verificación completada. ${data.expiring_medications?.length || 0} medicamentos próximos a vencer`, 'info');
            if (document.querySelector('[data-tab="alerts"]').classList.contains('active')) {
                await loadAlertsTab();
            }
        } else {
            throw new Error(data.message);
        }

    } catch (error) {
        console.error('❌ Error verificando vencimientos:', error);
        showMessage('Error verificando vencimientos', 'error');
    }
}

async function lowStockReport() {
    switchTab('alerts');
    await loadAlertsTab();
}

async function generateReport() {
    switchTab('reports');
}

async function exportToCSV() {
    try {
        console.log('📄 Exportando a CSV...');

        // Crear enlace para descargar
        const link = document.createElement('a');
        link.href = '/api/admin/inventory/export/csv';
        link.target = '_blank';
        link.click();

        showMessage('Descarga de CSV iniciada', 'success');

    } catch (error) {
        console.error('❌ Error exportando CSV:', error);
        showMessage('Error exportando CSV', 'error');
    }
}

async function exportToPDF() {
    showMessage('Exportación a PDF en desarrollo', 'info');
}

function updateStats() {
    const stats = {
        total_medications: medications.length,
        total_inventory_value: medications.reduce((sum, med) => sum + (med.unit_price || 0) * (med.stock_quantity || 0), 0),
        low_stock_count: medications.filter(med => getStockStatusText(med) === 'Stock Bajo').length,
        expiring_soon_count: medications.filter(med => {
            if (!med.expiration_date) return false;
            const daysToExpiry = Math.ceil((new Date(med.expiration_date) - new Date()) / (1000 * 60 * 60 * 24));
            return daysToExpiry <= 30 && daysToExpiry > 0;
        }).length
    };

    updateStatsDisplay(stats);
}

function closeAllModals() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('show');
    });
}

function showLoading(elementId, show) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = show ? 'flex' : 'none';
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// =============== EXAMPLE DATA FOR FALLBACK ===============
function getExampleMedications() {
    return [
        {
            id: 'med_001',
            name: 'Amoxicilina',
            category: 'Antibiótico',
            presentation: 'Comprimidos',
            concentration: '500mg',
            laboratory: 'Laboratorios Veterinarios S.A.',
            supplier: 'Distribuidora Médica',
            unit_price: 2500,
            stock_quantity: 45,
            minimum_stock_alert: 20,
            expiration_date: '2024-08-15',
            batch_number: 'AMX2024-001',
            description: 'Antibiótico de amplio espectro para infecciones bacterianas',
            storage_conditions: 'Conservar en lugar fresco y seco, temperatura ambiente',
            is_active: true
        },
        {
            id: 'med_002',
            name: 'Meloxicam',
            category: 'Antiinflamatorio',
            presentation: 'Inyectable',
            concentration: '2mg/ml',
            laboratory: 'VetPharma',
            supplier: 'Distribuidora Médica',
            unit_price: 8500,
            stock_quantity: 8,
            minimum_stock_alert: 15,
            expiration_date: '2024-12-30',
            batch_number: 'MLX2024-002',
            description: 'Antiinflamatorio no esteroideo para dolor y inflamación',
            storage_conditions: 'Refrigerar entre 2-8°C',
            is_active: true
        },
        {
            id: 'med_003',
            name: 'Vacuna Múltiple',
            category: 'Vacunas',
            presentation: 'Vial',
            concentration: '1ml/dosis',
            laboratory: 'BioVet',
            supplier: 'Vacunas Veterinarias',
            unit_price: 15000,
            stock_quantity: 0,
            minimum_stock_alert: 10,
            expiration_date: '2024-06-20',
            batch_number: 'VAC2024-003',
            description: 'Vacuna múltiple para perros (DHPP)',
            storage_conditions: 'Conservar refrigerado 2-8°C, no congelar',
            is_active: true
        },
        {
            id: 'med_004',
            name: 'Tramadol',
            category: 'Analgésico',
            presentation: 'Comprimidos',
            concentration: '50mg',
            laboratory: 'PainRelief Vet',
            supplier: 'Farmacia Veterinaria Central',
            unit_price: 1200,
            stock_quantity: 120,
            minimum_stock_alert: 30,
            expiration_date: '2025-03-15',
            batch_number: 'TRA2024-004',
            description: 'Analgésico opioide para dolor moderado a severo',
            storage_conditions: 'Conservar en lugar seguro, temperatura ambiente',
            is_active: true
        },
        {
            id: 'med_005',
            name: 'Ivermectina',
            category: 'Antiparasitario',
            presentation: 'Solución oral',
            concentration: '1mg/ml',
            laboratory: 'Parasit Control',
            supplier: 'Antiparasitarios Vet',
            unit_price: 3200,
            stock_quantity: 25,
            minimum_stock_alert: 20,
            expiration_date: '2024-10-08',
            batch_number: 'IVE2024-005',
            description: 'Antiparasitario interno y externo de amplio espectro',
            storage_conditions: 'Proteger de la luz, temperatura ambiente',
            is_active: true
        },
        {
            id: 'med_006',
            name: 'Complejo Vitamínico B',
            category: 'Vitaminas',
            presentation: 'Inyectable',
            concentration: '10ml',
            laboratory: 'NutriVet',
            supplier: 'Suplementos Veterinarios',
            unit_price: 4500,
            stock_quantity: 35,
            minimum_stock_alert: 25,
            expiration_date: '2025-01-20',
            batch_number: 'VIT2024-006',
            description: 'Complejo vitamínico para deficiencias nutricionales',
            storage_conditions: 'Conservar refrigerado, proteger de la luz',
            is_active: true
        }
    ];
}

console.log('✅ Sistema de Inventario cargado correctamente');
</script>
{% endblock %}