{% extends "admin/admin_base.html" %}

{% block title %}Gestión de Historias Clínicas{% endblock %}

{% block page_title %}Gestión de Historias Clínicas{% endblock %}

{% block custom_styles %}
<style>
    /* =============== MEDICAL RECORDS SPECIFIC STYLES =============== */
    .medical-records-content {
        padding: 30px;
    }

    .page-header {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 12px rgba(8, 28, 21, 0.08);
        margin-bottom: 30px;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .header-info h1 {
        color: #2D6A4F;
        font-size: 2.2rem;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .header-info p {
        color: #52B788;
        font-size: 1.1rem;
        margin: 0;
    }

    .header-actions {
        display: flex;
        gap: 15px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #52B788 0%, #38A3A5 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(82, 183, 136, 0.3);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #B7E4C7 0%, #D8F3DC 100%);
        color: #2D6A4F;
        border: 2px solid #B7E4C7;
        padding: 10px 22px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-secondary:hover {
        background: #B7E4C7;
        transform: translateY(-2px);
    }

    /* ESTADÍSTICAS */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .stat-item {
        background: white;
        padding: 25px;
        border-radius: 15px;
        border: 1px solid #D8F3DC;
        display: flex;
        align-items: center;
        gap: 20px;
        border-left: 4px solid;
        transition: transform 0.3s ease;
    }

    .stat-item:hover {
        transform: translateY(-3px);
    }

    .stat-item.total { border-left-color: #52B788; }
    .stat-item.today { border-left-color: #38A3A5; }
    .stat-item.emergency { border-left-color: #22577A; }
    .stat-item.completed { border-left-color: #2D6A4F; }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }

    .stat-icon.total { background: linear-gradient(135deg, #52B788, #38A3A5); }
    .stat-icon.today { background: linear-gradient(135deg, #38A3A5, #22577A); }
    .stat-icon.emergency { background: linear-gradient(135deg, #22577A, #2D6A4F); }
    .stat-icon.completed { background: linear-gradient(135deg, #2D6A4F, #081C15); }

    .stat-data {
        flex: 1;
    }

    .stat-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: #2D6A4F;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #52B788;
        font-size: 0.95rem;
        font-weight: 500;
    }

    /* FILTROS Y CONTROLES */
    .controls-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(8, 28, 21, 0.08);
        margin-bottom: 30px;
    }

    .controls-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .controls-title {
        color: #2D6A4F;
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0;
    }

    .controls-grid {
        display: grid;
        grid-template-columns: 2fr 200px 200px 200px 200px;
        gap: 20px;
        align-items: end;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        color: #2D6A4F;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .form-input,
    .form-select {
        padding: 12px 15px;
        border: 2px solid #D8F3DC;
        border-radius: 10px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        background: white;
        color: #2D6A4F;
    }

    .form-input:focus,
    .form-select:focus {
        outline: none;
        border-color: #52B788;
        box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.1);
    }

    .search-input {
        background: #D8F3DC;
        border: 2px solid transparent;
    }

    .search-input:focus {
        background: white;
        border-color: #52B788;
    }

    /* TABLA DE HISTORIAS CLÍNICAS */
    .records-table-section {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(8, 28, 21, 0.08);
        overflow: hidden;
    }

    .table-header {
        padding: 25px;
        border-bottom: 1px solid #D8F3DC;
        background: linear-gradient(135deg, #F8FBF9 0%, #F0F8F0 100%);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-title {
        color: #2D6A4F;
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .results-info {
        color: #52B788;
        font-size: 0.9rem;
    }

    .table-container {
        overflow-x: auto;
    }

    .records-table {
        width: 100%;
        border-collapse: collapse;
    }

    .records-table th {
        background: #D8F3DC;
        padding: 18px 20px;
        text-align: left;
        font-weight: 600;
        color: #2D6A4F;
        border-bottom: 2px solid #B7E4C7;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .records-table td {
        padding: 18px 20px;
        border-bottom: 1px solid #D8F3DC;
        vertical-align: middle;
    }

    .records-table tr {
        transition: all 0.2s ease;
    }

    .records-table tr:hover {
        background: rgba(183, 228, 199, 0.15);
    }

    .record-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .record-avatar {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #52B788, #38A3A5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 1.2rem;
        border: 3px solid #B7E4C7;
    }

    .record-details {
        flex: 1;
    }

    .record-date {
        font-weight: 600;
        color: #2D6A4F;
        margin-bottom: 2px;
        font-size: 1rem;
    }

    .record-time {
        color: #52B788;
        font-size: 0.85rem;
    }

    .pet-info {
        display: flex;
        flex-direction: column;
    }

    .pet-name {
        font-weight: 600;
        color: #2D6A4F;
        margin-bottom: 2px;
    }

    .pet-species {
        color: #52B788;
        font-size: 0.85rem;
    }

    .vet-info {
        display: flex;
        flex-direction: column;
    }

    .vet-name {
        font-weight: 600;
        color: #2D6A4F;
        margin-bottom: 2px;
    }

    .vet-specialty {
        color: #52B788;
        font-size: 0.85rem;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: white;
    }

    .status-badge.draft { background: linear-gradient(135deg, #6c757d, #495057); }
    .status-badge.completed { background: linear-gradient(135deg, #52B788, #38A3A5); }
    .status-badge.reviewed { background: linear-gradient(135deg, #38A3A5, #22577A); }

    .priority-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .priority-badge.normal { background: #d4edda; color: #155724; }
    .priority-badge.emergency { background: #f8d7da; color: #721c24; }

    .actions-group {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .action-btn.view {
        background: #22577A;
        color: white;
    }

    .action-btn.edit {
        background: #52B788;
        color: white;
    }

    .action-btn.complete {
        background: #38A3A5;
        color: white;
    }

    .action-btn.print {
        background: #2D6A4F;
        color: white;
    }

    .action-btn.delete {
        background: #dc3545;
        color: white;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* MODAL STYLES */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(8, 28, 21, 0.8);
        backdrop-filter: blur(5px);
    }

    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 20px;
        width: 90%;
        max-width: 1000px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(8, 28, 21, 0.3);
        animation: modalSlideIn 0.3s ease;
        position: relative;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-header {
        padding: 25px 30px 0;
        border-bottom: 1px solid #D8F3DC;
        margin-bottom: 25px;
    }

    .modal-title {
        color: #2D6A4F;
        font-size: 1.6rem;
        font-weight: 600;
        margin: 0 0 10px 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .modal-subtitle {
        color: #52B788;
        font-size: 1rem;
        margin: 0 0 20px 0;
    }

    .modal-close {
        position: absolute;
        top: 20px;
        right: 25px;
        background: none;
        border: none;
        font-size: 24px;
        color: #52B788;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: #D8F3DC;
        color: #2D6A4F;
    }

    .modal-body {
        padding: 0 30px 30px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-row.full {
        grid-template-columns: 1fr;
    }

    .form-row.thirds {
        grid-template-columns: 1fr 1fr 1fr;
    }

    .form-textarea {
        padding: 12px 15px;
        border: 2px solid #D8F3DC;
        border-radius: 10px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        background: white;
        color: #2D6A4F;
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
    }

    .form-textarea:focus {
        outline: none;
        border-color: #52B788;
        box-shadow: 0 0 0 4px rgba(82, 183, 136, 0.1);
    }

    .modal-actions {
        padding: 20px 30px;
        border-top: 1px solid #D8F3DC;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        background: #F8FBF9;
        border-bottom-left-radius: 20px;
        border-bottom-right-radius: 20px;
    }

    .btn-cancel {
        background: #6c757d;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .btn-cancel:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    .btn-save {
        background: linear-gradient(135deg, #52B788 0%, #38A3A5 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(82, 183, 136, 0.3);
    }

    .btn-save:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* SECCIÓN DE PRESCRIPCIONES */
    .prescriptions-section {
        background: #D8F3DC;
        padding: 20px;
        border-radius: 15px;
        margin: 20px 0;
    }

    .prescriptions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .prescription-item {
        background: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        border-left: 4px solid #52B788;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 15px;
        align-items: center;
    }

    .prescription-details {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        gap: 15px;
        align-items: center;
    }

    .medication-name {
        font-weight: 600;
        color: #2D6A4F;
        margin-bottom: 3px;
    }

    .medication-dosage {
        color: #52B788;
        font-size: 0.9rem;
    }

    .prescription-actions {
        display: flex;
        gap: 8px;
    }

    /* SECCIÓN DE EXÁMENES */
    .exams-section {
        background: #F8FBF9;
        padding: 20px;
        border-radius: 15px;
        margin: 20px 0;
        border-left: 4px solid #38A3A5;
    }

    .exam-item {
        background: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .exam-info {
        flex: 1;
    }

    .exam-name {
        font-weight: 600;
        color: #2D6A4F;
        margin-bottom: 3px;
    }

    .exam-date {
        color: #52B788;
        font-size: 0.9rem;
    }

    .exam-file {
        color: #22577A;
        font-size: 0.85rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .exam-file:hover {
        text-decoration: underline;
    }

    /* EMPTY STATE */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #52B788;
    }

    .empty-state h3 {
        color: #2D6A4F;
        margin-bottom: 15px;
        font-size: 1.4rem;
    }

    .empty-state p {
        margin-bottom: 25px;
        font-size: 1rem;
    }

    /* LOADING STATE */
    .table-loading {
        text-align: center;
        padding: 40px;
        color: #52B788;
    }

    .table-loading .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #D8F3DC;
        border-top: 4px solid #52B788;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
        .controls-grid {
            grid-template-columns: 2fr 180px 180px 180px;
        }
    }

    @media (max-width: 768px) {
        .medical-records-content {
            padding: 20px 15px;
        }

        .header-content {
            flex-direction: column;
            gap: 20px;
            align-items: stretch;
        }

        .header-actions {
            justify-content: center;
        }

        .stats-row {
            grid-template-columns: 1fr;
        }

        .controls-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .form-row.thirds {
            grid-template-columns: 1fr;
        }

        .modal-content {
            width: 95%;
            margin: 20px;
        }

        .records-table {
            font-size: 0.85rem;
        }

        .records-table th,
        .records-table td {
            padding: 12px 10px;
        }

        .actions-group {
            flex-direction: column;
            gap: 4px;
        }

        .prescription-details {
            grid-template-columns: 1fr;
            gap: 10px;
        }
    }

    .medication-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.medication-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.medication-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
}

.medication-name {
    font-weight: 600;
    color: #2D6A4F;
    font-size: 16px;
    margin: 0;
    flex: 1;
}

.medication-stock {
    background: #e8f5e8;
    color: #1b5e20;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.medication-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 8px;
    margin-bottom: 10px;
}

.medication-detail {
    font-size: 14px;
}

.medication-detail strong {
    color: #495057;
}

.medication-actions {
    display: flex;
    justify-content: flex-end;
    gap: 5px;
}

.btn-remove {
    background: #dc3545;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.btn-remove:hover {
    background: #c82333;
}

.stock-warning {
    color: #856404;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    padding: 8px;
    border-radius: 4px;
    font-size: 12px;
    margin-top: 5px;
}

.stock-error {
    color: #721c24;
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    padding: 8px;
    border-radius: 4px;
    font-size: 12px;
    margin-top: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="medical-records-content">
    <!-- HEADER -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-info">
                <h1>
                    <span>📄</span>
                    Gestión de Historias Clínicas
                </h1>
                <p>Administra las historias clínicas y registros médicos de las mascotas</p>
            </div>
            <div class="header-actions">
                <button onclick="exportRecords('pdf')" class="btn-secondary">
                    📄 Reporte PDF
                </button>
                <button onclick="exportRecords('excel')" class="btn-secondary">
                    📊 Exportar Excel
                </button>
                <button onclick="openRecordModal()" class="btn-primary">
                    ➕ Nueva Historia Clínica
                </button>
            </div>
        </div>

        <!-- ESTADÍSTICAS -->
        <div class="stats-row">
            <div class="stat-item total">
                <div class="stat-icon total">📋</div>
                <div class="stat-data">
                    <div class="stat-value" id="recordsTotal">-</div>
                    <div class="stat-label">Total Historias</div>
                </div>
            </div>
            <div class="stat-item today">
                <div class="stat-icon today">📅</div>
                <div class="stat-data">
                    <div class="stat-value" id="recordsToday">-</div>
                    <div class="stat-label">Registros Hoy</div>
                </div>
            </div>
            <div class="stat-item emergency">
                <div class="stat-icon emergency">🚨</div>
                <div class="stat-data">
                    <div class="stat-value" id="emergencyRecords">-</div>
                    <div class="stat-label">Emergencias</div>
                </div>
            </div>
            <div class="stat-item completed">
                <div class="stat-icon completed">✅</div>
                <div class="stat-data">
                    <div class="stat-value" id="completedRecords">-</div>
                    <div class="stat-label">Completadas</div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTROLES Y FILTROS -->
    <div class="controls-section">
        <div class="controls-header">
            <h3 class="controls-title">🔍 Filtros y Controles</h3>
            <button onclick="resetFilters()" class="btn-secondary">
                🔄 Limpiar Filtros
            </button>
        </div>
        <div class="controls-grid">
            <div class="form-group">
                <label for="searchInput" class="form-label">Buscar Historia Clínica</label>
                <input type="text" id="searchInput" class="form-input search-input"
                       placeholder="Nombre de mascota, propietario, veterinario..."
                       onkeyup="filterRecords()">
            </div>
            <div class="form-group">
                <label for="petFilter" class="form-label">Filtrar por Mascota</label>
                <select id="petFilter" class="form-select" onchange="filterRecords()">
                    <option value="">Todas las mascotas</option>
                    <!-- Se llenará dinámicamente -->
                </select>
            </div>
            <div class="form-group">
                <label for="vetFilter" class="form-label">Filtrar por Veterinario</label>
                <select id="vetFilter" class="form-select" onchange="filterRecords()">
                    <option value="">Todos los veterinarios</option>
                    <!-- Se llenará dinámicamente -->
                </select>
            </div>
            <div class="form-group">
                <label for="statusFilter" class="form-label">Filtrar por Estado</label>
                <select id="statusFilter" class="form-select" onchange="filterRecords()">
                    <option value="">Todos los estados</option>
                    <option value="draft">📝 Borrador</option>
                    <option value="completed">✅ Completada</option>
                    <option value="reviewed">👁️ Revisada</option>
                </select>
            </div>
            <div class="form-group">
                <label for="sortBy" class="form-label">Ordenar por</label>
                <select id="sortBy" class="form-select" onchange="sortRecords()">
                    <option value="created_at_desc">Más recientes</option>
                    <option value="created_at">Más antiguas</option>
                    <option value="pet_name">Nombre mascota A-Z</option>
                    <option value="veterinarian">Veterinario A-Z</option>
                    <option value="status">Estado</option>
                </select>
            </div>
        </div>
    </div>

    <!-- TABLA DE HISTORIAS CLÍNICAS -->
    <div class="records-table-section">
        <div class="table-header">
            <h3 class="table-title">
                📋 Lista de Historias Clínicas
            </h3>
            <div class="results-info" id="resultsInfo">
                Cargando historias clínicas...
            </div>
        </div>
        <div class="table-container">
            <div id="recordsTableContainer">
                <div class="table-loading">
                    <div class="spinner"></div>
                    <span>Cargando historias clínicas desde el servidor...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA CREAR/EDITAR HISTORIA CLÍNICA -->
<div class="modal" id="recordModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeRecordModal()">✖</button>
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">
                <span id="modalIcon">📄</span>
                <span id="modalTitleText">Nueva Historia Clínica</span>
            </h2>
            <p class="modal-subtitle" id="modalSubtitle">Completa la información de la consulta médica</p>
        </div>
        <div class="modal-body">
            <form id="recordForm">
                <input type="hidden" id="recordId">

                <!-- INFORMACIÓN BÁSICA -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="petId" class="form-label">Mascota *</label>
                        <select id="petId" name="pet_id" class="form-select" required onchange="updatePetInfo()">
                            <option value="">Seleccionar mascota</option>
                            <!-- Se llenará dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ownerId" class="form-label">Propietario *</label>
                        <select id="ownerId" name="owner_id" class="form-select" required>
                            <option value="">Seleccionar propietario</option>
                            <!-- Se llenará dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="veterinarianId" class="form-label">Veterinario *</label>
                        <select id="veterinarianId" name="veterinarian_id" class="form-select" required>
                            <option value="">Seleccionar veterinario</option>
                            <!-- Se llenará dinámicamente -->
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="appointmentId" class="form-label">Cita Asociada (Opcional)</label>
                        <div style="display: flex; gap: 10px; align-items: end;">
                            <select id="appointmentId" name="appointment_id" class="form-select" onchange="handleAppointmentSelection()">
                                <option value="">Sin cita asociada</option>
                                <option value="search">🔍 Buscar cita existente</option>
                                <!-- Se llenará dinámicamente con citas -->
                            </select>
                            <button type="button" onclick="clearAppointment()" class="btn-secondary" style="padding: 12px; min-width: auto;">
                                🗑️
                            </button>
                        </div>
                        <small style="color: #52B788; font-size: 0.8rem; margin-top: 5px; display: block;">
                            ℹ️ Deja vacío para historia clínica independiente, o selecciona una cita programada
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="isEmergency" class="form-label">Tipo de Consulta</label>
                        <select id="isEmergency" name="is_emergency" class="form-select">
                            <option value="false">🟢 Consulta Normal</option>
                            <option value="true">🚨 Emergencia</option>
                        </select>
                    </div>
                </div>

                <!-- Información de cita seleccionada (solo se muestra si hay cita) -->
                <div id="appointmentInfo" style="display: none; background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #2196f3;">
                    <h5 style="color: #1976d2; margin: 0 0 10px 0;">📅 Información de Cita Asociada</h5>
                    <div id="appointmentDetails" style="color: #1565c0;">
                        <!-- Se llenará dinámicamente -->
                    </div>
                    <button type="button" onclick="loadAppointmentData()" class="btn-secondary" style="margin-top: 10px; font-size: 0.8rem;">
                        📥 Cargar datos de la cita
                    </button>
                </div>

                <!-- EXAMEN FÍSICO Y SIGNOS VITALES -->
                <div class="form-row thirds">
                    <div class="form-group">
                        <label for="weightAtVisit" class="form-label">Peso en Consulta (kg)</label>
                        <input type="number" id="weightAtVisit" name="weight_at_visit" class="form-input"
                               step="0.1" min="0" placeholder="0.0">
                    </div>
                    <div class="form-group">
                        <label for="temperature" class="form-label">Temperatura (°C)</label>
                        <input type="number" id="temperature" name="temperature" class="form-input"
                               step="0.1" min="30" max="45" placeholder="38.5">
                    </div>
                    <div class="form-group">
                        <label for="pulse" class="form-label">Pulso (lat/min)</label>
                        <input type="number" id="pulse" name="pulse" class="form-input"
                               min="0" max="300" placeholder="80">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="respiratoryRate" class="form-label">Frecuencia Respiratoria (resp/min)</label>
                        <input type="number" id="respiratoryRate" name="respiratory_rate" class="form-input"
                               min="0" max="100" placeholder="20">
                    </div>
                    <div class="form-group">
                        <label for="recordStatus" class="form-label">Estado del Registro</label>
                        <select id="recordStatus" name="status" class="form-select">
                            <option value="draft">📝 Borrador</option>
                            <option value="completed">✅ Completada</option>
                            <option value="reviewed">👁️ Revisada</option>
                        </select>
                    </div>
                </div>

                <!-- DESCRIPCIÓN DE SÍNTOMAS -->
                <div class="form-row full">
                    <div class="form-group">
                        <label for="symptomsDescription" class="form-label">Descripción de Síntomas</label>
                        <textarea id="symptomsDescription" name="symptoms_description" class="form-textarea"
                                  placeholder="Describe los síntomas reportados por el propietario..."></textarea>
                    </div>
                </div>

                <!-- EXAMEN FÍSICO -->
                <div class="form-row full">
                    <div class="form-group">
                        <label for="physicalExamination" class="form-label">Examen Físico</label>
                        <textarea id="physicalExamination" name="physical_examination" class="form-textarea"
                                  placeholder="Resultados del examen físico realizado..."></textarea>
                    </div>
                </div>

                <!-- DIAGNÓSTICO -->
                <div class="form-row full">
                    <div class="form-group">
                        <label for="diagnosis" class="form-label">Diagnóstico</label>
                        <textarea id="diagnosis" name="diagnosis" class="form-textarea"
                                  placeholder="Diagnóstico clínico..."></textarea>
                    </div>
                </div>

                <!-- TRATAMIENTO -->
                <div class="form-row full">
                    <div class="form-group">
                        <label for="treatment" class="form-label">Tratamiento</label>
                        <textarea id="treatment" name="treatment" class="form-textarea"
                                  placeholder="Plan de tratamiento recomendado..."></textarea>
                    </div>
                </div>
                                <!-- MEDICAMENTOS PRESCRITOS - VERSIÓN CORREGIDA -->
                <div class="form-row full">
                    <div class="form-group">
                        <label class="form-label">💊 Medicamentos Prescritos</label>

                        <!-- Selector de medicamentos -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: flex; gap: 10px; align-items: end; margin-bottom: 10px;">
                                <div style="flex: 2;">
                                    <label for="medicationSelect" class="form-label" style="margin-bottom: 5px; font-size: 14px;">Seleccionar Medicamento</label>
                                    <select id="medicationSelect" class="form-select">
                                        <option value="">-- Seleccionar medicamento --</option>
                                        <!-- Se llenará dinámicamente desde el inventario -->
                                    </select>
                                </div>
                                <div style="flex: 1;">
                                    <label for="medicationQuantity" class="form-label" style="margin-bottom: 5px; font-size: 14px;">Cantidad</label>
                                    <input type="number" id="medicationQuantity" class="form-input" min="1" placeholder="1">
                                </div>
                                <div>
                                    <button type="button" onclick="addSelectedMedication()" class="btn btn-primary" style="padding: 8px 16px;">
                                        ➕ Agregar
                                    </button>
                                </div>
                            </div>

                            <!-- Campos adicionales para prescripción -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <label for="medicationDosage" class="form-label" style="margin-bottom: 5px; font-size: 14px;">Dosis</label>
                                    <input type="text" id="medicationDosage" class="form-input" placeholder="Ej: 250mg">
                                </div>
                                <div>
                                    <label for="medicationFrequency" class="form-label" style="margin-bottom: 5px; font-size: 14px;">Frecuencia</label>
                                    <input type="text" id="medicationFrequency" class="form-input" placeholder="Ej: Cada 8h">
                                </div>
                                <div>
                                    <label for="medicationDuration" class="form-label" style="margin-bottom: 5px; font-size: 14px;">Duración</label>
                                    <input type="text" id="medicationDuration" class="form-input" placeholder="Ej: 7 días">
                                </div>
                            </div>

                            <div>
                                <label for="medicationInstructions" class="form-label" style="margin-bottom: 5px; font-size: 14px;">Instrucciones</label>
                                <input type="text" id="medicationInstructions" class="form-input" placeholder="Instrucciones especiales...">
                            </div>
                        </div>

                        <!-- Lista de medicamentos agregados -->
                        <div id="prescribedMedicationsList" style="margin-bottom: 15px;">
                            <h6 style="margin: 0 0 10px 0; color: #2D6A4F; font-weight: 600;">📋 Medicamentos Agregados:</h6>
                            <div id="medicationsContainer" style="max-height: 300px; overflow-y: auto;">
                                <div id="noMedicationsMessage" style="padding: 20px; text-align: center; color: #6c757d; border: 2px dashed #dee2e6; border-radius: 8px;">
                                    No se han agregado medicamentos aún
                                </div>
                            </div>
                        </div>

                        <!-- Campo oculto para enviar datos al backend -->
                        <input type="hidden" id="medicationsPrescribed" name="medications_prescribed" value="">
                        <input type="hidden" id="prescriptionsData" name="prescriptions_data" value="[]">
                    </div>
                </div>



                <!-- EXÁMENES SOLICITADOS -->
                <div class="form-row full">
                    <div class="form-group">
                        <label for="examsRequested" class="form-label">Exámenes Solicitados</label>
                        <textarea id="examsRequested" name="exams_requested" class="form-textarea"
                                  placeholder="Exámenes de laboratorio, radiografías, etc..."></textarea>
                    </div>
                </div>

                <!-- OBSERVACIONES -->
                <div class="form-row full">
                    <div class="form-group">
                        <label for="observations" class="form-label">Observaciones</label>
                        <textarea id="observations" name="observations" class="form-textarea"
                                  placeholder="Observaciones adicionales..."></textarea>
                    </div>
                </div>

                <!-- PRÓXIMA CITA -->
                <div class="form-row full">
                    <div class="form-group">
                        <label for="nextAppointment" class="form-label">Recomendación para Próxima Cita</label>
                        <textarea id="nextAppointment" name="next_appointment_recommendation" class="form-textarea"
                                  placeholder="Recomendaciones para el seguimiento..."></textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeRecordModal()" class="btn-cancel">
                Cancelar
            </button>
            <button type="button" onclick="saveRecord()" class="btn-save" id="saveBtn">
                <span id="saveBtnIcon">💾</span>
                <span id="saveBtnText">Guardar Historia</span>
            </button>
        </div>
    </div>
</div>

<!-- MODAL PARA VER DETALLES DE HISTORIA CLÍNICA -->
<div class="modal" id="recordDetailsModal">
    <div class="modal-content" style="max-width: 1200px;">
        <button class="modal-close" onclick="closeRecordDetailsModal()">✖</button>
        <div class="modal-header">
            <h2 class="modal-title" id="detailsModalTitle">
                <span>📄</span>
                <span id="detailsRecordTitle">Detalles de Historia Clínica</span>
            </h2>
            <p class="modal-subtitle" id="detailsModalSubtitle">Información completa del registro médico</p>
        </div>
        <div class="modal-body" id="recordDetailsContent">
            <!-- Se llenará dinámicamente -->
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeRecordDetailsModal()" class="btn-cancel">
                Cerrar
            </button>
            <button type="button" onclick="editRecordFromDetails()" class="btn-primary" id="editFromDetailsBtn">
                ✏️ Editar Registro
            </button>
            <button type="button" onclick="printRecord()" class="btn-secondary" id="printRecordBtn">
                🖨️ Imprimir
            </button>
            <button type="button" onclick="addPrescription()" class="btn-primary" id="addPrescriptionBtn">
                💊 Agregar Prescripción
            </button>
        </div>
    </div>
</div>

<!-- MODAL PARA AGREGAR PRESCRIPCIÓN -->
<div class="modal" id="prescriptionModal">
    <div class="modal-content" style="max-width: 800px;">
        <button class="modal-close" onclick="closePrescriptionModal()">✖</button>
        <div class="modal-header">
            <h2 class="modal-title">
                <span>💊</span>
                <span>Agregar Prescripción</span>
            </h2>
            <p class="modal-subtitle" id="prescriptionModalSubtitle">Agregar medicamento a la historia clínica</p>
        </div>
        <div class="modal-body">
            <form id="prescriptionForm">
                <input type="hidden" id="prescriptionRecordId">

                <div class="form-row">
                    <div class="form-group">
                        <label for="medicationId" class="form-label">Medicamento</label>
                        <select id="medicationId" name="medication_id" class="form-select" onchange="updateMedicationInfo()">
                            <option value="">Seleccionar medicamento</option>
                            <!-- Se llenará dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="medicationName" class="form-label">Nombre del Medicamento *</label>
                        <input type="text" id="medicationName" name="medication_name" class="form-input" required
                               placeholder="Nombre del medicamento">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dosage" class="form-label">Dosis</label>
                        <input type="text" id="dosage" name="dosage" class="form-input"
                               placeholder="Ej: 250mg, 2 comprimidos">
                    </div>
                    <div class="form-group">
                        <label for="frequency" class="form-label">Frecuencia</label>
                        <input type="text" id="frequency" name="frequency" class="form-input"
                               placeholder="Ej: Cada 8 horas, 2 veces al día">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="duration" class="form-label">Duración</label>
                        <input type="text" id="duration" name="duration" class="form-input"
                               placeholder="Ej: 7 días, 2 semanas">
                    </div>
                    <div class="form-group">
                        <label for="quantityPrescribed" class="form-label">Cantidad</label>
                        <input type="number" id="quantityPrescribed" name="quantity_prescribed" class="form-input"
                               min="1" placeholder="Cantidad a dispensar">
                    </div>
                </div>

                <div class="form-row full">
                    <div class="form-group">
                        <label for="prescriptionInstructions" class="form-label">Instrucciones</label>
                        <textarea id="prescriptionInstructions" name="instructions" class="form-textarea"
                                  placeholder="Instrucciones específicas para el propietario..."></textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closePrescriptionModal()" class="btn-cancel">
                Cancelar
            </button>
            <button type="button" onclick="savePrescription()" class="btn-save">
                💾 Agregar Prescripción
            </button>
        </div>
    </div>
</div>

<!-- MODAL DE CONFIRMACIÓN -->
<div class="modal" id="confirmModal">
    <div class="modal-content" style="max-width: 450px;">
        <button class="modal-close" onclick="closeConfirmModal()">✖</button>
        <div class="modal-header">
            <h2 class="modal-title" id="confirmTitle">
                <span id="confirmIcon">❓</span>
                Confirmar Acción
            </h2>
        </div>
        <div class="modal-body">
            <p id="confirmMessage">¿Estás seguro de realizar esta acción?</p>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeConfirmModal()" class="btn-cancel">
                Cancelar
            </button>
            <button type="button" onclick="executeConfirmAction()" class="btn-save" id="confirmBtn">
                <span id="confirmBtnText">Confirmar</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// =============== VARIABLES GLOBALES ===============
let allRecords = [];
let filteredRecords = [];
let allPets = [];
let allVeterinarians = [];
let allMedications = [];
let currentEditingRecord = null;
let currentViewingRecord = null;
let confirmAction = null;
let allOwners = [];

// Variables globales para medicamentos
let availableMedications = [];
let prescribedMedications = [];

// =============== INICIALIZACIÓN ===============
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Inicializando Gestión de Historias Clínicas...');
    loadInitialData();
});

// =============== FUNCIÓN PARA MOSTRAR MENSAJES ===============
function showMessage(message, type = 'info') {
    // Crear elemento de notificación
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;

    // Estilos del mensaje
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        padding: 15px 20px;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
    `;

    // Colores según el tipo
    switch(type) {
        case 'success':
            notification.style.background = 'linear-gradient(135deg, #52B788, #38A3A5)';
            notification.innerHTML = `✅ ${message}`;
            break;
        case 'error':
            notification.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
            notification.innerHTML = `❌ ${message}`;
            break;
        case 'warning':
            notification.style.background = 'linear-gradient(135deg, #ffc107, #e0a800)';
            notification.style.color = '#212529';
            notification.innerHTML = `⚠️ ${message}`;
            break;
        default:
            notification.style.background = 'linear-gradient(135deg, #17a2b8, #138496)';
            notification.innerHTML = `ℹ️ ${message}`;
    }

    // Agregar al DOM
    document.body.appendChild(notification);

    // Auto-eliminar después de 4 segundos
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 4000);

    // Permitir cerrar al hacer clic
    notification.addEventListener('click', () => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    });
}

// =============== AGREGAR ESTILOS CSS PARA ANIMACIONES ===============
const notificationStyles = document.createElement('style');
notificationStyles.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    .notification {
        cursor: pointer;
        transition: transform 0.2s ease;
    }

    .notification:hover {
        transform: translateX(-5px);
    }
`;
document.head.appendChild(notificationStyles);

// =============== FUNCIONES DE FORMATO DE FECHA ===============
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('es-CO');
    } catch {
        return 'N/A';
    }
}

function formatTime(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleTimeString('es-CO', {
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return 'N/A';
    }
}

function formatDateTime(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleString('es-CO');
    } catch {
        return 'N/A';
    }
}

// =============== CARGA DE DATOS INICIAL ===============
async function loadInitialData() {
    try {
        await Promise.all([
            loadOwnersData(),
            loadPetsData(),
            loadVeterinariansData(),
            loadMedicationsData(),
            loadAvailableMedications(), // ✅ AGREGAR CARGA DE MEDICAMENTOS PARA PRESCRIPCIONES
            loadRecordsData()
        ]);
        console.log('✅ Carga inicial completada');
    } catch (error) {
        console.error('❌ Error cargando datos iniciales:', error);
        showMessage('Error cargando datos del sistema', 'error');
    }
}

// =============== CARGA DE PROPIETARIOS ===============
async function loadOwnersData() {
    try {
        console.log('📡 Obteniendo propietarios del Auth Service...');

        const response = await fetch('/api/admin/users', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (data.success && data.users) {
            // Filtrar solo clientes activos
            allOwners = data.users.filter(user =>
                user.role === 'client' && user.is_active === true
            );
            populateOwnerSelects();
            console.log(`✅ ${allOwners.length} propietarios cargados`);
        } else {
            throw new Error('No se pudieron obtener los propietarios');
        }

    } catch (error) {
        console.error('❌ Error obteniendo propietarios:', error);
        showMessage('Error cargando propietarios. Verifique la conexión con el servidor.', 'error');

        // Solo inicializar selects vacíos sin datos de ejemplo
        allOwners = [];
        populateOwnerSelects();
    }
}

function populateOwnerSelects() {
    const ownerSelect = document.getElementById('ownerId');
    const ownerFilter = document.getElementById('ownerFilter');

    // Limpiar opciones existentes
    if (ownerSelect) {
        ownerSelect.innerHTML = '<option value="">Seleccionar propietario</option>';
    }
    if (ownerFilter) {
        ownerFilter.innerHTML = '<option value="">Todos los clientes</option>';
    }

    // Llenar opciones
    allOwners.forEach(owner => {
        const ownerName = `${owner.first_name} ${owner.last_name}`;

        // Para select de creación/edición de historia clínica
        if (ownerSelect) {
            const option1 = document.createElement('option');
            option1.value = owner.id;
            option1.textContent = ownerName;
            ownerSelect.appendChild(option1);
        }

        // Para filtro
        if (ownerFilter) {
            const option2 = document.createElement('option');
            option2.value = owner.id;
            option2.textContent = ownerName;
            ownerFilter.appendChild(option2);
        }
    });
}

// =============== FUNCIONES DE PROPIETARIO EN HISTORIA CLÍNICA ===============

// Función para filtrar mascotas por propietario seleccionado
function updateOwnerPets() {
    const ownerSelect = document.getElementById('ownerId');
    const petSelect = document.getElementById('petId');
    const selectedOwnerId = ownerSelect.value;

    // Limpiar selección de mascota
    petSelect.innerHTML = '<option value="">Seleccionar mascota</option>';

    if (selectedOwnerId) {
        // Filtrar mascotas del propietario seleccionado
        const ownerPets = allPets.filter(pet => pet.owner_id === selectedOwnerId);

        ownerPets.forEach(pet => {
            const option = document.createElement('option');
            option.value = pet.id;
            option.textContent = `${pet.name} (${pet.species})`;
            petSelect.appendChild(option);
        });

        if (ownerPets.length === 0) {
            petSelect.innerHTML = '<option value="">Este propietario no tiene mascotas registradas</option>';
        }
    } else {
        // Si no hay propietario seleccionado, mostrar todas las mascotas
        allPets.forEach(pet => {
            const option = document.createElement('option');
            option.value = pet.id;
            option.textContent = `${pet.name} (${pet.species}) - ${pet.owner_name}`;
            petSelect.appendChild(option);
        });
    }
}

// Función mejorada para actualizar info de mascota (incluye propietario)
function updatePetInfo() {
    const petSelect = document.getElementById('petId');
    const ownerSelect = document.getElementById('ownerId');

    if (petSelect.value) {
        const pet = allPets.find(p => p.id === petSelect.value);
        if (pet) {
            // Auto-seleccionar el propietario de la mascota
            if (ownerSelect && ownerSelect.value !== pet.owner_id) {
                ownerSelect.value = pet.owner_id;
            }

            // Actualizar peso si está disponible
            if (pet.weight) {
                const weightInput = document.getElementById('weightAtVisit');
                if (weightInput && !weightInput.value) {
                    weightInput.value = pet.weight;
                }
            }
        }
    }
}

// =============== CARGA DE MASCOTAS ===============
async function loadPetsData() {
    try {
        console.log('📡 Obteniendo mascotas del Medical Service...');

        const response = await fetch('/api/admin/pets', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success && data.pets) {
                allPets = data.pets;
                populatePetSelects();
                console.log(`✅ ${allPets.length} mascotas cargadas`);
                return;
            }
        }

        throw new Error('No se pudo conectar con Medical Service');

    } catch (error) {
        console.error('❌ Error obteniendo mascotas:', error);
        showMessage('Error cargando mascotas. Verifique la conexión con el servidor.', 'error');

        // Solo inicializar arrays vacíos sin datos de ejemplo
        allPets = [];
        populatePetSelects();
    }
}

function getExamplePets() {
    return [
        {
            id: '1',
            name: 'Max',
            species: 'perro',
            breed: 'Golden Retriever',
            owner_name: 'Carlos López',
            owner_id: '1'
        },
        {
            id: '2',
            name: 'Luna',
            species: 'gato',
            breed: 'Siamés',
            owner_name: 'María González',
            owner_id: '2'
        },
        {
            id: '3',
            name: 'Rocky',
            species: 'perro',
            breed: 'Bulldog Francés',
            owner_name: 'Carlos López',
            owner_id: '1'
        }
    ];
}

function populatePetSelects() {
    const petSelect = document.getElementById('petId');
    const petFilter = document.getElementById('petFilter');

    // Limpiar opciones existentes
    if (petSelect) {
        petSelect.innerHTML = '<option value="">Seleccionar mascota</option>';
    }
    if (petFilter) {
        petFilter.innerHTML = '<option value="">Todas las mascotas</option>';
    }

    // Llenar opciones
    allPets.forEach(pet => {
        const petInfo = `${pet.name} (${pet.species}) - ${pet.owner_name}`;

        // Para select de creación/edición de historia clínica
        if (petSelect) {
            const option1 = document.createElement('option');
            option1.value = pet.id;
            option1.textContent = petInfo;
            petSelect.appendChild(option1);
        }

        // Para filtro
        if (petFilter) {
            const option2 = document.createElement('option');
            option2.value = pet.id;
            option2.textContent = petInfo;
            petFilter.appendChild(option2);
        }
    });
}

// =============== CARGA DE VETERINARIOS ===============
async function loadVeterinariansData() {
    try {
        console.log('📡 Obteniendo veterinarios del Auth Service...');

        const response = await fetch('/api/admin/users', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success && data.users) {
                // Filtrar solo veterinarios activos
                allVeterinarians = data.users.filter(user =>
                    user.role === 'veterinarian' && user.is_active === true
                );
                populateVeterinarianSelects();
                console.log(`✅ ${allVeterinarians.length} veterinarios cargados`);
                return;
            }
        }

        throw new Error('No se pudo obtener veterinarios');

    } catch (error) {
        console.error('❌ Error obteniendo veterinarios:', error);
        showMessage('Error cargando veterinarios. Verifique la conexión con el servidor.', 'error');

        // Solo inicializar arrays vacíos sin datos de ejemplo
        allVeterinarians = [];
        populateVeterinarianSelects();
    }
}

function populateVeterinarianSelects() {
    const vetSelect = document.getElementById('veterinarianId');
    const vetFilter = document.getElementById('vetFilter');

    // Limpiar opciones existentes
    if (vetSelect) {
        vetSelect.innerHTML = '<option value="">Seleccionar veterinario</option>';
    }
    if (vetFilter) {
        vetFilter.innerHTML = '<option value="">Todos los veterinarios</option>';
    }

    // Llenar opciones
    allVeterinarians.forEach(vet => {
        const vetName = `${vet.first_name} ${vet.last_name}`;

        // Para select de creación/edición
        if (vetSelect) {
            const option1 = document.createElement('option');
            option1.value = vet.id;
            option1.textContent = vetName;
            vetSelect.appendChild(option1);
        }

        // Para filtro
        if (vetFilter) {
            const option2 = document.createElement('option');
            option2.value = vet.id;
            option2.textContent = vetName;
            vetFilter.appendChild(option2);
        }
    });
}

// =============== CARGA DE MEDICAMENTOS ===============
// =============== CARGA DE MEDICAMENTOS ===============
async function loadMedicationsData() {
    try {
        console.log('📡 Obteniendo medicamentos del Inventory Service...');

        const response = await fetch('/api/admin/inventory/medications', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success && data.medications) {
                allMedications = data.medications.filter(med =>
                    med.is_active !== false && med.stock_quantity > 0
                );

                availableMedications = [...allMedications];

                populateMedicationSelects();
                populateMedicationSelect();

                console.log(`✅ ${allMedications.length} medicamentos cargados desde la base de datos`);

                if (data.message && data.message.includes('ejemplo')) {
                    showMessage('⚠️ Servicio de inventario no disponible - usando datos de ejemplo', 'warning');
                }
                return;
            }
        }

        throw new Error('No se pudo conectar con Inventory Service');

    } catch (error) {
        console.error('❌ Error obteniendo medicamentos:', error);

        allMedications = [];
        availableMedications = [];
        populateMedicationSelects();
        populateMedicationSelect();

        showMessage('Error cargando medicamentos. Verifique la conexión con el servidor.', 'error');
    }
}

function populateMedicationSelects() {
    const medicationSelect = document.getElementById('medicationId');

    // Limpiar opciones existentes
    if (medicationSelect) {
        medicationSelect.innerHTML = '<option value="">Seleccionar medicamento</option>';

        // Llenar opciones
        allMedications.forEach(med => {
            const medInfo = `${med.name} ${med.concentration} - ${med.presentation} (Stock: ${med.stock_quantity})`;

            const option = document.createElement('option');
            option.value = med.id;
            option.textContent = medInfo;
            option.dataset.name = med.name;
            option.dataset.concentration = med.concentration;
            medicationSelect.appendChild(option);
        });
    }
}

// ✅ Poblar el select de medicamentos para prescripciones
function populateMedicationSelect() {
    const select = document.getElementById('medicationSelect');
    if (!select) return;

    select.innerHTML = '<option value="">-- Seleccionar medicamento --</option>';

    if (!availableMedications || availableMedications.length === 0) {
        select.innerHTML += '<option value="" disabled>No hay medicamentos disponibles</option>';
        return;
    }

    availableMedications.forEach(medication => {
        const option = document.createElement('option');
        option.value = medication.id;

        const displayText = `${medication.name} ${medication.concentration || ''} - ${medication.presentation || 'Sin presentación'} (Stock: ${medication.stock_quantity || 0})`;
        option.textContent = displayText.trim();

        option.dataset.medication = JSON.stringify({
            id: medication.id,
            name: medication.name,
            concentration: medication.concentration || '',
            presentation: medication.presentation || '',
            stock_quantity: medication.stock_quantity || 0,
            unit_price: medication.unit_price || 0,
            category: medication.category || 'Sin categoría',
            laboratory: medication.laboratory || ''
        });

        select.appendChild(option);
    });
}

function validateMedicationStock(medicationId, requestedQuantity) {
    const medication = availableMedications.find(med => med.id === medicationId);

    if (!medication) {
        return {
            valid: false,
            message: 'Medicamento no encontrado',
            available: 0
        };
    }

    const available = medication.stock_quantity || 0;

    if (requestedQuantity > available) {
        return {
            valid: false,
            message: `Stock insuficiente. Disponible: ${available}`,
            available: available
        };
    }

    return {
        valid: true,
        message: 'Stock suficiente',
        available: available
    };
}

// ✅ Función para crear un ID único de medicamento incluyendo todos los parámetros
function createMedicationUniqueId(medicationId, dosage, frequency, duration, instructions) {
    return `${medicationId}_${dosage}_${frequency}_${duration}_${instructions}`.toLowerCase().replace(/\s+/g, '_');
}

// ✅ Agregar medicamento seleccionado a la lista (LÓGICA CORREGIDA)
function addSelectedMedication() {
    const select = document.getElementById('medicationSelect');
    const quantityInput = document.getElementById('medicationQuantity');
    const dosageInput = document.getElementById('medicationDosage');
    const frequencyInput = document.getElementById('medicationFrequency');
    const durationInput = document.getElementById('medicationDuration');
    const instructionsInput = document.getElementById('medicationInstructions');

    // Validaciones básicas
    if (!select.value) {
        showMessage('Por favor selecciona un medicamento', 'error');
        return;
    }

    const quantity = parseInt(quantityInput.value) || 1;
    if (quantity <= 0) {
        showMessage('La cantidad debe ser mayor a 0', 'error');
        return;
    }

    const selectedOption = select.options[select.selectedIndex];
    const medication = JSON.parse(selectedOption.dataset.medication);

    // Verificar stock disponible
   const stockValidation = validateMedicationStock(medication.id, quantity);
    if (!stockValidation.valid) {
    showMessage(stockValidation.message, 'error');
    return;
    }

    // Obtener valores actuales del formulario
    const dosage = dosageInput.value.trim();
    const frequency = frequencyInput.value.trim();
    const duration = durationInput.value.trim();
    const instructions = instructionsInput.value.trim();

    // CORRECCIÓN: Crear ID único basado en medicamento + parámetros de prescripción
    const uniqueId = createMedicationUniqueId(medication.id, dosage, frequency, duration, instructions);

    // Verificar si ya existe esta combinación exacta (no solo el medicamento)
    const existingIndex = prescribedMedications.findIndex(med => {
        const existingId = createMedicationUniqueId(med.medication_id, med.dosage, med.frequency, med.duration, med.instructions);
        return existingId === uniqueId;
    });

    if (existingIndex !== -1) {
        showMessage('Esta combinación específica de medicamento ya fue agregada', 'warning');
        return;
    }

    // Crear prescripción
    const prescription = {
        medication_id: medication.id,
        medication_name: `${medication.name} ${medication.concentration}`,
        quantity: quantity,
        dosage: dosage,
        frequency: frequency,
        duration: duration,
        instructions: instructions,
        stock_available: medication.stock_quantity,
        unit_price: medication.unit_price,
        category: medication.category,
        unique_id: uniqueId // Agregar ID único para referencia
    };

    prescribedMedications.push(prescription);
    renderPrescribedMedications();
    updateHiddenFields();
    clearMedicationForm();

    showMessage(`Medicamento "${medication.name}" agregado correctamente`, 'success');
}

// ✅ CORRECCIÓN: Limpiar formulario de medicamentos completamente
function clearMedicationForm() {
    const fields = [
        'medicationSelect',
        'medicationQuantity',
        'medicationDosage',
        'medicationFrequency',
        'medicationDuration',
        'medicationInstructions'
    ];

    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = '';
        }
    });
}

// ✅ CORRECCIÓN: Limpiar completamente la lista al abrir formulario
function clearPrescriptionForm() {
    prescribedMedications = [];
    clearMedicationForm();
    renderPrescribedMedications();
    updateHiddenFields();
    console.log('✅ Formulario de prescripciones limpiado completamente');
}

// ✅ Renderizar lista de medicamentos prescritos (MEJORADO)
function renderPrescribedMedications() {
    const container = document.getElementById('medicationsContainer');

    if (!container) return;

    if (prescribedMedications.length === 0) {
        container.innerHTML = '<div id="noMedicationsMessage" style="padding: 20px; text-align: center; color: #6c757d; border: 2px dashed #dee2e6; border-radius: 8px;">No se han agregado medicamentos aún</div>';
        return;
    }

    const medicationsHTML = prescribedMedications.map((prescription, index) => {
        const stockWarning = prescription.quantity > prescription.stock_available * 0.8;
        const stockError = prescription.quantity > prescription.stock_available;

        return `
            <div class="medication-card" data-index="${index}" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                <div class="medication-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h5 class="medication-name" style="margin: 0; color: #2D6A4F; font-weight: 600;">${prescription.medication_name}</h5>
                    <span class="medication-stock" style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Stock: ${prescription.stock_available}</span>
                </div>

                <div class="medication-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 10px;">
                    <div class="medication-detail">
                        <strong>Cantidad:</strong> ${prescription.quantity}
                    </div>
                    ${prescription.dosage ? `<div class="medication-detail"><strong>Dosis:</strong> ${prescription.dosage}</div>` : ''}
                    ${prescription.frequency ? `<div class="medication-detail"><strong>Frecuencia:</strong> ${prescription.frequency}</div>` : ''}
                    ${prescription.duration ? `<div class="medication-detail"><strong>Duración:</strong> ${prescription.duration}</div>` : ''}
                </div>

                ${prescription.instructions ? `<div style="margin-bottom: 10px;"><strong>Instrucciones:</strong> ${prescription.instructions}</div>` : ''}

                ${stockWarning && !stockError ? `<div class="stock-warning" style="background: #fff3cd; color: #856404; padding: 8px; border-radius: 4px; margin-bottom: 10px;">⚠️ Cantidad solicitada alta para el stock disponible</div>` : ''}
                ${stockError ? `<div class="stock-error" style="background: #f8d7da; color: #721c24; padding: 8px; border-radius: 4px; margin-bottom: 10px;">❌ Cantidad solicitada excede el stock disponible</div>` : ''}

                <div class="medication-actions">
                    <button type="button" class="btn-remove" onclick="removePrescribedMedication(${index})" title="Eliminar medicamento" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                        🗑️ Eliminar
                    </button>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = medicationsHTML;
}

// ✅ CORRECCIÓN: Eliminar medicamento prescrito con reindexación
function removePrescribedMedication(index) {
    if (index >= 0 && index < prescribedMedications.length) {
        const removedMedication = prescribedMedications.splice(index, 1)[0];
        renderPrescribedMedications();
        updateHiddenFields();
        showMessage(`Medicamento "${removedMedication.medication_name}" eliminado`, 'info');
        console.log(`🗑️ Medicamento eliminado en índice ${index}:`, removedMedication);
    } else {
        console.error(`❌ Índice inválido para eliminar: ${index}`);
    }
}

// ✅ Actualizar campos ocultos para envío al backend
function updateHiddenFields() {
    const medicationsText = prescribedMedications.map(p =>
        `${p.medication_name} - Cantidad: ${p.quantity}${p.dosage ? `, Dosis: ${p.dosage}` : ''}${p.frequency ? `, Frecuencia: ${p.frequency}` : ''}${p.duration ? `, Duración: ${p.duration}` : ''}`
    ).join('\n');

    const medicationsPrescribedField = document.getElementById('medicationsPrescribed');
    const prescriptionsDataField = document.getElementById('prescriptionsData');

    if (medicationsPrescribedField) {
        medicationsPrescribedField.value = medicationsText;
    }

    if (prescriptionsDataField) {
        prescriptionsDataField.value = JSON.stringify(prescribedMedications);
    }

    console.log('💾 Campos ocultos actualizados:', {
        medicationsText,
        prescriptionsCount: prescribedMedications.length
    });
}

// =============== CARGA DE HISTORIAS CLÍNICAS ===============
async function loadRecordsData() {
    const container = document.getElementById('recordsTableContainer');
    const resultsInfo = document.getElementById('resultsInfo');

    try {
        console.log('📡 Intentando cargar historias clínicas desde backend...');

        // Mostrar estado de carga con diagnóstico
        if (container) {
            container.innerHTML = `
                <div class="table-loading">
                    <div class="spinner"></div>
                    <div style="margin-top: 15px;">
                        <div>🔄 Conectando con Medical Service...</div>
                        <div style="font-size: 0.8rem; color: #6c757d; margin-top: 5px;">
                            Si tarda más de 30 segundos, verifica la conexión con el servidor
                        </div>
                    </div>
                </div>
            `;
        }

        // ✅ TIMEOUT CONFIGURADO A 30 SEGUNDOS
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            controller.abort();
            console.log('⏰ Timeout: Petición cancelada después de 30 segundos');
        }, 30000);

        const response = await fetch('/api/admin/medical-records', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            signal: controller.signal // ✅ AGREGAR SIGNAL PARA TIMEOUT
        });

        clearTimeout(timeoutId); // Limpiar timeout si la petición termina

        if (response.ok) {
            console.log('✅ Respuesta recibida del servidor');

            // Actualizar mensaje de carga
            if (container) {
                container.innerHTML = `
                    <div class="table-loading">
                        <div class="spinner"></div>
                        <span>📊 Procesando datos de historias clínicas...</span>
                    </div>
                `;
            }

            const data = await response.json();

            if (data.success && data.medical_records) {
                allRecords = data.medical_records;
                filteredRecords = [...allRecords];
                displayRecordsData();
                updateStatistics();

                console.log(`✅ ${allRecords.length} historias clínicas cargadas desde backend`);
                showMessage(`${allRecords.length} historias clínicas cargadas exitosamente`, 'success');
                return;
            } else {
                throw new Error(data.message || 'No se encontraron historias clínicas');
            }
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

    } catch (error) {
        clearTimeout(timeoutId); // Asegurar limpieza del timeout

        if (error.name === 'AbortError') {
            console.error('⏰ Timeout: La carga de historias clínicas tardó demasiado');
            showMessage('La carga está tardando demasiado. Usando datos locales.', 'warning');
        } else {
            console.error('❌ Error cargando historias clínicas desde backend:', error);
            showMessage('Error conectando con el servidor. Usando datos de ejemplo.', 'warning');
        }

        // ✅ FALLBACK: USAR DATOS DE EJEMPLO
        console.log('🔄 Cargando datos de ejemplo...');
        allRecords = getExampleRecords();
        filteredRecords = [...allRecords];
        displayRecordsData();
        updateStatistics();

        if (resultsInfo) {
            resultsInfo.textContent = `Mostrando ${allRecords.length} registros de ejemplo (modo demo)`;
        }
    }
}

// ✅ FUNCIÓN DE DIAGNÓSTICO PARA VERIFICAR SERVICIOS
async function checkServicesStatus() {
    console.log('🔍 Verificando estado de servicios...');

    const services = [
        { name: 'Medical Service', endpoint: '/api/admin/pets' },
        { name: 'Auth Service', endpoint: '/api/admin/users' },
        { name: 'Inventory Service', endpoint: '/api/admin/inventory/medications' }
    ];

    for (const service of services) {
        try {
            const response = await fetch(service.endpoint, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                signal: AbortSignal.timeout(10000) // 10 segundos por servicio
            });

            if (response.ok) {
                console.log(`✅ ${service.name}: Conectado`);
            } else {
                console.log(`⚠️ ${service.name}: Error ${response.status}`);
            }
        } catch (error) {
            console.log(`❌ ${service.name}: No disponible (${error.message})`);
        }
    }

    return true;
}

// ✅ FUNCIÓN PARA CARGAR SOLO DATOS BÁSICOS (MÁS RÁPIDO)
async function loadRecordsLight() {
    try {
        console.log('⚡ Cargando versión ligera de historias clínicas...');

        // Intentar endpoint más simple si existe
        const response = await fetch('/api/admin/medical-records/summary', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            signal: AbortSignal.timeout(15000)
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                // Usar datos resumidos
                allRecords = data.records || [];
                filteredRecords = [...allRecords];
                displayRecordsData();
                updateStatistics();
                return true;
            }
        }

        return false;
    } catch (error) {
        console.log('⚠️ Endpoint ligero no disponible');
        return false;
    }
}

// ✅ FUNCIÓN MEJORADA DE INICIALIZACIÓN CON DIAGNÓSTICO
async function loadInitialData() {
    try {
        console.log('🚀 Inicializando Gestión de Historias Clínicas...');

        // PASO 1: Verificar servicios
        showMessage('Verificando conexión con servicios...', 'info');
        await checkServicesStatus();

        // PASO 2: Cargar datos básicos primero
        showMessage('Cargando datos básicos...', 'info');

        const basicPromises = [
            loadOwnersData().catch(e => console.log('⚠️ Owners failed:', e.message)),
            loadPetsData().catch(e => console.log('⚠️ Pets failed:', e.message)),
            loadVeterinariansData().catch(e => console.log('⚠️ Vets failed:', e.message)),
            loadMedicationsData().catch(e => console.log('⚠️ Medications failed:', e.message))
        ];

        await Promise.allSettled(basicPromises);
        console.log('✅ Datos básicos cargados');

        // PASO 3: Intentar cargar historias clínicas (lo más lento)
        showMessage('Cargando historias clínicas...', 'info');

        // Intentar versión ligera primero
        const lightLoaded = await loadRecordsLight();

        if (!lightLoaded) {
            // Si falla, usar versión completa
            await loadRecordsData();
        }

        console.log('✅ Carga inicial completada');

    } catch (error) {
        console.error('❌ Error cargando datos iniciales:', error);
        showMessage('Error cargando datos del sistema', 'error');

        // Fallback completo
        allRecords = getExampleRecords();
        filteredRecords = [...allRecords];
        displayRecordsData();
        updateStatistics();
    }
}

// ✅ FUNCIÓN PARA MOSTRAR INFORMACIÓN DE DEBUG EN TIEMPO REAL
function showLoadingProgress(step, message) {
    const container = document.getElementById('recordsTableContainer');
    if (container) {
        container.innerHTML = `
            <div class="table-loading">
                <div class="spinner"></div>
                <div style="margin-top: 15px;">
                    <div><strong>Paso ${step}:</strong> ${message}</div>
                    <div style="font-size: 0.8rem; color: #6c757d; margin-top: 5px;">
                        Tiempo transcurrido: <span id="loadingTimer">0</span>s
                    </div>
                </div>
            </div>
        `;

        // Iniciar timer
        let seconds = 0;
        const timer = setInterval(() => {
            seconds++;
            const timerElement = document.getElementById('loadingTimer');
            if (timerElement) {
                timerElement.textContent = seconds;

                // Cambiar color si tarda demasiado
                if (seconds > 20) {
                    timerElement.style.color = '#dc3545';
                    timerElement.parentElement.innerHTML += '<br><strong style="color: #dc3545;">⚠️ La carga está tardando más de lo normal</strong>';
                }
            } else {
                clearInterval(timer);
            }
        }, 1000);

        // Guardar referencia del timer para limpiarlo después
        window.currentLoadingTimer = timer;
    }
}

// ✅ FUNCIÓN PARA LIMPIAR TIMER DE CARGA
function clearLoadingTimer() {
    if (window.currentLoadingTimer) {
        clearInterval(window.currentLoadingTimer);
        window.currentLoadingTimer = null;
    }
}


// =============== FUNCIONES DE UTILIDAD PARA MOSTRAR MENSAJES ===============
function showLoadingMessage(message) {
    const container = document.getElementById('recordsTableContainer');
    if (container) {
        container.innerHTML = `
            <div class="table-loading">
                <div class="spinner"></div>
                <span>${message}</span>
            </div>
        `;
    }
}

// =============== ACTUALIZACIÓN DE ESTADÍSTICAS ===============
function updateStatistics() {
    const totalRecords = allRecords.length;
    const today = new Date().toDateString();
    const recordsToday = allRecords.filter(r =>
        new Date(r.created_at).toDateString() === today
    ).length;
    const emergencyRecords = allRecords.filter(r => r.is_emergency).length;
    const completedRecords = allRecords.filter(r => r.status === 'completed').length;

    const totalElement = document.getElementById('recordsTotal');
    const todayElement = document.getElementById('recordsToday');
    const emergencyElement = document.getElementById('emergencyRecords');
    const completedElement = document.getElementById('completedRecords');

    if (totalElement) totalElement.textContent = totalRecords;
    if (todayElement) todayElement.textContent = recordsToday;
    if (emergencyElement) emergencyElement.textContent = emergencyRecords;
    if (completedElement) completedElement.textContent = completedRecords;
}

// =============== FUNCIONES DE UTILIDAD ===============
function getStatusBadge(status) {
    const badges = {
        'draft': '<span class="status-badge draft">📝 Borrador</span>',
        'completed': '<span class="status-badge completed">✅ Completada</span>',
        'reviewed': '<span class="status-badge reviewed">👁️ Revisada</span>'
    };
    return badges[status] || '<span class="status-badge draft">❓ Desconocido</span>';
}

function getStatusText(status) {
    const texts = {
        'draft': 'Borrador',
        'completed': 'Completada',
        'reviewed': 'Revisada'
    };
    return texts[status] || 'Desconocido';
}

function getPriorityBadge(isEmergency) {
    return isEmergency ?
        '<span class="priority-badge emergency">🚨 EMERGENCIA</span>' :
        '<span class="priority-badge normal">🟢 Normal</span>';
}

function getSpeciesLabel(species) {
    const labels = {
        'perro': '🐕 Perro',
        'gato': '🐱 Gato',
        'ave': '🦜 Ave',
        'conejo': '🐰 Conejo',
        'hamster': '🐹 Hámster',
        'otro': '🐾 Otro'
    };
    return labels[species] || '🐾 Desconocido';
}

// =============== MOSTRAR DATOS EN TABLA ===============
function displayRecordsData() {
    const container = document.getElementById('recordsTableContainer');
    const resultsInfo = document.getElementById('resultsInfo');

    if (!container) return;

    // Actualizar información de resultados
    if (resultsInfo) {
        resultsInfo.textContent = `Mostrando ${filteredRecords.length} de ${allRecords.length} historias clínicas`;
    }

    if (filteredRecords.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <h3>📄 No se encontraron historias clínicas</h3>
                <p>No hay historias clínicas que coincidan con los filtros aplicados.</p>
                <button onclick="resetFilters()" class="btn-primary">
                    🔄 Limpiar Filtros
                </button>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <table class="records-table">
            <thead>
                <tr>
                    <th>Fecha/Hora</th>
                    <th>Mascota</th>
                    <th>Propietario</th>
                    <th>Veterinario</th>
                    <th>Diagnóstico</th>
                    <th>Estado</th>
                    <th>Prioridad</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                ${filteredRecords.map(record => `
                    <tr>
                        <td>
                            <div class="record-info">
                                <div class="record-avatar">📄</div>
                                <div class="record-details">
                                    <div class="record-date">${formatDate(record.created_at)}</div>
                                    <div class="record-time">${formatTime(record.created_at)}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="pet-info">
                                <div class="pet-name">${record.pet_name || 'Sin nombre'}</div>
                                <div class="pet-species">${getSpeciesLabel(record.pet_species)} ${record.weight_at_visit ? `• ${record.weight_at_visit}kg` : ''}</div>
                            </div>
                        </td>
                        <td>
                            <div class="owner-info">
                                <div class="owner-name">${record.owner_name || 'Propietario desconocido'}</div>
                            </div>
                        </td>
                        <td>
                            <div class="vet-info">
                                <div class="vet-name">${record.veterinarian_name || 'Veterinario desconocido'}</div>
                                <div class="vet-specialty">Medicina Veterinaria</div>
                            </div>
                        </td>
                        <td style="max-width: 200px;">
                            <div style="color: #2D6A4F; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${record.diagnosis || 'Pendiente de diagnóstico'}
                            </div>
                            ${record.symptoms_description ? `<div style="color: #52B788; font-size: 0.85rem; margin-top: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${record.symptoms_description}</div>` : ''}
                        </td>
                        <td style="text-align: center;">
                            ${getStatusBadge(record.status)}
                        </td>
                        <td style="text-align: center;">
                            ${getPriorityBadge(record.is_emergency)}
                        </td>
                        <td>
                            <div class="actions-group">
                                <button onclick="viewRecord('${record.id}')" class="action-btn view" title="Ver detalles">
                                    👁️ Ver
                                </button>
                                <button onclick="editRecord('${record.id}')" class="action-btn edit" title="Editar">
                                    ✏️ Editar
                                </button>
                                ${record.status !== 'completed' ? `
                                    <button onclick="completeRecord('${record.id}')" class="action-btn complete" title="Marcar como completada">
                                        ✅ Completar
                                    </button>
                                ` : ''}
                                <button onclick="printRecord('${record.id}')" class="action-btn print" title="Imprimir">
                                    🖨️ Imprimir
                                </button>
                                <button onclick="deleteRecord('${record.id}')" class="action-btn delete" title="Eliminar">
                                    🗑️ Eliminar
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// =============== FILTROS Y BÚSQUEDA ===============
function filterRecords() {
    const searchTerm = document.getElementById('searchInput')?.value?.toLowerCase() || '';
    const ownerFilter = document.getElementById('ownerFilter')?.value || '';
    const petFilter = document.getElementById('petFilter')?.value || '';
    const vetFilter = document.getElementById('vetFilter')?.value || '';
    const statusFilter = document.getElementById('statusFilter')?.value || '';

    filteredRecords = allRecords.filter(record => {
        // Filtro de búsqueda
        const matchesSearch = !searchTerm ||
            (record.pet_name && record.pet_name.toLowerCase().includes(searchTerm)) ||
            (record.owner_name && record.owner_name.toLowerCase().includes(searchTerm)) ||
            (record.veterinarian_name && record.veterinarian_name.toLowerCase().includes(searchTerm)) ||
            (record.diagnosis && record.diagnosis.toLowerCase().includes(searchTerm)) ||
            (record.symptoms_description && record.symptoms_description.toLowerCase().includes(searchTerm));

        // Filtro de propietario
        const matchesOwner = !ownerFilter || record.owner_id === ownerFilter;

        // Filtro de mascota
        const matchesPet = !petFilter || record.pet_id === petFilter;

        // Filtro de veterinario
        const matchesVet = !vetFilter || record.veterinarian_id === vetFilter;

        // Filtro de estado
        const matchesStatus = !statusFilter || record.status === statusFilter;

        return matchesSearch && matchesOwner && matchesPet && matchesVet && matchesStatus;
    });

    displayRecordsData();
}

function sortRecords() {
    const sortBy = document.getElementById('sortBy')?.value || 'created_at_desc';

    filteredRecords.sort((a, b) => {
        switch (sortBy) {
            case 'created_at':
                return new Date(a.created_at) - new Date(b.created_at);
            case 'created_at_desc':
                return new Date(b.created_at) - new Date(a.created_at);
            case 'pet_name':
                return (a.pet_name || '').localeCompare(b.pet_name || '');
            case 'owner_name':
                return (a.owner_name || '').localeCompare(b.owner_name || '');
            case 'veterinarian':
                return (a.veterinarian_name || '').localeCompare(b.veterinarian_name || '');
            case 'status':
                return (a.status || '').localeCompare(b.status || '');
            default:
                return 0;
        }
    });

    displayRecordsData();
}

function resetFilters() {
    const elements = {
        searchInput: document.getElementById('searchInput'),
        ownerFilter: document.getElementById('ownerFilter'),
        petFilter: document.getElementById('petFilter'),
        vetFilter: document.getElementById('vetFilter'),
        statusFilter: document.getElementById('statusFilter'),
        sortBy: document.getElementById('sortBy')
    };

    if (elements.searchInput) elements.searchInput.value = '';
    if (elements.ownerFilter) elements.ownerFilter.value = '';
    if (elements.petFilter) elements.petFilter.value = '';
    if (elements.vetFilter) elements.vetFilter.value = '';
    if (elements.statusFilter) elements.statusFilter.value = '';
    if (elements.sortBy) elements.sortBy.value = 'created_at_desc';

    filteredRecords = [...allRecords];
    displayRecordsData();
    showMessage('Filtros restablecidos', 'info');
}

// =============== MODAL DE HISTORIA CLÍNICA ===============
function openRecordModal(recordId = null) {
    console.log('🔄 Abriendo modal de historia clínica...', recordId);

    const modal = document.getElementById('recordModal');
    const form = document.getElementById('recordForm');

    if (!modal) {
        console.error('❌ Modal no encontrado');
        showMessage('Error: Modal no encontrado en la página', 'error');
        return;
    }

    if (!form) {
        console.error('❌ Formulario no encontrado');
        showMessage('Error: Formulario no encontrado en la página', 'error');
        return;
    }

    // Reset form
    form.reset();
    const recordIdInput = document.getElementById('recordId');
    if (recordIdInput) {
        recordIdInput.value = '';
    }
    currentEditingRecord = null;

    // ✅ Limpiar prescripciones al abrir modal
    clearPrescriptionForm();

    if (recordId) {
        // Modo edición
        const record = allRecords.find(r => r.id === recordId);
        if (!record) {
            showMessage('Historia clínica no encontrada', 'error');
            return;
        }

        currentEditingRecord = record;
        fillEditForm(record);
    } else {
        // Modo creación
        fillCreateForm();
    }

    // Mostrar modal
    modal.classList.add('active');
    console.log('✅ Modal abierto exitosamente');
}

function fillEditForm(record) {
    console.log('📝 Llenando formulario para edición:', record);

    // Llenar campos básicos
    setFieldValue('petId', record.pet_id);
    setFieldValue('ownerId', record.owner_id);
    setFieldValue('veterinarianId', record.veterinarian_id);
    setFieldValue('appointmentId', record.appointment_id);
    setFieldValue('isEmergency', record.is_emergency ? 'true' : 'false');
    setFieldValue('weightAtVisit', record.weight_at_visit);
    setFieldValue('temperature', record.temperature);
    setFieldValue('pulse', record.pulse);
    setFieldValue('respiratoryRate', record.respiratory_rate);
    setFieldValue('recordStatus', record.status || 'draft');
    setFieldValue('symptomsDescription', record.symptoms_description);
    setFieldValue('physicalExamination', record.physical_examination);
    setFieldValue('diagnosis', record.diagnosis);
    setFieldValue('treatment', record.treatment);
    setFieldValue('medicationsPrescribed', record.medications_prescribed);
    setFieldValue('examsRequested', record.exams_requested);
    setFieldValue('observations', record.observations);
    setFieldValue('nextAppointment', record.next_appointment_recommendation);
    setFieldValue('recordId', record.id);

    // ✅ Actualizar mascotas según propietario seleccionado
    if (record.owner_id) {
        updateOwnerPets();
    }

    // Actualizar UI del modal
    setModalTitle('✏️', 'Editar Historia Clínica', `Modificando registro de: ${record.pet_name}`, '💾', 'Actualizar Historia');
}

function fillCreateForm() {
    console.log('📝 Configurando formulario para creación');
    setModalTitle('📄', 'Nueva Historia Clínica', 'Completa la información de la consulta médica', '💾', 'Crear Historia');
}

function setFieldValue(fieldId, value) {
    const field = document.getElementById(fieldId);
    if (field && value !== null && value !== undefined) {
        field.value = value;
    }
}

function setModalTitle(icon, title, subtitle, btnIcon, btnText) {
    const elements = {
        modalIcon: document.getElementById('modalIcon'),
        modalTitleText: document.getElementById('modalTitleText'),
        modalSubtitle: document.getElementById('modalSubtitle'),
        saveBtnIcon: document.getElementById('saveBtnIcon'),
        saveBtnText: document.getElementById('saveBtnText')
    };

    if (elements.modalIcon) elements.modalIcon.textContent = icon;
    if (elements.modalTitleText) elements.modalTitleText.textContent = title;
    if (elements.modalSubtitle) elements.modalSubtitle.textContent = subtitle;
    if (elements.saveBtnIcon) elements.saveBtnIcon.textContent = btnIcon;
    if (elements.saveBtnText) elements.saveBtnText.textContent = btnText;
}

function closeRecordModal() {
    console.log('🔄 Cerrando modal de historia clínica...');

    const modal = document.getElementById('recordModal');
    if (modal) {
        modal.classList.remove('active');
        currentEditingRecord = null;
        console.log('✅ Modal cerrado exitosamente');
    }
}

// =============== FUNCIÓN DE VALIDACIÓN DE APPOINTMENT_ID ===============
function validateAppointmentId(appointmentId) {
    if (!appointmentId || appointmentId.trim() === '') {
        return { valid: true, value: null }; // Vacío es válido (NULL)
    }

    // Patrón UUID
    const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;

    if (uuidPattern.test(appointmentId.trim())) {
        return { valid: true, value: appointmentId.trim() };
    } else {
        return { valid: false, value: null };
    }
}

// =============== GUARDAR HISTORIA CLÍNICA ===============
async function saveRecord() {
    const form = document.getElementById('recordForm');
    const saveBtn = document.getElementById('saveBtn');

    if (!form) {
        showMessage('Error: Formulario no encontrado', 'error');
        return;
    }

    if (!saveBtn) {
        showMessage('Error: Botón de guardar no encontrado', 'error');
        return;
    }

    // Validar formulario
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Validar que la mascota y veterinario estén seleccionados
    const petId = document.getElementById('petId')?.value;
    const ownerId = document.getElementById('ownerId')?.value;
    const veterinarianId = document.getElementById('veterinarianId')?.value;

    if (!petId) {
        showMessage('Debe seleccionar una mascota', 'error');
        return;
    }

    if (!ownerId) {
        showMessage('Debe seleccionar un propietario', 'error');
        return;
    }

    if (!veterinarianId) {
        showMessage('Debe seleccionar un veterinario', 'error');
        return;
    }

    // ✅ VALIDAR APPOINTMENT_ID CON SISTEMA UUID
    const appointmentIdRaw = document.getElementById('appointmentId')?.value;
    const appointmentValidation = validateAppointmentId(appointmentIdRaw);

    if (!appointmentValidation.valid) {
        showMessage('ID de cita debe ser un UUID válido o estar vacío', 'error');
        return;
    }

    // Recopilar datos de la historia clínica
    const recordData = {
        pet_id: petId,
        owner_id: ownerId,
        veterinarian_id: veterinarianId,
        appointment_id: appointmentValidation.value, // ✅ Usar valor validado
        symptoms_description: document.getElementById('symptomsDescription')?.value || null,
        physical_examination: document.getElementById('physicalExamination')?.value || null,
        diagnosis: document.getElementById('diagnosis')?.value || null,
        treatment: document.getElementById('treatment')?.value || null,
        medications_prescribed: document.getElementById('medicationsPrescribed')?.value || null,
        exams_requested: document.getElementById('examsRequested')?.value || null,
        observations: document.getElementById('observations')?.value || null,
        next_appointment_recommendation: document.getElementById('nextAppointment')?.value || null,
        weight_at_visit: parseFloat(document.getElementById('weightAtVisit')?.value) || null,
        temperature: parseFloat(document.getElementById('temperature')?.value) || null,
        pulse: parseInt(document.getElementById('pulse')?.value) || null,
        respiratory_rate: parseInt(document.getElementById('respiratoryRate')?.value) || null,
        is_emergency: document.getElementById('isEmergency')?.value === 'true',
        status: document.getElementById('recordStatus')?.value || 'draft'
    };

    console.log('📡 Datos a enviar:', recordData);

    // ========== AGREGAR PRESCRIPCIONES SI EXISTEN ==========
    const prescriptionsDataElement = document.getElementById('prescriptionsData');
    if (prescriptionsDataElement && prescriptionsDataElement.value && prescriptionsDataElement.value !== '[]') {
        try {
            recordData.prescriptions = JSON.parse(prescriptionsDataElement.value);
            console.log(`💊 Agregando ${recordData.prescriptions.length} prescripciones a la historia clínica`);
        } catch (error) {
            console.error('❌ Error parseando prescripciones:', error);
            showMessage('Error en los datos de prescripciones', 'error');
            return;
        }
    }

    // Deshabilitar botón
    saveBtn.disabled = true;
    const saveBtnText = document.getElementById('saveBtnText');
    if (saveBtnText) {
        saveBtnText.textContent = 'Guardando...';
    }

    try {
        let response;
        let endpoint = '/api/admin/medical-records';
        let method = 'POST';

        if (currentEditingRecord) {
            // Actualizar historia clínica existente
            endpoint = `/api/admin/medical-records/${currentEditingRecord.id}`;
            method = 'PUT';
        }

        // Llamada al backend
        response = await fetch(endpoint, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(recordData)
        });

        const responseData = await response.json();

        if (response.ok && responseData.success) {
            showMessage(
                currentEditingRecord ? 'Historia clínica actualizada exitosamente' : 'Historia clínica creada exitosamente',
                'success'
            );

            closeRecordModal();
            // Recargar datos
            await loadRecordsData();

        } else {
            showMessage(responseData.message || 'Error al guardar historia clínica', 'error');
        }

    } catch (error) {
        console.error('❌ Error guardando historia clínica:', error);

        // ========== FALLBACK: USAR DATOS LOCALES ==========
        console.log('🔄 Fallback: Guardando localmente...');

        if (currentEditingRecord) {
            // Actualizar registro existente
            const updatedRecord = { ...currentEditingRecord, ...recordData };

            // Agregar información de mascota y veterinario
            const pet = allPets.find(p => p.id === recordData.pet_id);
            const vet = allVeterinarians.find(v => v.id === recordData.veterinarian_id);
            const owner = allOwners.find(o => o.id === recordData.owner_id);

            updatedRecord.pet_name = pet?.name || 'Mascota desconocida';
            updatedRecord.pet_species = pet?.species || 'especie';
            updatedRecord.owner_name = owner ? `${owner.first_name} ${owner.last_name}` : 'Propietario desconocido';
            updatedRecord.veterinarian_name = vet ? `${vet.first_name} ${vet.last_name}` : 'Veterinario desconocido';
            updatedRecord.updated_at = new Date().toISOString();

            // Actualizar en datos locales
            const index = allRecords.findIndex(r => r.id === currentEditingRecord.id);
            if (index !== -1) {
                allRecords[index] = updatedRecord;
                filteredRecords = [...allRecords];
                displayRecordsData();
                updateStatistics();
            }

            showMessage('Historia clínica actualizada localmente (modo demo)', 'warning');

        } else {
            // Crear nuevo registro
            const newRecord = {
                id: `record_${Date.now()}`,
                ...recordData,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            // Agregar información de mascota, propietario y veterinario
            const pet = allPets.find(p => p.id === recordData.pet_id);
            const vet = allVeterinarians.find(v => v.id === recordData.veterinarian_id);
            const owner = allOwners.find(o => o.id === recordData.owner_id);

            newRecord.pet_name = pet?.name || 'Mascota desconocida';
            newRecord.pet_species = pet?.species || 'especie';
            newRecord.owner_name = owner ? `${owner.first_name} ${owner.last_name}` : 'Propietario desconocido';
            newRecord.veterinarian_name = vet ? `${vet.first_name} ${vet.last_name}` : 'Veterinario desconocido';

            // Agregar a datos locales
            allRecords.unshift(newRecord);
            filteredRecords = [...allRecords];
            displayRecordsData();
            updateStatistics();

            showMessage('Historia clínica creada localmente (modo demo)', 'warning');
        }

        closeRecordModal();

    } finally {
        // Rehabilitar botón
        saveBtn.disabled = false;
        if (saveBtnText) {
            saveBtnText.textContent = currentEditingRecord ? 'Actualizar Historia' : 'Crear Historia';
        }
    }
}

// =============== FUNCIONES BÁSICAS DE ACCIÓN ===============
function viewRecord(recordId) {
    console.log('👁️ Ver registro:', recordId);
    showMessage('Función de ver detalles - próximamente disponible', 'info');
}

function editRecord(recordId) {
    console.log('✏️ Editar registro:', recordId);
    openRecordModal(recordId);
}

function deleteRecord(recordId) {
    console.log('🗑️ Eliminar registro:', recordId);
    showMessage('Función de eliminar - próximamente disponible', 'info');
}

function completeRecord(recordId) {
    console.log('✅ Completar registro:', recordId);
    showMessage('Función de completar - próximamente disponible', 'info');
}

function printRecord(recordId) {
    console.log('🖨️ Imprimir registro:', recordId);
    showMessage('Función de imprimir - próximamente disponible', 'info');
}

function exportRecords(format) {
    console.log('📄 Exportar registros:', format);
    showMessage(`Función de exportar ${format} - próximamente disponible`, 'info');
}

// =============== FUNCIONES PARA MEDICAMENTOS TRADICIONALES ===============

// ✅ Función para el select tradicional de medicamentos (para prescripciones simples)
function updateMedicationInfo() {
    const select = document.getElementById('medicationId');
    const nameInput = document.getElementById('medicationName');

    if (select && select.value) {
        const selectedOption = select.options[select.selectedIndex];
        if (nameInput && selectedOption.dataset.name && selectedOption.dataset.concentration) {
            nameInput.value = selectedOption.dataset.name + ' ' + selectedOption.dataset.concentration;
        }
    }
}

// =============== CONFIGURACIÓN DE EVENT LISTENERS ===============
function setupEventListeners() {
    // Listener para cambios en la selección de propietarios
    const ownerSelect = document.getElementById('ownerId');
    if (ownerSelect) {
        ownerSelect.addEventListener('change', updateOwnerPets);
    }

    // Listener para cambios en la selección de mascotas
    const petSelect = document.getElementById('petId');
    if (petSelect) {
        petSelect.addEventListener('change', updatePetInfo);
    }

    // Listener para cambios en la selección de medicamentos (tradicional)
    const medicationSelect = document.getElementById('medicationId');
    if (medicationSelect) {
        medicationSelect.addEventListener('change', updateMedicationInfo);
    }

    // Listeners para filtros
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(filterRecords, 300));
    }

    console.log('✅ Event listeners configurados');
}

// =============== FUNCIÓN DE DEBOUNCE PARA BÚSQUEDA ===============
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// =============== INICIALIZACIÓN MEJORADA ===============
// Agregar configuración de event listeners después de que el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Inicializando Gestión de Historias Clínicas...');

    // Configurar event listeners
    setTimeout(() => {
        setupEventListeners();
    }, 500); // Esperar un poco para que los elementos estén disponibles

    // Cargar datos iniciales
    loadInitialData();

    // Inicializar formulario de prescripciones limpio
    setTimeout(() => {
        clearPrescriptionForm();
    }, 1000);

    // Mensaje de bienvenida
    showMessage('Sistema de Historias Clínicas cargado', 'info');
});

// =============== FUNCIONES GLOBALES PARA USO EN HTML ===============

// ✅ FUNCIONES BÁSICAS DE GESTIÓN
window.openRecordModal = openRecordModal;
window.closeRecordModal = closeRecordModal;
window.saveRecord = saveRecord;
window.viewRecord = viewRecord;
window.editRecord = editRecord;
window.deleteRecord = deleteRecord;
window.completeRecord = completeRecord;
window.printRecord = printRecord;
window.exportRecords = exportRecords;

// ✅ FUNCIONES DE FILTROS Y BÚSQUEDA
window.filterRecords = filterRecords;
window.sortRecords = sortRecords;
window.resetFilters = resetFilters;

// ✅ FUNCIONES DE PROPIETARIOS Y MASCOTAS
window.updatePetInfo = updatePetInfo;
window.updateOwnerPets = updateOwnerPets;

// ✅ FUNCIONES DE MEDICAMENTOS TRADICIONALES
window.updateMedicationInfo = updateMedicationInfo;

// ✅ FUNCIONES DE MEDICAMENTOS PARA PRESCRIPCIONES
window.addSelectedMedication = addSelectedMedication;
window.removePrescribedMedication = removePrescribedMedication;
window.clearPrescriptionForm = clearPrescriptionForm;
window.clearMedicationForm = clearMedicationForm;
window.renderPrescribedMedications = renderPrescribedMedications;
window.updateHiddenFields = updateHiddenFields;
window.createMedicationUniqueId = createMedicationUniqueId;

// ✅ FUNCIONES DE CARGA DE DATOS
window.loadAvailableMedications = loadAvailableMedications;
window.populateMedicationSelect = populateMedicationSelect;

// ✅ FUNCIONES DE VALIDACIÓN
window.validateAppointmentId = validateAppointmentId;

window.checkServicesStatus = checkServicesStatus;
window.loadRecordsLight = loadRecordsLight;
window.debugLoadRecords = loadRecordsData;

console.log('✅ Gestión de Historias Clínicas - JavaScript integrado cargado completamente');
console.log('🔧 Funciones disponibles:', {
    propietarios: 'updateOwnerPets, populateOwnerSelects',
    medicamentos_tradicionales: 'updateMedicationInfo, populateMedicationSelects',
    medicamentos_prescripciones: 'addSelectedMedication, removePrescribedMedication, clearPrescriptionForm',
    modales: 'openRecordModal, closeRecordModal, saveRecord',
    filtros: 'filterRecords, sortRecords, resetFilters'
});
    </script>
{% endblock %}